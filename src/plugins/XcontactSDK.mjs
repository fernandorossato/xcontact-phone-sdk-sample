/* eslint-disable */
var domain;function EventHandlers(){}function EventEmitter(){EventEmitter.init.call(this)}function $getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function emitNone(e,t,r){if(t)e.call(r);else for(var s=e.length,i=arrayClone(e,s),n=0;n<s;++n)i[n].call(r)}function emitOne(e,t,r,s){if(t)e.call(r,s);else for(var i=e.length,n=arrayClone(e,i),o=0;o<i;++o)n[o].call(r,s)}function emitTwo(e,t,r,s,i){if(t)e.call(r,s,i);else for(var n=e.length,o=arrayClone(e,n),a=0;a<n;++a)o[a].call(r,s,i)}function emitThree(e,t,r,s,i,n){if(t)e.call(r,s,i,n);else for(var o=e.length,a=arrayClone(e,o),c=0;c<o;++c)a[c].call(r,s,i,n)}function emitMany(e,t,r,s){if(t)e.apply(r,s);else for(var i=e.length,n=arrayClone(e,i),o=0;o<i;++o)n[o].apply(r,s)}function _addListener(e,t,r,s){var i,n,o;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((n=e._events)?(n.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),n=e._events),o=n[t]):(n=e._events=new EventHandlers,e._eventsCount=0),o){if("function"==typeof o?o=n[t]=s?[r,o]:[o,r]:s?o.unshift(r):o.push(r),!o.warned&&(i=$getMaxListeners(e))&&i>0&&o.length>i){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,emitWarning(a)}}else o=n[t]=r,++e._eventsCount;return e}function emitWarning(e){"function"==typeof console.warn?console.warn(e):console.log(e)}function _onceWrap(e,t,r){var s=!1;function i(){e.removeListener(t,i),s||(s=!0,r.apply(e,arguments))}return i.listener=r,i}function listenerCount(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function spliceOne(e,t){for(var r=t,s=r+1,i=e.length;s<i;r+=1,s+=1)e[r]=e[s];e.pop()}function arrayClone(e,t){for(var r=new Array(t);t--;)r[t]=e[t];return r}function unwrapListeners(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}EventHandlers.prototype=Object.create(null),EventEmitter.EventEmitter=EventEmitter,EventEmitter.usingDomains=!1,EventEmitter.prototype.domain=void 0,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.init=function(){this.domain=null,EventEmitter.usingDomains&&domain.active&&domain.Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new EventHandlers,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)},EventEmitter.prototype.emit=function(e){var t,r,s,i,n,o,a,c="error"===e;if(o=this._events)c=c&&null==o.error;else if(!c)return!1;if(a=this.domain,c){if(t=arguments[1],!a){if(t instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(r=o[e]))return!1;var d="function"==typeof r;switch(s=arguments.length){case 1:emitNone(r,d,this);break;case 2:emitOne(r,d,this,arguments[1]);break;case 3:emitTwo(r,d,this,arguments[1],arguments[2]);break;case 4:emitThree(r,d,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(s-1),n=1;n<s;n++)i[n-1]=arguments[n];emitMany(r,d,this,i)}return!0},EventEmitter.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.removeListener=function(e,t){var r,s,i,n,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(s=this._events))return this;if(!(r=s[e]))return this;if(r===t||r.listener&&r.listener===t)0==--this._eventsCount?this._events=new EventHandlers:(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,n=r.length;n-- >0;)if(r[n]===t||r[n].listener&&r[n].listener===t){o=r[n].listener,i=n;break}if(i<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new EventHandlers,this;delete s[e]}else spliceOne(r,i);s.removeListener&&this.emit("removeListener",e,o||t)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new EventHandlers,this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=new EventHandlers:delete r[e]),this;if(0===arguments.length){for(var s,i=Object.keys(r),n=0;n<i.length;++n)"removeListener"!==(s=i[n])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=new EventHandlers,this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},EventEmitter.prototype.listeners=function(e){var t,r=this._events;return r&&(t=r[e])?"function"==typeof t?[t.listener||t]:unwrapListeners(t):[]},EventEmitter.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};const audioTestSample="data:audio/mpeg;base64,/+MYxAAAAANIAUAAAASEEB/jwOFM/0MM/90b/+RhST//w4NFwOjf///PZu////9lns5GFDv//l9GlUIEEIAAAgIg8Ir/JGq3/+MYxDsLIj5QMYcoAP0dv9HIjUcH//yYSg+CIbkGP//8w0bLVjUP///3Z0x5QCAv/yLjwtGKTEFNRTMuOTeqqqqqqqqqqqqq/+MYxEkNmdJkUYc4AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq";class AutoplaySingleton extends EventEmitter{constructor(){super(),this.allowed=new Promise((e=>{this.once("allowed",e)}))}listen(){this.timer=window.setTimeout((()=>this.update()),0)}stop(){this.timer&&(window.clearTimeout(this.timer),delete this.timer)}async update(){await this.test()?(this.emit("allowed"),delete this.timer):this.timer=window.setTimeout((()=>this.update()),1e3)}async test(){const e=new Audio;e.src=audioTestSample;const t=e.play();if(void 0===t)return!1;try{return await t,!0}catch(e){return!1}}}const Autoplay=new AutoplaySingleton;var ClientStatus,SessionStatus,SubscriptionStatus,ReconnectionMode;!function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.DYING="dying",e.RECOVERING="recovering",e.DISCONNECTING="disconnecting",e.DISCONNECTED="disconnected"}(ClientStatus||(ClientStatus={})),function(e){e.RINGING="ringing",e.ACTIVE="active",e.ON_HOLD="on_hold",e.TERMINATED="terminated"}(SessionStatus||(SessionStatus={})),function(e){e.AVAILABLE="available",e.TRYING="trying",e.PROCEEDING="proceeding",e.EARLY="early",e.RINGING="ringing",e.CONFIRMED="confirmed",e.BUSY="busy",e.TERMINATED="terminated"}(SubscriptionStatus||(SubscriptionStatus={})),function(e){e[e.ONCE=0]="ONCE",e[e.BURST=1]="BURST"}(ReconnectionMode||(ReconnectionMode={}));const mediaDevices="mediaDevices"in window.navigator,webaudio={mediaDevices:mediaDevices,setSinkId:"setSinkId"in new Audio,getUserMedia:mediaDevices&&"getUserMedia"in window.navigator.mediaDevices,audioContext:"AudioContext"in window||"webkitAudioContext"in window},peerConnection="RTCPeerConnection"in window,webrtc={peerConnection:peerConnection,connectionstatechange:peerConnection&&"onconnectionstatechange"in RTCPeerConnection.prototype},browserUa=navigator.userAgent.toLowerCase(),isSafari=-1!==browserUa.indexOf("safari")&&browserUa.indexOf("chrome")<0,isFirefox=-1!==browserUa.indexOf("firefox")&&browserUa.indexOf("chrome")<0,isChrome=-1!==browserUa.indexOf("chrome")&&!isSafari&&!isFirefox,isLocalhost=["127.0.0.1","localhost"].includes(window.location.hostname),required=[webrtc.peerConnection,webaudio.mediaDevices,webaudio.getUserMedia,webaudio.audioContext];function checkRequired(){return required.every((e=>e))}var features=Object.freeze({webaudio:webaudio,webrtc:webrtc,isSafari:isSafari,isFirefox:isFirefox,isChrome:isChrome,isLocalhost:isLocalhost,checkRequired:checkRequired});class Logger{constructor(e,t){this.level="info",this.level=e,t&&(this.connector=t)}static getLevelIdx(e){const t=Logger.levels[e];return void 0===t?0:t}error(e,t){this.log("error",e,t)}warn(e,t){this.log("warn",e,t)}info(e,t){this.log("info",e,t)}debug(e,t){this.log("debug",e,t)}verbose(e,t){this.log("verbose",e,t)}log(e,t,r){const s=Logger.getLevelIdx(e),i=Logger.getLevelIdx(this.level);this.connector&&s>=i&&this.connector({level:e,message:t,context:r})}}Logger.levels={error:4,warn:3,info:2,verbose:1,debug:0};const log=new Logger("info");var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function getCjsExportFromNamespace(e){return e&&e.default||e}function RetryOperation(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var retry_operation=RetryOperation;RetryOperation.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts},RetryOperation.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null},RetryOperation.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),r=this._timeouts.shift()}var s=this,i=setTimeout((function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout((function(){s._operationTimeoutCb(s._attempts)}),s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)}),r);return this._options.unref&&i.unref(),!0},RetryOperation.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},RetryOperation.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},RetryOperation.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},RetryOperation.prototype.start=RetryOperation.prototype.try,RetryOperation.prototype.errors=function(){return this._errors},RetryOperation.prototype.attempts=function(){return this._attempts},RetryOperation.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,s=0;s<this._errors.length;s++){var i=this._errors[s],n=i.message,o=(e[n]||0)+1;e[n]=o,o>=r&&(t=i,r=o)}return t};var retry=createCommonjsModule((function(e,t){t.operation=function(e){var r=t.timeouts(e);return new retry_operation(r,{forever:e&&e.forever,unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],i=0;i<t.retries;i++)s.push(this.createTimeout(i,t));return e&&e.forever&&!s.length&&s.push(this.createTimeout(i,t)),s.sort((function(e,t){return e-t})),s},t.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,s=Math.round(r*t.minTimeout*Math.pow(t.factor,e));return s=Math.min(s,t.maxTimeout)},t.wrap=function(e,r,s){if(r instanceof Array&&(s=r,r=null),!s)for(var i in s=[],e)"function"==typeof e[i]&&s.push(i);for(var n=0;n<s.length;n++){var o=s[n],a=e[o];e[o]=function(s){var i=t.operation(r),n=Array.prototype.slice.call(arguments,1),o=n.pop();n.push((function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),o.apply(this,arguments))})),i.attempt((function(){s.apply(e,n)}))}.bind(e,a),e[o].options=r}}})),retry_1=retry.operation,retry_2=retry.timeouts,retry_3=retry.createTimeout,retry_4=retry.wrap,retry$1=retry;class AbortError extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const decorateErrorWithCounts=(e,t,r)=>{const s=r.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=s,e},pRetry=(e,t)=>new Promise(((r,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};const i=retry$1.operation(t);i.attempt((async n=>{try{r(await e(n))}catch(e){if(!(e instanceof Error))return void s(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));e instanceof AbortError?(i.stop(),s(e.originalError)):e instanceof TypeError?(i.stop(),s(e)):(decorateErrorWithCounts(e,n,t),t.onFailedAttempt(e),i.retry(e)||s(i.mainError()))}}))}));var pRetry_1=pRetry,default_1=pRetry,AbortError_1=AbortError;pRetry_1.default=default_1,pRetry_1.AbortError=AbortError_1;var pFinally=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))));class TimeoutError extends Error{constructor(e){super(e),this.name="TimeoutError"}}const pTimeout=(e,t,r)=>new Promise(((s,i)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");const n=setTimeout((()=>{if("function"==typeof r){try{s(r())}catch(e){i(e)}return}const n=r instanceof Error?r:new TimeoutError("string"==typeof r?r:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),i(n)}),t);pFinally(e.then(s,i),(()=>{clearTimeout(n)}))}));var pTimeout_1=pTimeout,default_1$1=pTimeout,TimeoutError_1=TimeoutError;pTimeout_1.default=default_1$1,pTimeout_1.TimeoutError=TimeoutError_1;
var extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},extendStatics(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var __assign=function(){return __assign=Object.assign||function(e){for(var t,r=1,s=arguments.length;r<s;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign.apply(this,arguments)};function __rest(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(s=Object.getOwnPropertySymbols(e);i<s.length;i++)t.indexOf(s[i])<0&&(r[s[i]]=e[s[i]])}return r}function __decorate(e,t,r,s){var i,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(n<3?i(o):n>3?i(t,r,o):i(t,r))||o);return n>3&&o&&Object.defineProperty(t,r,o),o}function __param(e,t){return function(r,s){t(r,s,e)}}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __awaiter(e,t,r,s){return new(r||(r=Promise))((function(i,n){function o(e){try{c(s.next(e))}catch(e){n(e)}}function a(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,a)}c((s=s.apply(e,t||[])).next())}))}function __generator(e,t){var r,s,i,n,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,s&&(i=2&n[0]?s.return:n[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,n[1])).done)return i;switch(s=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,s=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==n[0]&&2!==n[0])){o=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){o.label=n[1];break}if(6===n[0]&&o.label<i[1]){o.label=i[1],i=n;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(n);break}i[2]&&o.ops.pop(),o.trys.pop();continue}n=t.call(e,o)}catch(e){n=[6,e],s=0}finally{r=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}}function __exportStar(e,t){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}function __values(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function __read(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var s,i,n=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=n.next()).done;)o.push(s.value)}catch(e){i={error:e}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}return o}function __spread(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(__read(arguments[t]));return e}function __await(e){return this instanceof __await?(this.v=e,this):new __await(e)}function __asyncGenerator(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,i=r.apply(e,t||[]),n=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(e){i[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=i[e](t)).value instanceof __await?Promise.resolve(r.value.v).then(c,u):d(n[0][2],r)}catch(e){d(n[0][3],e)}var r}function c(e){a("next",e)}function u(e){a("throw",e)}function d(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}function __asyncDelegator(e){var t,r;return t={},s("next"),s("throw",(function(e){throw e})),s("return"),t[Symbol.iterator]=function(){return this},t;function s(s,i){t[s]=e[s]?function(t){return(r=!r)?{value:__await(e[s](t)),done:"return"===s}:i?i(t):t}:i}}function __asyncValues(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(r){t[r]=e[r]&&function(t){return new Promise((function(s,i){(function(e,t,r,s){Promise.resolve(s).then((function(t){e({value:t,done:r})}),t)})(s,i,(t=e[r](t)).done,t.value)}))}}}function __makeTemplateObject(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function __importStar(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function __importDefault(e){return e&&e.__esModule?e:{default:e}}var tslib_es6=Object.freeze({__extends:__extends,get __assign(){return __assign},__rest:__rest,__decorate:__decorate,__param:__param,__metadata:__metadata,__awaiter:__awaiter,__generator:__generator,__exportStar:__exportStar,__values:__values,__read:__read,__spread:__spread,__await:__await,__asyncGenerator:__asyncGenerator,__asyncDelegator:__asyncDelegator,__asyncValues:__asyncValues,__makeTemplateObject:__makeTemplateObject,__importStar:__importStar,__importDefault:__importDefault}),constants=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.ACK="ACK",e.BYE="BYE",e.CANCEL="CANCEL",e.INFO="INFO",e.INVITE="INVITE",e.MESSAGE="MESSAGE",e.NOTIFY="NOTIFY",e.OPTIONS="OPTIONS",e.REGISTER="REGISTER",e.UPDATE="UPDATE",e.SUBSCRIBE="SUBSCRIBE",e.PUBLISH="PUBLISH",e.REFER="REFER",e.PRACK="PRACK"}(t.C||(t.C={}))}));unwrapExports(constants);var constants_1=constants.C,methods=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(constants,t)}));unwrapExports(methods);var parameters=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){for(var t in this.parameters={},e)e.hasOwnProperty(t)&&this.setParam(t,e[t])}return e.prototype.setParam=function(e,t){e&&(this.parameters[e.toLowerCase()]=null==t?null:t.toString())},e.prototype.getParam=function(e){if(e)return this.parameters[e.toLowerCase()]},e.prototype.hasParam=function(e){return!!e&&!!this.parameters.hasOwnProperty(e.toLowerCase())},e.prototype.deleteParam=function(e){if(e=e.toLowerCase(),this.parameters.hasOwnProperty(e)){var t=this.parameters[e];return delete this.parameters[e],t}},e.prototype.clearParams=function(){this.parameters={}},e}();t.Parameters=r}));unwrapExports(parameters);var parameters_1=parameters.Parameters,nameAddrHeader=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,s)||this;return i.uri=t,i._displayName=r,i}return tslib_es6.__extends(t,e),Object.defineProperty(t.prototype,"friendlyName",{get:function(){return this.displayName||this.uri.aor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayName",{get:function(){return this._displayName},set:function(e){this._displayName=e},enumerable:!0,configurable:!0}),t.prototype.clone=function(){return new t(this.uri.clone(),this._displayName,JSON.parse(JSON.stringify(this.parameters)))},t.prototype.toString=function(){var e=this.displayName||"0"===this.displayName?'"'+this.displayName+'" ':"";for(var t in e+="<"+this.uri.toString()+">",this.parameters)this.parameters.hasOwnProperty(t)&&(e+=";"+t,null!==this.parameters[t]&&(e+="="+this.parameters[t]));return e},t}(parameters.Parameters);t.NameAddrHeader=r}));unwrapExports(nameAddrHeader);var nameAddrHeader_1=nameAddrHeader.NameAddrHeader,uri=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i,n,o){var a=e.call(this,n)||this;if(a.headers={},!s)throw new TypeError('missing or invalid "host" parameter');for(var c in t=t||"sip",o)o.hasOwnProperty(c)&&a.setHeader(c,o[c]);return a.raw={scheme:t,user:r,host:s,port:i},a.normal={scheme:t.toLowerCase(),user:r,host:s.toLowerCase(),port:i},a}return tslib_es6.__extends(t,e),Object.defineProperty(t.prototype,"scheme",{get:function(){return this.normal.scheme},set:function(e){this.raw.scheme=e,this.normal.scheme=e.toLowerCase()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"user",{get:function(){return this.normal.user},set:function(e){this.normal.user=this.raw.user=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"host",{get:function(){return this.normal.host},set:function(e){this.raw.host=e,this.normal.host=e.toLowerCase()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aor",{get:function(){return this.normal.user+"@"+this.normal.host},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"port",{get:function(){return this.normal.port},set:function(e){this.normal.port=this.raw.port=e},enumerable:!0,configurable:!0}),t.prototype.setHeader=function(e,t){this.headers[this.headerize(e)]=t instanceof Array?t:[t]},t.prototype.getHeader=function(e){if(e)return this.headers[this.headerize(e)]},t.prototype.hasHeader=function(e){return!!e&&!!this.headers.hasOwnProperty(this.headerize(e))},t.prototype.deleteHeader=function(e){if(e=this.headerize(e),this.headers.hasOwnProperty(e)){var t=this.headers[e];return delete this.headers[e],t}},t.prototype.clearHeaders=function(){this.headers={}},t.prototype.clone=function(){return new t(this._raw.scheme,this._raw.user||"",this._raw.host,this._raw.port,JSON.parse(JSON.stringify(this.parameters)),JSON.parse(JSON.stringify(this.headers)))},t.prototype.toRaw=function(){return this._toString(this._raw)},t.prototype.toString=function(){return this._toString(this._normal)},Object.defineProperty(t.prototype,"_normal",{get:function(){return this.normal},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_raw",{get:function(){return this.raw},enumerable:!0,configurable:!0}),t.prototype._toString=function(e){var t=e.scheme+":";for(var r in e.scheme.toLowerCase().match("^sips?$")||(t+="//"),e.user&&(t+=this.escapeUser(e.user)+"@"),t+=e.host,(e.port||0===e.port)&&(t+=":"+e.port),this.parameters)this.parameters.hasOwnProperty(r)&&(t+=";"+r,null!==this.parameters[r]&&(t+="="+this.parameters[r]));var s=[];for(var i in this.headers)if(this.headers.hasOwnProperty(i))for(var n in this.headers[i])this.headers[i].hasOwnProperty(n)&&s.push(i+"="+this.headers[i][n]);return s.length>0&&(t+="?"+s.join("&")),t},t.prototype.escapeUser=function(e){return encodeURIComponent(decodeURIComponent(e)).replace(/%3A/gi,":").replace(/%2B/gi,"+").replace(/%3F/gi,"?").replace(/%2F/gi,"/")},t.prototype.headerize=function(e){for(var t={"Call-Id":"Call-ID",Cseq:"CSeq","Min-Se":"Min-SE",Rack:"RAck",Rseq:"RSeq","Www-Authenticate":"WWW-Authenticate"},r=e.toLowerCase().replace(/_/g,"-").split("-"),s=r.length,i="",n=0;n<s;n++)0!==n&&(i+="-"),i+=r[n].charAt(0).toUpperCase()+r[n].substring(1);return t[i]&&(i=t[i]),i},t}(parameters.Parameters);t.URI=r}));unwrapExports(uri);var uri_1=uri.URI,grammar=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(r,s,i,n){var o=e.call(this)||this;return o.message=r,o.expected=s,o.found=i,o.location=n,o.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(o,t),o}return tslib_es6.__extends(t,e),t.buildMessage=function(e,t){function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function s(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function i(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function n(e){switch(e.type){case"literal":return'"'+s(e.text)+'"';case"class":var t=e.parts.map((function(e){return Array.isArray(e)?i(e[0])+"-"+i(e[1]):i(e)}));return"["+(e.inverted?"^":"")+t+"]";case"any":return"any character";case"end":return"end of input";case"other":return e.description}}return"Expected "+function(e){var t,r,s=e.map(n);if(s.sort(),s.length>0){for(t=1,r=1;t<s.length;t++)s[t-1]!==s[t]&&(s[r]=s[t],r++);s.length=r}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(e)+" but "+(((o=t)?'"'+s(o)+'"':"end of input")+" found.");var o},t}(Error);t.SyntaxError=r,t.parse=function(e,t){t=void 0!==t?t:{};var s,i,n,o,a={},c={Contact:119,Name_Addr_Header:156,Record_Route:176,Request_Response:81,SIP_URI:45,Subscription_State:186,Supported:191,Require:182,Via:194,absoluteURI:84,Call_ID:118,Content_Disposition:130,Content_Length:135,Content_Type:136,CSeq:146,displayName:122,Event:149,From:151,host:52,Max_Forwards:154,Min_SE:213,Proxy_Authenticate:157,quoted_string:40,Refer_To:178,Replaces:179,Session_Expires:210,stun_URI:217,To:192,turn_URI:223,uuid:226,WWW_Authenticate:209,challenge:158,sipfrag:230,Referred_By:231},u=119,d=["\r\n",y("\r\n",!1),/^[0-9]/,_([["0","9"]],!1,!1),/^[a-zA-Z]/,_([["a","z"],["A","Z"]],!1,!1),/^[0-9a-fA-F]/,_([["0","9"],["a","f"],["A","F"]],!1,!1),/^[\0-\xFF]/,_([["\0","ÿ"]],!1,!1),/^["]/,_(['"'],!1,!1)," ",y(" ",!1),"\t",y("\t",!1),/^[a-zA-Z0-9]/,_([["a","z"],["A","Z"],["0","9"]],!1,!1),";",y(";",!1),"/",y("/",!1),"?",y("?",!1),":",y(":",!1),"@",y("@",!1),"&",y("&",!1),"=",y("=",!1),"+",y("+",!1),"$",y("$",!1),",",y(",",!1),"-",y("-",!1),"_",y("_",!1),".",y(".",!1),"!",y("!",!1),"~",y("~",!1),"*",y("*",!1),"'",y("'",!1),"(",y("(",!1),")",y(")",!1),"%",y("%",!1),function(){return" "},function(){return":"},/^[!-~]/,_([["!","~"]],!1,!1),/^[\x80-\uFFFF]/,_([["","￿"]],!1,!1),/^[\x80-\xBF]/,_([["","¿"]],!1,!1),/^[a-f]/,_([["a","f"]],!1,!1),"`",y("`",!1),"<",y("<",!1),">",y(">",!1),"\\",y("\\",!1),"[",y("[",!1),"]",y("]",!1),"{",y("{",!1),"}",y("}",!1),function(){return"*"},function(){return"/"},function(){return"="},function(){return"("},function(){return")"},function(){return">"},function(){return"<"},function(){return","},function(){return";"},function(){return":"},function(){return'"'},/^[!-']/,_([["!","'"]],!1,!1),/^[*-[]/,_([["*","["]],!1,!1),/^[\]-~]/,_([["]","~"]],!1,!1),function(e){return e},/^[#-[]/,_([["#","["]],!1,!1),/^[\0-\t]/,_([["\0","\t"]],!1,!1),/^[\x0B-\f]/,_([["\v","\f"]],!1,!1),/^[\x0E-\x7F]/,_([["",""]],!1,!1),function(){(t=t||{data:{}}).data.uri=new uri.URI(t.data.scheme,t.data.user,t.data.host,t.data.port),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port},function(){(t=t||{data:{}}).data.uri=new uri.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params,"SIP_URI"===t.startRule&&(t.data=t.data.uri)},"sips",y("sips",!0),"sip",y("sip",!0),function(e){(t=t||{data:{}}).data.scheme=e},function(){(t=t||{data:{}}).data.user=decodeURIComponent(S().slice(0,-1))},function(){(t=t||{data:{}}).data.password=S()},function(){return(t=t||{data:{}}).data.host=S(),t.data.host},function(){return(t=t||{data:{}}).data.host_type="domain",S()},/^[a-zA-Z0-9_\-]/,_([["a","z"],["A","Z"],["0","9"],"_","-"],!1,!1),/^[a-zA-Z0-9\-]/,_([["a","z"],["A","Z"],["0","9"],"-"],!1,!1),function(){return(t=t||{data:{}}).data.host_type="IPv6",S()},"::",y("::",!1),function(){return(t=t||{data:{}}).data.host_type="IPv6",S()},function(){return(t=t||{data:{}}).data.host_type="IPv4",S()},"25",y("25",!1),/^[0-5]/,_([["0","5"]],!1,!1),"2",y("2",!1),/^[0-4]/,_([["0","4"]],!1,!1),"1",y("1",!1),/^[1-9]/,_([["1","9"]],!1,!1),function(e){return t=t||{data:{}},e=parseInt(e.join("")),t.data.port=e,e},"transport=",y("transport=",!0),"udp",y("udp",!0),"tcp",y("tcp",!0),"sctp",y("sctp",!0),"tls",y("tls",!0),function(e){(t=t||{data:{}}).data.uri_params||(t.data.uri_params={}),t.data.uri_params.transport=e.toLowerCase()},"user=",y("user=",!0),"phone",y("phone",!0),"ip",y("ip",!0),function(e){(t=t||{data:{}}).data.uri_params||(t.data.uri_params={}),t.data.uri_params.user=e.toLowerCase()},"method=",y("method=",!0),function(e){(t=t||{data:{}}).data.uri_params||(t.data.uri_params={}),t.data.uri_params.method=e},"ttl=",y("ttl=",!0),function(e){(t=t||{data:{}}).data.params||(t.data.params={}),t.data.params.ttl=e},"maddr=",y("maddr=",!0),function(e){(t=t||{data:{}}).data.uri_params||(t.data.uri_params={}),t.data.uri_params.maddr=e},"lr",y("lr",!0),function(){(t=t||{data:{}}).data.uri_params||(t.data.uri_params={}),t.data.uri_params.lr=void 0},function(e,r){(t=t||{data:{}}).data.uri_params||(t.data.uri_params={}),r=null===r?void 0:r[1],t.data.uri_params[e.toLowerCase()]=r},function(e,r){e=e.join("").toLowerCase(),r=r.join(""),(t=t||{data:{}}).data.uri_headers||(t.data.uri_headers={}),t.data.uri_headers[e]?t.data.uri_headers[e].push(r):t.data.uri_headers[e]=[r]},function(){"Refer_To"===(t=t||{data:{}}).startRule&&(t.data.uri=new uri.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params)},"//",y("//",!1),function(){(t=t||{data:{}}).data.scheme=S()},y("SIP",!0),function(){(t=t||{data:{}}).data.sip_version=S()},"INVITE",y("INVITE",!1),"ACK",y("ACK",!1),"VXACH",y("VXACH",!1),"OPTIONS",y("OPTIONS",!1),"BYE",y("BYE",!1),"CANCEL",y("CANCEL",!1),"REGISTER",y("REGISTER",!1),"SUBSCRIBE",y("SUBSCRIBE",!1),"NOTIFY",y("NOTIFY",!1),"REFER",y("REFER",!1),"PUBLISH",y("PUBLISH",!1),function(){return(t=t||{data:{}}).data.method=S(),t.data.method},function(e){(t=t||{data:{}}).data.status_code=parseInt(e.join(""))},function(){(t=t||{data:{}}).data.reason_phrase=S()},function(){(t=t||{data:{}}).data=S()},function(){var e,r;for(r=(t=t||{data:{}}).data.multi_header.length,e=0;e<r;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;(t=t||{data:{}}).data.multi_header||(t.data.multi_header=[]);try{e=new nameAddrHeader.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:p,offset:T().start.offset,parsed:e})},function(e){'"'===(e=S().trim())[0]&&(e=e.substring(1,e.length-1)),(t=t||{data:{}}).data.displayName=e},"q",y("q",!0),function(e){(t=t||{data:{}}).data.params||(t.data.params={}),t.data.params.q=e},"expires",y("expires",!0),function(e){(t=t||{data:{}}).data.params||(t.data.params={}),t.data.params.expires=e},function(e){return parseInt(e.join(""))},"0",y("0",!1),function(){return parseFloat(S())},function(e,r){(t=t||{data:{}}).data.params||(t.data.params={}),r=null===r?void 0:r[1],t.data.params[e.toLowerCase()]=r},"render",y("render",!0),"session",y("session",!0),"icon",y("icon",!0),"alert",y("alert",!0),function(){"Content_Disposition"===(t=t||{data:{}}).startRule&&(t.data.type=S().toLowerCase())},"handling",y("handling",!0),"optional",y("optional",!0),"required",y("required",!0),function(e){(t=t||{data:{}}).data=parseInt(e.join(""))},function(){(t=t||{data:{}}).data=S()},"text",y("text",!0),"image",y("image",!0),"audio",y("audio",!0),"video",y("video",!0),"application",y("application",!0),"message",y("message",!0),"multipart",y("multipart",!0),"x-",y("x-",!0),function(e){(t=t||{data:{}}).data.value=parseInt(e.join(""))},function(e){(t=t||{data:{}}).data=e},function(e){(t=t||{data:{}}).data.event=e.toLowerCase()},function(){var e=(t=t||{data:{}}).data.tag;t.data=new nameAddrHeader.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"tag",y("tag",!0),function(e){(t=t||{data:{}}).data.tag=e},function(e){(t=t||{data:{}}).data=parseInt(e.join(""))},function(e){(t=t||{data:{}}).data=e},function(){(t=t||{data:{}}).data=new nameAddrHeader.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},"digest",y("Digest",!0),"realm",y("realm",!0),function(e){(t=t||{data:{}}).data.realm=e},"domain",y("domain",!0),"nonce",y("nonce",!0),function(e){(t=t||{data:{}}).data.nonce=e},"opaque",y("opaque",!0),function(e){(t=t||{data:{}}).data.opaque=e},"stale",y("stale",!0),"true",y("true",!0),function(){(t=t||{data:{}}).data.stale=!0},"false",y("false",!0),function(){(t=t||{data:{}}).data.stale=!1},"algorithm",y("algorithm",!0),"md5",y("MD5",!0),"md5-sess",y("MD5-sess",!0),function(e){(t=t||{data:{}}).data.algorithm=e.toUpperCase()},"qop",y("qop",!0),"auth-int",y("auth-int",!0),"auth",y("auth",!0),function(e){(t=t||{data:{}}).data.qop||(t.data.qop=[]),t.data.qop.push(e.toLowerCase())},function(e){(t=t||{data:{}}).data.value=parseInt(e.join(""))},function(){var e,r;for(r=(t=t||{data:{}}).data.multi_header.length,e=0;e<r;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;(t=t||{data:{}}).data.multi_header||(t.data.multi_header=[]);try{e=new nameAddrHeader.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:p,offset:T().start.offset,parsed:e})},function(){(t=t||{data:{}}).data=new nameAddrHeader.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},function(){(t=t||{data:{}}).data.replaces_from_tag&&t.data.replaces_to_tag||(t.data=-1)},function(){(t=t||{data:{}}).data={call_id:t.data}},"from-tag",y("from-tag",!0),function(e){(t=t||{data:{}}).data.replaces_from_tag=e},"to-tag",y("to-tag",!0),function(e){(t=t||{data:{}}).data.replaces_to_tag=e},"early-only",y("early-only",!0),function(){(t=t||{data:{}}).data.early_only=!0},function(e,t){return t},function(e,t){return function(e,t){return[e].concat(t)}(e,t)},function(e){"Require"===(t=t||{data:{}}).startRule&&(t.data=e||[])},function(e){(t=t||{data:{}}).data.value=parseInt(e.join(""))},"active",y("active",!0),"pending",y("pending",!0),"terminated",y("terminated",!0),function(){(t=t||{data:{}}).data.state=S()},"reason",y("reason",!0),function(e){t=t||{data:{}},void 0!==e&&(t.data.reason=e)},function(e){t=t||{data:{}},void 0!==e&&(t.data.expires=e)},"retry_after",y("retry_after",!0),function(e){t=t||{data:{}},void 0!==e&&(t.data.retry_after=e)},"deactivated",y("deactivated",!0),"probation",y("probation",!0),"rejected",y("rejected",!0),"timeout",y("timeout",!0),"giveup",y("giveup",!0),"noresource",y("noresource",!0),"invariant",y("invariant",!0),function(e){"Supported"===(t=t||{data:{}}).startRule&&(t.data=e||[])},function(){var e=(t=t||{data:{}}).data.tag;t.data=new nameAddrHeader.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"ttl",y("ttl",!0),function(e){(t=t||{data:{}}).data.ttl=e},"maddr",y("maddr",!0),function(e){(t=t||{data:{}}).data.maddr=e},"received",y("received",!0),function(e){(t=t||{data:{}}).data.received=e},"branch",y("branch",!0),function(e){(t=t||{data:{}}).data.branch=e},"rport",y("rport",!0),function(e){t=t||{data:{}},void 0!==e&&(t.data.rport=e.join(""))},function(e){(t=t||{data:{}}).data.protocol=e},y("UDP",!0),y("TCP",!0),y("TLS",!0),y("SCTP",!0),function(e){(t=t||{data:{}}).data.transport=e},function(){(t=t||{data:{}}).data.host=S()},function(e){(t=t||{data:{}}).data.port=parseInt(e.join(""))},function(e){return parseInt(e.join(""))},function(e){"Session_Expires"===(t=t||{data:{}}).startRule&&(t.data.deltaSeconds=e)},"refresher",y("refresher",!1),"uas",y("uas",!1),"uac",y("uac",!1),function(e){"Session_Expires"===(t=t||{data:{}}).startRule&&(t.data.refresher=e)},function(e){"Min_SE"===(t=t||{data:{}}).startRule&&(t.data=e)},"stuns",y("stuns",!0),"stun",y("stun",!0),function(e){(t=t||{data:{}}).data.scheme=e},function(e){(t=t||{data:{}}).data.host=e},"?transport=",y("?transport=",!1),"turns",y("turns",!0),"turn",y("turn",!0),function(e){(t=t||{data:{}}).data.transport=e},function(){(t=t||{data:{}}).data=S()},"Referred-By",y("Referred-By",!1),"b",y("b",!1),"cid",y("cid",!1)],l=[A('2 ""6 7!'),A('4"""5!7#'),A('4$""5!7%'),A('4&""5!7\''),A(";'.# &;("),A('4(""5!7)'),A('4*""5!7+'),A('2,""6,7-'),A('2.""6.7/'),A('40""5!71'),A('22""6273. &24""6475.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),A(";).# &;,"),A('2F""6F7G.} &2H""6H7I.q &2J""6J7K.e &2L""6L7M.Y &2N""6N7O.M &2P""6P7Q.A &2R""6R7S.5 &2T""6T7U.) &2V""6V7W'),A('%%2X""6X7Y/5#;#/,$;#/#$+#)(#\'#("\'#&\'#/"!&,)'),A('%%$;$0#*;$&/,#; /#$+")("\'#&\'#." &"/=#$;$/&#0#*;$&&&#/\'$8":Z" )("\'#&\'#'),A(';.." &"'),A("%$;'.# &;(0)*;'.# &;(&/?#28\"\"6879/0$;//'$8#:[# )(#'#(\"'#&'#"),A('%%$;2/&#0#*;2&&&#/g#$%$;.0#*;.&/,#;2/#$+")("\'#&\'#0=*%$;.0#*;.&/,#;2/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),A('4\\""5!7].# &;3'),A('4^""5!7_'),A('4`""5!7a'),A(';!.) &4b""5!7c'),A('%$;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),A('%$;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),A('2T""6T7U.ã &2V""6V7W.× &2f""6f7g.Ë &2h""6h7i.¿ &2:""6:7;.³ &2D""6D7E.§ &22""6273. &28""6879. &2j""6j7k. &;&.} &24""6475.q &2l""6l7m.e &2n""6n7o.Y &26""6677.M &2>""6>7?.A &2p""6p7q.5 &2r""6r7s.) &;\'.# &;('),A('%$;).ī &2F""6F7G.ğ &2J""6J7K.ē &2L""6L7M.ć &2X""6X7Y.û &2P""6P7Q.ï &2H""6H7I.ã &2@""6@7A.× &2d""6d7e.Ë &2R""6R7S.¿ &2N""6N7O.³ &2T""6T7U.§ &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s/Ĵ#0ı*;).ī &2F""6F7G.ğ &2J""6J7K.ē &2L""6L7M.ć &2X""6X7Y.û &2P""6P7Q.ï &2H""6H7I.ã &2@""6@7A.× &2d""6d7e.Ë &2R""6R7S.¿ &2N""6N7O.³ &2T""6T7U.§ &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s&&&#/"!&,)'),A("%;//?#2P\"\"6P7Q/0$;//'$8#:t# )(#'#(\"'#&'#"),A("%;//?#24\"\"6475/0$;//'$8#:u# )(#'#(\"'#&'#"),A("%;//?#2>\"\"6>7?/0$;//'$8#:v# )(#'#(\"'#&'#"),A("%;//?#2T\"\"6T7U/0$;//'$8#:w# )(#'#(\"'#&'#"),A("%;//?#2V\"\"6V7W/0$;//'$8#:x# )(#'#(\"'#&'#"),A('%2h""6h7i/0#;//\'$8":y" )("\'#&\'#'),A('%;//6#2f""6f7g/\'$8":z" )("\'#&\'#'),A("%;//?#2D\"\"6D7E/0$;//'$8#:{# )(#'#(\"'#&'#"),A("%;//?#22\"\"6273/0$;//'$8#:|# )(#'#(\"'#&'#"),A("%;//?#28\"\"6879/0$;//'$8#:}# )(#'#(\"'#&'#"),A("%;//0#;&/'$8\":~\" )(\"'#&'#"),A("%;&/0#;//'$8\":~\" )(\"'#&'#"),A("%;=/T#$;G.) &;K.# &;F0/*;G.) &;K.# &;F&/,$;>/#$+#)(#'#(\"'#&'#"),A('4""5!7.A &4""5!7.5 &4""5!7.) &;3.# &;.'),A("%%;//Q#;&/H$$;J.# &;K0)*;J.# &;K&/,$;&/#$+$)($'#(#'#(\"'#&'#/\"!&,)"),A("%;//]#;&/T$%$;J.# &;K0)*;J.# &;K&/\"!&,)/1$;&/($8$:$!!)($'#(#'#(\"'#&'#"),A(';..G &2L""6L7M.; &4""5!7./ &4""5!7.# &;3'),A('%2j""6j7k/J#4""5!7.5 &4""5!7.) &4""5!7/#$+")("\'#&\'#'),A("%;N/M#28\"\"6879/>$;O.\" &\"/0$;S/'$8$:$ )($'#(#'#(\"'#&'#"),A("%;N/d#28\"\"6879/U$;O.\" &\"/G$;S/>$;_/5$;l.\" &\"/'$8&:& )(&'#(%'#($'#(#'#(\"'#&'#"),A('%3""5$7.) &3""5#7/\' 8!:!! )'),A('%;P/]#%28""6879/,#;R/#$+")("\'#&\'#." &"/6$2:""6:7;/\'$8#:# )(#\'#("\'#&\'#'),A("$;+.) &;-.# &;Q/2#0/*;+.) &;-.# &;Q&&&#"),A('2<""6<7=.q &2>""6>7?.e &2@""6@7A.Y &2B""6B7C.M &2D""6D7E.A &22""6273.5 &26""6677.) &24""6475'),A('%$;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E0e*;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E&/& 8!:! )'),A('%;T/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),A("%;U.) &;\\.# &;X/& 8!:! )"),A('%$%;V/2#2J""6J7K/#$+")("\'#&\'#0<*%;V/2#2J""6J7K/#$+")("\'#&\'#&/D#;W/;$2J""6J7K." &"/\'$8#:# )(#\'#("\'#&\'#'),A('$4""5!7/,#0)*4""5!7&&&#'),A('%4$""5!7%/?#$4""5!70)*4""5!7&/#$+")("\'#&\'#'),A('%2l""6l7m/?#;Y/6$2n""6n7o/\'$8#:# )(#\'#("\'#&\'#'),A('%%;Z/³#28""6879/¤$;Z/$28""6879/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+-)(-\'#(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ސ &%2""67/¤#;Z/$28""6879/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+,)(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.۹ &%2""67/#;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ٺ &%2""67/t#;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ؓ &%2""67/\\#;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+&)(&\'#(%\'#($\'#(#\'#("\'#&\'#.ׄ &%2""67/D#;Z/;$28""6879/,$;[/#$+$)($\'#(#\'#("\'#&\'#.֍ &%2""67/,#;[/#$+")("\'#&\'#.ծ &%2""67/,#;Z/#$+")("\'#&\'#.Տ &%;Z/#2""67/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$++)(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ӈ &%;Z/ª#%28""6879/,#;Z/#$+")("\'#&\'#." &"/$2""67/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.а &%;Z/¹#%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/k$2""67/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+))()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ί &%;Z/È#%28""6879/,#;Z/#$+")("\'#&\'#." &"/¡$%28""6879/,#;Z/#$+")("\'#&\'#." &"/z$%28""6879/,#;Z/#$+")("\'#&\'#." &"/S$2""67/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.˕ &%;Z/×#%28""6879/,#;Z/#$+")("\'#&\'#." &"/°$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2""67/,$;[/#$+\')(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ȑ &%;Z/þ#%28""6879/,#;Z/#$+")("\'#&\'#." &"/×$%28""6879/,#;Z/#$+")("\'#&\'#." &"/°$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2""67/,$;Z/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ħ &%;Z/Ĝ#%28""6879/,#;Z/#$+")("\'#&\'#." &"/õ$%28""6879/,#;Z/#$+")("\'#&\'#." &"/Î$%28""6879/,#;Z/#$+")("\'#&\'#." &"/§$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/Y$%28""6879/,#;Z/#$+")("\'#&\'#." &"/2$2""67/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#/& 8!: ! )'),A('%;#/M#;#." &"/?$;#." &"/1$;#." &"/#$+$)($\'#(#\'#("\'#&\'#'),A("%;Z/;#28\"\"6879/,$;Z/#$+#)(#'#(\"'#&'#.# &;\\"),A("%;]/o#2J\"\"6J7K/`$;]/W$2J\"\"6J7K/H$;]/?$2J\"\"6J7K/0$;]/'$8':¡' )(''#(&'#(%'#($'#(#'#(\"'#&'#"),A('%2¢""6¢7£/2#4¤""5!7¥/#$+")("\'#&\'#. &%2¦""6¦7§/;#4¨""5!7©/,$;!/#$+#)(#\'#("\'#&\'#.j &%2ª""6ª7«/5#;!/,$;!/#$+#)(#\'#("\'#&\'#.B &%4¬""5!7­/,#;!/#$+")("\'#&\'#.# &;!'),A('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:®!! )'),A('$%22""6273/,#;`/#$+")("\'#&\'#0<*%22""6273/,#;`/#$+")("\'#&\'#&'),A(";a.A &;b.; &;c.5 &;d./ &;e.) &;f.# &;g"),A('%3¯""5*7°/a#3±""5#7².G &3³""5#7´.; &3µ""5$7¶./ &3·""5#7¸.# &;6/($8":¹"! )("\'#&\'#'),A('%3º""5%7»/I#3¼""5%7½./ &3¾""5"7¿.# &;6/($8":À"! )("\'#&\'#'),A('%3Á""5\'7Â/1#;/($8":Ã"! )("\'#&\'#'),A('%3Ä""5$7Å/1#;ð/($8":Æ"! )("\'#&\'#'),A('%3Ç""5&7È/1#;T/($8":É"! )("\'#&\'#'),A('%3Ê""5"7Ë/N#%2>""6>7?/,#;6/#$+")("\'#&\'#." &"/\'$8":Ì" )("\'#&\'#'),A('%;h/P#%2>""6>7?/,#;i/#$+")("\'#&\'#." &"/)$8":Í""! )("\'#&\'#'),A('%$;j/&#0#*;j&&&#/"!&,)'),A('%$;j/&#0#*;j&&&#/"!&,)'),A(";k.) &;+.# &;-"),A('2l""6l7m.e &2n""6n7o.Y &24""6475.M &28""6879.A &2<""6<7=.5 &2@""6@7A.) &2B""6B7C'),A('%26""6677/n#;m/e$$%2<""6<7=/,#;m/#$+")("\'#&\'#0<*%2<""6<7=/,#;m/#$+")("\'#&\'#&/#$+#)(#\'#("\'#&\'#'),A('%;n/A#2>""6>7?/2$;o/)$8#:Î#"" )(#\'#("\'#&\'#'),A("$;p.) &;+.# &;-/2#0/*;p.) &;+.# &;-&&&#"),A("$;p.) &;+.# &;-0/*;p.) &;+.# &;-&"),A('2l""6l7m.e &2n""6n7o.Y &24""6475.M &26""6677.A &28""6879.5 &2@""6@7A.) &2B""6B7C'),A(";.# &;r"),A("%;/G#;'/>$;s/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),A(";M.# &;t"),A("%;/E#28\"\"6879/6$;u.# &;x/'$8#:Ï# )(#'#(\"'#&'#"),A('%;v.# &;w/J#%26""6677/,#;/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),A('%2Ð""6Ð7Ñ/:#;/1$;w." &"/#$+#)(#\'#("\'#&\'#'),A('%24""6475/,#;{/#$+")("\'#&\'#'),A("%;z/3#$;y0#*;y&/#$+\")(\"'#&'#"),A(";*.) &;+.# &;-"),A(';+. &;-. &22""6273.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),A('%;|/e#$%24""6475/,#;|/#$+")("\'#&\'#0<*%24""6475/,#;|/#$+")("\'#&\'#&/#$+")("\'#&\'#'),A('%$;~0#*;~&/e#$%22""6273/,#;}/#$+")("\'#&\'#0<*%22""6273/,#;}/#$+")("\'#&\'#&/#$+")("\'#&\'#'),A("$;~0#*;~&"),A(';+.w &;-.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),A('%%;"/#$;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K0M*;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K&/#$+")("\'#&\'#/& 8!:Ò! )'),A(";.# &;"),A('%%;O/2#2:""6:7;/#$+")("\'#&\'#." &"/,#;S/#$+")("\'#&\'#." &"'),A('$;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A/#0*;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A&&&#'),A("$;y0#*;y&"),A('%3""5#7Ó/q#24""6475/b$$;!/&#0#*;!&&&#/L$2J""6J7K/=$$;!/&#0#*;!&&&#/\'$8%:Ô% )(%\'#($\'#(#\'#("\'#&\'#'),A('2Õ""6Õ7Ö'),A('2×""6×7Ø'),A('2Ù""6Ù7Ú'),A('2Û""6Û7Ü'),A('2Ý""6Ý7Þ'),A('2ß""6ß7à'),A('2á""6á7â'),A('2ã""6ã7ä'),A('2å""6å7æ'),A('2ç""6ç7è'),A('2é""6é7ê'),A("%;.Y &;.S &;.M &;.G &;.A &;.; &;.5 &;./ &;.) &;.# &;6/& 8!:ë! )"),A("%;/G#;'/>$;/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),A("%;/' 8!:ì!! )"),A("%;!/5#;!/,$;!/#$+#)(#'#(\"'#&'#"),A("%$;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(0G*;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(&/& 8!:í! )"),A("%;¶/Y#$%;A/,#;¶/#$+\")(\"'#&'#06*%;A/,#;¶/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A('%;9/N#%2:""6:7;/,#;9/#$+")("\'#&\'#." &"/\'$8":î" )("\'#&\'#'),A("%;:.c &%;/Y#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#/& 8!:ï! )"),A("%;L.# &;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":ð\" )(\"'#&'#"),A("%;.\" &\"/>#;@/5$;M/,$;?/#$+$)($'#(#'#(\"'#&'#"),A("%%;6/Y#$%;./,#;6/#$+\")(\"'#&'#06*%;./,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#.# &;H/' 8!:ñ!! )"),A(";.) &;.# &; "),A("%3ò\"\"5!7ó/:#;</1$;/($8#:ô#! )(#'#(\"'#&'#"),A("%3õ\"\"5'7ö/:#;</1$;/($8#:÷#! )(#'#(\"'#&'#"),A("%$;!/&#0#*;!&&&#/' 8!:ø!! )"),A('%2ù""6ù7ú/o#%2J""6J7K/M#;!." &"/?$;!." &"/1$;!." &"/#$+$)($\'#(#\'#("\'#&\'#." &"/\'$8":û" )("\'#&\'#'),A('%;6/J#%;</,#;¡/#$+")("\'#&\'#." &"/)$8":ü""! )("\'#&\'#'),A(";6.) &;T.# &;H"),A("%;£/Y#$%;B/,#;¤/#$+\")(\"'#&'#06*%;B/,#;¤/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A('%3ý""5&7þ.G &3ÿ""5\'7Ā.; &3ā""5$7Ă./ &3ă""5%7Ą.# &;6/& 8!:ą! )'),A(";¥.# &; "),A('%3Ć""5(7ć/M#;</D$3Ĉ""5(7ĉ./ &3Ċ""5(7ċ.# &;6/#$+#)(#\'#("\'#&\'#'),A("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A("%$;!/&#0#*;!&&&#/' 8!:Č!! )"),A("%;©/& 8!:č! )"),A("%;ª/k#;;/b$;¯/Y$$%;B/,#;°/#$+\")(\"'#&'#06*%;B/,#;°/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),A(";«.# &;¬"),A('3Ď""5$7ď.S &3Đ""5%7đ.G &3Ē""5%7ē.; &3Ĕ""5%7ĕ./ &3Ė""5+7ė.# &;­'),A('3Ę""5\'7ę./ &3Ě""5)7ě.# &;­'),A(";6.# &;®"),A('%3Ĝ""5"7ĝ/,#;6/#$+")("\'#&\'#'),A(";­.# &;6"),A("%;6/5#;</,$;±/#$+#)(#'#(\"'#&'#"),A(";6.# &;H"),A("%;³/5#;./,$;/#$+#)(#'#(\"'#&'#"),A("%$;!/&#0#*;!&&&#/' 8!:Ğ!! )"),A("%;/' 8!:ğ!! )"),A('%;¶/^#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/($8":Ġ"!!)("\'#&\'#'),A('%%;7/e#$%2J""6J7K/,#;7/#$+")("\'#&\'#0<*%2J""6J7K/,#;7/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),A("%;L.# &;/]#$%;B/,#;¸/#$+\")(\"'#&'#06*%;B/,#;¸/#$+\")(\"'#&'#&/'$8\":ġ\" )(\"'#&'#"),A(";¹.# &; "),A("%3Ģ\"\"5#7ģ/:#;</1$;6/($8#:Ĥ#! )(#'#(\"'#&'#"),A("%$;!/&#0#*;!&&&#/' 8!:ĥ!! )"),A("%;/' 8!:Ħ!! )"),A("%$;0#*;&/x#;@/o$;M/f$;?/]$$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/'$8%:ħ% )(%'#($'#(#'#(\"'#&'#"),A(";¾"),A("%3Ĩ\"\"5&7ĩ/k#;./b$;Á/Y$$%;A/,#;Á/#$+\")(\"'#&'#06*%;A/,#;Á/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#.# &;¿"),A("%;6/k#;./b$;À/Y$$%;A/,#;À/#$+\")(\"'#&'#06*%;A/,#;À/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),A("%;6/;#;</2$;6.# &;H/#$+#)(#'#(\"'#&'#"),A(";Â.G &;Ä.A &;Æ.; &;È.5 &;É./ &;Ê.) &;Ë.# &;À"),A("%3Ī\"\"5%7ī/5#;</,$;Ã/#$+#)(#'#(\"'#&'#"),A("%;I/' 8!:Ĭ!! )"),A("%3ĭ\"\"5&7Į/#;</$;D/$;Å/|$$%$;'/&#0#*;'&&&#/,#;Å/#$+\")(\"'#&'#0C*%$;'/&#0#*;'&&&#/,#;Å/#$+\")(\"'#&'#&/,$;E/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),A(";t.# &;w"),A("%3į\"\"5%7İ/5#;</,$;Ç/#$+#)(#'#(\"'#&'#"),A("%;I/' 8!:ı!! )"),A("%3Ĳ\"\"5&7ĳ/:#;</1$;I/($8#:Ĵ#! )(#'#(\"'#&'#"),A('%3ĵ""5%7Ķ/]#;</T$%3ķ""5$7ĸ/& 8!:Ĺ! ).4 &%3ĺ""5%7Ļ/& 8!:ļ! )/#$+#)(#\'#("\'#&\'#'),A('%3Ľ""5)7ľ/R#;</I$3Ŀ""5#7ŀ./ &3Ł""5(7ł.# &;6/($8#:Ń#! )(#\'#("\'#&\'#'),A('%3ń""5#7Ņ/#;</$;D/$%;Ì/e#$%2D""6D7E/,#;Ì/#$+")("\'#&\'#0<*%2D""6D7E/,#;Ì/#$+")("\'#&\'#&/#$+")("\'#&\'#/,$;E/#$+%)(%\'#($\'#(#\'#("\'#&\'#'),A('%3ņ""5(7Ň./ &3ň""5$7ŉ.# &;6/\' 8!:Ŋ!! )'),A("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A("%;Ï/G#;./>$;Ï/5$;./,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),A("%$;!/&#0#*;!&&&#/' 8!:ŋ!! )"),A("%;Ñ/]#$%;A/,#;Ñ/#$+\")(\"'#&'#06*%;A/,#;Ñ/#$+\")(\"'#&'#&/'$8\":Ō\" )(\"'#&'#"),A("%;/]#$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/'$8\":ō\" )(\"'#&'#"),A('%;L.O &;.I &%;@." &"/:#;t/1$;?." &"/#$+#)(#\'#("\'#&\'#/]#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/\'$8":Ŏ" )("\'#&\'#'),A("%;Ô/]#$%;B/,#;Õ/#$+\")(\"'#&'#06*%;B/,#;Õ/#$+\")(\"'#&'#&/'$8\":ŏ\" )(\"'#&'#"),A("%;/& 8!:Ő! )"),A('%3ő""5(7Œ/:#;</1$;6/($8#:œ#! )(#\'#("\'#&\'#.g &%3Ŕ""5&7ŕ/:#;</1$;6/($8#:Ŗ#! )(#\'#("\'#&\'#.: &%3ŗ""5*7Ř/& 8!:ř! ).# &; '),A('%%;6/k#$%;A/2#;6/)$8":Ś""$ )("\'#&\'#0<*%;A/2#;6/)$8":Ś""$ )("\'#&\'#&/)$8":ś""! )("\'#&\'#." &"/\' 8!:Ŝ!! )'),A("%;Ø/Y#$%;A/,#;Ø/#$+\")(\"'#&'#06*%;A/,#;Ø/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A("%;/Y#$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A("%$;!/&#0#*;!&&&#/' 8!:ŝ!! )"),A("%;Û/Y#$%;B/,#;Ü/#$+\")(\"'#&'#06*%;B/,#;Ü/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A('%3Ş""5&7ş.; &3Š""5\'7š./ &3Ţ""5*7ţ.# &;6/& 8!:Ť! )'),A("%3ť\"\"5&7Ŧ/:#;</1$;Ý/($8#:ŧ#! )(#'#(\"'#&'#.} &%3õ\"\"5'7ö/:#;</1$;/($8#:Ũ#! )(#'#(\"'#&'#.P &%3ũ\"\"5+7Ū/:#;</1$;/($8#:ū#! )(#'#(\"'#&'#.# &; "),A('3Ŭ""5+7ŭ.k &3Ů""5)7ů._ &3Ű""5(7ű.S &3Ų""5\'7ų.G &3Ŵ""5&7ŵ.; &3Ŷ""5*7ŷ./ &3Ÿ""5)7Ź.# &;6'),A(';1." &"'),A('%%;6/k#$%;A/2#;6/)$8":Ś""$ )("\'#&\'#0<*%;A/2#;6/)$8":Ś""$ )("\'#&\'#&/)$8":ś""! )("\'#&\'#." &"/\' 8!:ź!! )'),A("%;L.# &;/]#$%;B/,#;á/#$+\")(\"'#&'#06*%;B/,#;á/#$+\")(\"'#&'#&/'$8\":Ż\" )(\"'#&'#"),A(";¹.# &; "),A("%;ã/Y#$%;A/,#;ã/#$+\")(\"'#&'#06*%;A/,#;ã/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),A("%;ê/k#;./b$;í/Y$$%;B/,#;ä/#$+\")(\"'#&'#06*%;B/,#;ä/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),A(";å.; &;æ.5 &;ç./ &;è.) &;é.# &; "),A("%3ż\"\"5#7Ž/:#;</1$;ð/($8#:ž#! )(#'#(\"'#&'#"),A("%3ſ\"\"5%7ƀ/:#;</1$;T/($8#:Ɓ#! )(#'#(\"'#&'#"),A("%3Ƃ\"\"5(7ƃ/F#;</=$;\\.) &;Y.# &;X/($8#:Ƅ#! )(#'#(\"'#&'#"),A("%3ƅ\"\"5&7Ɔ/:#;</1$;6/($8#:Ƈ#! )(#'#(\"'#&'#"),A("%3ƈ\"\"5%7Ɖ/A#;</8$$;!0#*;!&/($8#:Ɗ#! )(#'#(\"'#&'#"),A("%;ë/G#;;/>$;6/5$;;/,$;ì/#$+%)(%'#($'#(#'#(\"'#&'#"),A('%3""5#7Ó.# &;6/\' 8!:Ƌ!! )'),A('%3±""5#7ƌ.G &3³""5#7ƍ.; &3·""5#7Ǝ./ &3µ""5$7Ə.# &;6/\' 8!:Ɛ!! )'),A('%;î/D#%;C/,#;ï/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),A("%;U.) &;\\.# &;X/& 8!:Ƒ! )"),A('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:ƒ!! )'),A('%%;!/?#;!." &"/1$;!." &"/#$+#)(#\'#("\'#&\'#/\' 8!:Ɠ!! )'),A(";¾"),A('%;/^#$%;B/,#;ó/#$+")("\'#&\'#06*%;B/,#;ó/#$+")("\'#&\'#&/($8":Ɣ"!!)("\'#&\'#'),A(";ô.# &; "),A('%2ƕ""6ƕ7Ɩ/L#;</C$2Ɨ""6Ɨ7Ƙ.) &2ƙ""6ƙ7ƚ/($8#:ƛ#! )(#\'#("\'#&\'#'),A('%;/^#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/($8":Ɯ"!!)("\'#&\'#'),A("%;6/5#;0/,$;÷/#$+#)(#'#(\"'#&'#"),A("$;2.) &;4.# &;.0/*;2.) &;4.# &;.&"),A("$;%0#*;%&"),A("%;ú/;#28\"\"6879/,$;û/#$+#)(#'#(\"'#&'#"),A('%3Ɲ""5%7ƞ.) &3Ɵ""5$7Ơ/\' 8!:ơ!! )'),A('%;ü/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),A("%;\\.) &;X.# &;/' 8!:Ƣ!! )"),A(';".S &;!.M &2F""6F7G.A &2J""6J7K.5 &2H""6H7I.) &2N""6N7O'),A('2L""6L7M. &2B""6B7C. &2<""6<7=.} &2R""6R7S.q &2T""6T7U.e &2V""6V7W.Y &2P""6P7Q.M &2@""6@7A.A &2D""6D7E.5 &22""6273.) &2>""6>7?'),A('%;Ā/b#28""6879/S$;û/J$%2ƣ""6ƣ7Ƥ/,#;ì/#$+")("\'#&\'#." &"/#$+$)($\'#(#\'#("\'#&\'#'),A('%3ƥ""5%7Ʀ.) &3Ƨ""5$7ƨ/\' 8!:ơ!! )'),A('%3±""5#7².6 &3³""5#7´.* &$;+0#*;+&/\' 8!:Ʃ!! )'),A("%;Ą/#2F\"\"6F7G/x$;ă/o$2F\"\"6F7G/`$;ă/W$2F\"\"6F7G/H$;ă/?$2F\"\"6F7G/0$;ą/'$8):ƪ) )()'#(('#(''#(&'#(%'#($'#(#'#(\"'#&'#"),A("%;#/>#;#/5$;#/,$;#/#$+$)($'#(#'#(\"'#&'#"),A("%;ă/,#;ă/#$+\")(\"'#&'#"),A("%;ă/5#;ă/,$;ă/#$+#)(#'#(\"'#&'#"),A("%;q/T#$;m0#*;m&/D$%; /,#;ø/#$+\")(\"'#&'#.\" &\"/#$+#)(#'#(\"'#&'#"),A('%2ƫ""6ƫ7Ƭ.) &2ƭ""6ƭ7Ʈ/w#;0/n$;Ĉ/e$$%;B/2#;ĉ.# &; /#$+")("\'#&\'#0<*%;B/2#;ĉ.# &; /#$+")("\'#&\'#&/#$+$)($\'#(#\'#("\'#&\'#'),A(";.# &;L"),A("%2Ư\"\"6Ư7ư/5#;</,$;Ċ/#$+#)(#'#(\"'#&'#"),A("%;D/S#;,/J$2:\"\"6:7;/;$;,.# &;T/,$;E/#$+%)(%'#($'#(#'#(\"'#&'#")],p=0,h=0,g=[{line:1,column:1}],f=0,m=[],v=0;if(void 0!==t.startRule){if(!(t.startRule in c))throw new Error("Can't start parsing from rule \""+t.startRule+'".');u=c[t.startRule]}function S(){return e.substring(h,p)}function T(){return E(h,p)}function y(e,t){return{type:"literal",text:e,ignoreCase:t}}function _(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function b(t){var r,s=g[t];if(s)return s;for(r=t-1;!g[r];)r--;for(s={line:(s=g[r]).line,column:s.column};r<t;)10===e.charCodeAt(r)?(s.line++,s.column=1):s.column++,r++;return g[t]=s,s}function E(e,t){var r=b(e),s=b(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:s.line,column:s.column}}}function C(e){p<f||(p>f&&(f=p,m=[]),m.push(e))}function A(e){return e.split("").map((function(e){return e.charCodeAt(0)-32}))}if(t.data={},(s=function t(r){for(var s,i=l[r],n=0,o=[],c=i.length,u=[],g=[];;){for(;n<c;)switch(i[n]){case 0:g.push(d[i[n+1]]),n+=2;break;case 1:g.push(void 0),n++;break;case 2:g.push(null),n++;break;case 3:g.push(a),n++;break;case 4:g.push([]),n++;break;case 5:g.push(p),n++;break;case 6:g.pop(),n++;break;case 7:p=g.pop(),n++;break;case 8:g.length-=i[n+1],n+=2;break;case 9:g.splice(-2,1),n++;break;case 10:g[g.length-2].push(g.pop()),n++;break;case 11:g.push(g.splice(g.length-i[n+1],i[n+1])),n+=2;break;case 12:g.push(e.substring(g.pop(),p)),n++;break;case 13:u.push(c),o.push(n+3+i[n+1]+i[n+2]),g[g.length-1]?(c=n+3+i[n+1],n+=3):(c=n+3+i[n+1]+i[n+2],n+=3+i[n+1]);break;case 14:u.push(c),o.push(n+3+i[n+1]+i[n+2]),g[g.length-1]===a?(c=n+3+i[n+1],n+=3):(c=n+3+i[n+1]+i[n+2],n+=3+i[n+1]);break;case 15:u.push(c),o.push(n+3+i[n+1]+i[n+2]),g[g.length-1]!==a?(c=n+3+i[n+1],n+=3):(c=n+3+i[n+1]+i[n+2],n+=3+i[n+1]);break;case 16:g[g.length-1]!==a?(u.push(c),o.push(n),c=n+2+i[n+1],n+=2):n+=2+i[n+1];break;case 17:u.push(c),o.push(n+3+i[n+1]+i[n+2]),e.length>p?(c=n+3+i[n+1],n+=3):(c=n+3+i[n+1]+i[n+2],n+=3+i[n+1]);break;case 18:u.push(c),o.push(n+4+i[n+2]+i[n+3]),e.substr(p,d[i[n+1]].length)===d[i[n+1]]?(c=n+4+i[n+2],n+=4):(c=n+4+i[n+2]+i[n+3],n+=4+i[n+2]);break;case 19:u.push(c),o.push(n+4+i[n+2]+i[n+3]),e.substr(p,d[i[n+1]].length).toLowerCase()===d[i[n+1]]?(c=n+4+i[n+2],n+=4):(c=n+4+i[n+2]+i[n+3],n+=4+i[n+2]);break;case 20:u.push(c),o.push(n+4+i[n+2]+i[n+3]),d[i[n+1]].test(e.charAt(p))?(c=n+4+i[n+2],n+=4):(c=n+4+i[n+2]+i[n+3],n+=4+i[n+2]);break;case 21:g.push(e.substr(p,i[n+1])),p+=i[n+1],n+=2;break;case 22:g.push(d[i[n+1]]),p+=d[i[n+1]].length,n+=2;break;case 23:g.push(a),0===v&&C(d[i[n+1]]),n+=2;break;case 24:h=g[g.length-1-i[n+1]],n+=2;break;case 25:h=p,n++;break;case 26:s=i.slice(n+4,n+4+i[n+3]).map((function(e){return g[g.length-1-e]})),g.splice(g.length-i[n+2],i[n+2],d[i[n+1]].apply(null,s)),n+=4+i[n+3];break;case 27:g.push(t(i[n+1])),n+=2;break;case 28:v++,n++;break;case 29:v--,n++;break;default:throw new Error("Invalid opcode: "+i[n]+".")}if(!(u.length>0))break;c=u.pop(),n=o.pop()}return g[0]}(u))!==a&&p===e.length)return s;throw s!==a&&p<e.length&&C({type:"end"}),i=m,n=f<e.length?e.charAt(f):null,o=f<e.length?E(f,f+1):E(f,f),new r(r.buildMessage(i,n),i,n,o)}}));unwrapExports(grammar);var grammar_1=grammar.SyntaxError,grammar_2=grammar.parse,grammar$1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=tslib_es6.__importStar(grammar);!function(e){e.parse=function(e,t){var s={startRule:t};try{r.parse(e,s)}catch(e){s.data=-1}return s.data},e.nameAddrHeaderParse=function(t){var r=e.parse(t,"Name_Addr_Header");return-1!==r?r:void 0},e.URIParse=function(t){var r=e.parse(t,"SIP_URI");return-1!==r?r:void 0}}(t.Grammar||(t.Grammar={}))}));unwrapExports(grammar$1);var grammar_1$1=grammar$1.Grammar,utils=createCommonjsModule((function(e,t){function r(e,t){void 0===t&&(t=32);for(var r="",s=0;s<e;s++){r+=Math.floor(Math.random()*t).toString(t)}return r}Object.defineProperty(t,"__esModule",{value:!0}),t.createRandomToken=r,t.getReasonPhrase=function(e){return s[e]||""},t.newTag=function(){return r(10)},t.headerize=function(e){for(var t={"Call-Id":"Call-ID",Cseq:"CSeq","Min-Se":"Min-SE",Rack:"RAck",Rseq:"RSeq","Www-Authenticate":"WWW-Authenticate"},r=e.toLowerCase().replace(/_/g,"-").split("-"),s=r.length,i="",n=0;n<s;n++)0!==n&&(i+="-"),i+=r[n].charAt(0).toUpperCase()+r[n].substring(1);return t[i]&&(i=t[i]),i},t.str_utf8_length=function(e){return encodeURIComponent(e).replace(/%[A-F\d]{2}/g,"U").length};var s={100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"}}));unwrapExports(utils);var utils_1=utils.createRandomToken,utils_2=utils.getReasonPhrase,utils_3=utils.newTag,utils_4=utils.headerize,utils_5=utils.str_utf8_length,incomingMessage=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.headers={}}return e.prototype.addHeader=function(e,t){var r={raw:t};e=utils.headerize(e),this.headers[e]?this.headers[e].push(r):this.headers[e]=[r]},e.prototype.getHeader=function(e){var t=this.headers[utils.headerize(e)];if(t)return t[0]?t[0].raw:void 0},e.prototype.getHeaders=function(e){var t=this.headers[utils.headerize(e)],r=[];if(!t)return[];for(var s=0,i=t;s<i.length;s++){var n=i[s];r.push(n.raw)}return r},e.prototype.hasHeader=function(e){return!!this.headers[utils.headerize(e)]},e.prototype.parseHeader=function(e,t){if(void 0===t&&(t=0),e=utils.headerize(e),this.headers[e]&&!(t>=this.headers[e].length)){var r=this.headers[e][t],s=r.raw;if(r.parsed)return r.parsed;var i=grammar$1.Grammar.parse(s,e.replace(/-/g,"_"));return-1===i?void this.headers[e].splice(t,1):(r.parsed=i,i)}},e.prototype.s=function(e,t){return void 0===t&&(t=0),this.parseHeader(e,t)},e.prototype.setHeader=function(e,t){this.headers[utils.headerize(e)]=[{raw:t}]},e.prototype.toString=function(){return this.data},e}();t.IncomingMessage=r}));unwrapExports(incomingMessage);var incomingMessage_1=incomingMessage.IncomingMessage,incomingRequestMessage=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(){return e.call(this)||this}return tslib_es6.__extends(t,e),t}(incomingMessage.IncomingMessage);t.IncomingRequestMessage=r}));unwrapExports(incomingRequestMessage);var incomingRequestMessage_1=incomingRequestMessage.IncomingRequestMessage,incomingResponseMessage=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(){var t=e.call(this)||this;return t.headers={},t}return tslib_es6.__extends(t,e),t}(incomingMessage.IncomingMessage);t.IncomingResponseMessage=r}));unwrapExports(incomingResponseMessage);var incomingResponseMessage_1=incomingResponseMessage.IncomingResponseMessage,outgoingRequestMessage=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(t,r,s,i,n,o,a){this.headers={},this.extraHeaders=[],this.options=e.getDefaultOptions(),n&&(this.options=tslib_es6.__assign({},this.options,n),this.options.optionTags&&this.options.optionTags.length&&(this.options.optionTags=this.options.optionTags.slice()),this.options.routeSet&&this.options.routeSet.length&&(this.options.routeSet=this.options.routeSet.slice())),o&&o.length&&(this.extraHeaders=o.slice()),a&&(this.body={body:a.content,contentType:a.contentType}),this.method=t,this.ruri=r.clone(),this.fromURI=s.clone(),this.fromTag=this.options.fromTag?this.options.fromTag:utils.newTag(),this.from=e.makeNameAddrHeader(this.fromURI,this.options.fromDisplayName,this.fromTag),this.toURI=i.clone(),this.toTag=this.options.toTag,this.to=e.makeNameAddrHeader(this.toURI,this.options.toDisplayName,this.toTag),this.callId=this.options.callId?this.options.callId:this.options.callIdPrefix+utils.createRandomToken(15),this.cseq=this.options.cseq,this.setHeader("route",this.options.routeSet),this.setHeader("via",""),this.setHeader("to",this.to.toString()),this.setHeader("from",this.from.toString()),this.setHeader("cseq",this.cseq+" "+this.method),this.setHeader("X-Callid",this.callId),this.setHeader("call-id",this.callId),this.setHeader("max-forwards","70")}return e.getDefaultOptions=function(){return{callId:"",callIdPrefix:"",cseq:1,toDisplayName:"",toTag:"",fromDisplayName:"",fromTag:"",forceRport:!1,hackViaTcp:!1,optionTags:["outbound"],routeSet:[],userAgentString:"sip.js",viaHost:""}},e.makeNameAddrHeader=function(e,t,r){var s={};return r&&(s.tag=r),new nameAddrHeader.NameAddrHeader(e,t,s)},e.prototype.getHeader=function(e){var t=this.headers[utils.headerize(e)];if(t){if(t[0])return t[0]}else for(var r=new RegExp("^\\s*"+e+"\\s*:","i"),s=0,i=this.extraHeaders;s<i.length;s++){var n=i[s];if(r.test(n))return n.substring(n.indexOf(":")+1).trim()}},e.prototype.getHeaders=function(e){var t=[],r=this.headers[utils.headerize(e)];if(r)for(var s=0,i=r;s<i.length;s++){var n=i[s];t.push(n)}else for(var o=new RegExp("^\\s*"+e+"\\s*:","i"),a=0,c=this.extraHeaders;a<c.length;a++){var u=c[a];o.test(u)&&t.push(u.substring(u.indexOf(":")+1).trim())}return t},e.prototype.hasHeader=function(e){if(this.headers[utils.headerize(e)])return!0;for(var t=new RegExp("^\\s*"+e+"\\s*:","i"),r=0,s=this.extraHeaders;r<s.length;r++){var i=s[r];if(t.test(i))return!0}return!1},e.prototype.setHeader=function(e,t){this.headers[utils.headerize(e)]=t instanceof Array?t:[t]},e.prototype.setViaHeader=function(e,t){void 0===t&&(t="WSS"),this.options.hackViaTcp&&(t="TCP");var r="SIP/2.0/"+t;r+=" "+this.options.viaHost+";branch="+e,this.options.forceRport&&(r+=";rport"),this.setHeader("via",r),this.branch=e},e.prototype.toString=function(){var e="";for(var t in e+=this.method+" "+this.ruri.toRaw()+" SIP/2.0\r\n",this.headers)if(this.headers[t])for(var r=0,s=this.headers[t];r<s.length;r++){e+=t+": "+s[r]+"\r\n"}for(var i=0,n=this.extraHeaders;i<n.length;i++){e+=(t=n[i]).trim()+"\r\n"}return e+="Supported: "+this.options.optionTags.join(", ")+"\r\n",e+="User-Agent: "+this.options.userAgentString+"\r\n",this.body?"string"==typeof this.body?(e+="Content-Length: "+utils.str_utf8_length(this.body)+"\r\n\r\n",e+=this.body):this.body.body&&this.body.contentType?(e+="Content-Type: "+this.body.contentType+"\r\n",e+="Content-Length: "+utils.str_utf8_length(this.body.body)+"\r\n\r\n",e+=this.body.body):e+="Content-Length: 0\r\n\r\n":e+="Content-Length: 0\r\n\r\n",e},e}();t.OutgoingRequestMessage=r}));unwrapExports(outgoingRequestMessage);var outgoingRequestMessage_1=outgoingRequestMessage.OutgoingRequestMessage,body=createCommonjsModule((function(e,t){function r(e){return!(!e||"string"!=typeof e.content||"string"!=typeof e.contentType||void 0!==e.contentDisposition)||"string"==typeof e.contentDisposition}function s(e){return"application/sdp"===e?"session":"render"}Object.defineProperty(t,"__esModule",{value:!0}),t.fromBodyLegacy=function(e){var t="string"==typeof e?e:e.body,r="string"==typeof e?"application/sdp":e.contentType;return{contentDisposition:s(r),contentType:r,content:t}},t.getBody=function(e){var t,i,n,o;if(e instanceof incomingRequestMessage.IncomingRequestMessage&&e.body&&(t=(o=e.parseHeader("Content-Disposition"))?o.type:void 0,i=e.parseHeader("Content-Type"),n=e.body),e instanceof incomingResponseMessage.IncomingResponseMessage&&e.body&&(t=(o=e.parseHeader("Content-Disposition"))?o.type:void 0,i=e.parseHeader("Content-Type"),n=e.body),e instanceof outgoingRequestMessage.OutgoingRequestMessage&&e.body)if(t=e.getHeader("Content-Disposition"),i=e.getHeader("Content-Type"),"string"==typeof e.body){if(!i)throw new Error("Header content type header does not equal body content type.");n=e.body}else{if(i&&i!==e.body.contentType)throw new Error("Header content type header does not equal body content type.");i=e.body.contentType,n=e.body.body}if(r(e)&&(t=e.contentDisposition,i=e.contentType,n=e.content),n){if(i&&!t&&(t=s(i)),!t)throw new Error("Content disposition undefined.");if(!i)throw new Error("Content type undefined.");return{contentDisposition:t,contentType:i,content:n}}},t.isBody=r}));unwrapExports(body);var body_1=body.fromBodyLegacy,body_2=body.getBody,body_3=body.isBody,core=createCommonjsModule((function(e,t){var r;e.exports=(r=r||function(e,t){var r=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),s={},i=s.lib={},n=i.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=i.WordArray=n.extend({init:function(e,r){e=this.words=e||[],this.sigBytes=r!=t?r:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,r=e.words,s=this.sigBytes,i=e.sigBytes;if(this.clamp(),s%4)for(var n=0;n<i;n++){var o=r[n>>>2]>>>24-n%4*8&255;t[s+n>>>2]|=o<<24-(s+n)%4*8}else for(n=0;n<i;n+=4)t[s+n>>>2]=r[n>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=n.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r,s=[],i=function(t){var r=987654321,s=4294967295;return function(){var i=((r=36969*(65535&r)+(r>>16)&s)<<16)+(t=18e3*(65535&t)+(t>>16)&s)&s;return i/=4294967296,(i+=.5)*(e.random()>.5?1:-1)}},n=0;n<t;n+=4){var a=i(4294967296*(r||e.random()));r=987654071*a(),s.push(4294967296*a()|0)}return new o.init(s,t)}}),a=s.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,s=[],i=0;i<r;i++){var n=t[i>>>2]>>>24-i%4*8&255;s.push((n>>>4).toString(16)),s.push((15&n).toString(16))}return s.join("")},parse:function(e){for(var t=e.length,r=[],s=0;s<t;s+=2)r[s>>>3]|=parseInt(e.substr(s,2),16)<<24-s%8*4;return new o.init(r,t/2)}},u=a.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,s=[],i=0;i<r;i++){var n=t[i>>>2]>>>24-i%4*8&255;s.push(String.fromCharCode(n))}return s.join("")},parse:function(e){for(var t=e.length,r=[],s=0;s<t;s++)r[s>>>2]|=(255&e.charCodeAt(s))<<24-s%4*8;return new o.init(r,t)}},d=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(u.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return u.parse(unescape(encodeURIComponent(e)))}},l=i.BufferedBlockAlgorithm=n.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,s=r.words,i=r.sigBytes,n=this.blockSize,a=i/(4*n),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*n,u=e.min(4*c,i);if(c){for(var d=0;d<c;d+=n)this._doProcessBlock(s,d);var l=s.splice(0,c);r.sigBytes-=u}return new o.init(l,u)},clone:function(){var e=n.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),p=(i.Hasher=l.extend({cfg:n.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new p.HMAC.init(e,r).finalize(t)}}}),s.algo={});return s}(Math),r)})),md5=createCommonjsModule((function(e,t){var r;e.exports=(r=core,function(e){var t=r,s=t.lib,i=s.WordArray,n=s.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0}();var c=o.MD5=n.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var s=t+r,i=e[s];e[s]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var n=this._hash.words,o=e[t+0],c=e[t+1],h=e[t+2],g=e[t+3],f=e[t+4],m=e[t+5],v=e[t+6],S=e[t+7],T=e[t+8],y=e[t+9],_=e[t+10],b=e[t+11],E=e[t+12],C=e[t+13],A=e[t+14],w=e[t+15],R=n[0],I=n[1],x=n[2],U=n[3];R=u(R,I,x,U,o,7,a[0]),U=u(U,R,I,x,c,12,a[1]),x=u(x,U,R,I,h,17,a[2]),I=u(I,x,U,R,g,22,a[3]),R=u(R,I,x,U,f,7,a[4]),U=u(U,R,I,x,m,12,a[5]),x=u(x,U,R,I,v,17,a[6]),I=u(I,x,U,R,S,22,a[7]),R=u(R,I,x,U,T,7,a[8]),U=u(U,R,I,x,y,12,a[9]),x=u(x,U,R,I,_,17,a[10]),I=u(I,x,U,R,b,22,a[11]),R=u(R,I,x,U,E,7,a[12]),U=u(U,R,I,x,C,12,a[13]),x=u(x,U,R,I,A,17,a[14]),R=d(R,I=u(I,x,U,R,w,22,a[15]),x,U,c,5,a[16]),U=d(U,R,I,x,v,9,a[17]),x=d(x,U,R,I,b,14,a[18]),I=d(I,x,U,R,o,20,a[19]),R=d(R,I,x,U,m,5,a[20]),U=d(U,R,I,x,_,9,a[21]),x=d(x,U,R,I,w,14,a[22]),I=d(I,x,U,R,f,20,a[23]),R=d(R,I,x,U,y,5,a[24]),U=d(U,R,I,x,A,9,a[25]),x=d(x,U,R,I,g,14,a[26]),I=d(I,x,U,R,T,20,a[27]),R=d(R,I,x,U,C,5,a[28]),U=d(U,R,I,x,h,9,a[29]),x=d(x,U,R,I,S,14,a[30]),R=l(R,I=d(I,x,U,R,E,20,a[31]),x,U,m,4,a[32]),U=l(U,R,I,x,T,11,a[33]),x=l(x,U,R,I,b,16,a[34]),I=l(I,x,U,R,A,23,a[35]),R=l(R,I,x,U,c,4,a[36]),U=l(U,R,I,x,f,11,a[37]),x=l(x,U,R,I,S,16,a[38]),I=l(I,x,U,R,_,23,a[39]),R=l(R,I,x,U,C,4,a[40]),U=l(U,R,I,x,o,11,a[41]),x=l(x,U,R,I,g,16,a[42]),I=l(I,x,U,R,v,23,a[43]),R=l(R,I,x,U,y,4,a[44]),U=l(U,R,I,x,E,11,a[45]),x=l(x,U,R,I,w,16,a[46]),R=p(R,I=l(I,x,U,R,h,23,a[47]),x,U,o,6,a[48]),U=p(U,R,I,x,S,10,a[49]),x=p(x,U,R,I,A,15,a[50]),I=p(I,x,U,R,m,21,a[51]),R=p(R,I,x,U,E,6,a[52]),U=p(U,R,I,x,g,10,a[53]),x=p(x,U,R,I,_,15,a[54]),I=p(I,x,U,R,c,21,a[55]),R=p(R,I,x,U,T,6,a[56]),U=p(U,R,I,x,w,10,a[57]),x=p(x,U,R,I,v,15,a[58]),I=p(I,x,U,R,C,21,a[59]),R=p(R,I,x,U,f,6,a[60]),U=p(U,R,I,x,b,10,a[61]),x=p(x,U,R,I,h,15,a[62]),I=p(I,x,U,R,y,21,a[63]),n[0]=n[0]+R|0,n[1]=n[1]+I|0,n[2]=n[2]+x|0,n[3]=n[3]+U|0},_doFinalize:function(){var t=this._data,r=t.words,s=8*this._nDataBytes,i=8*t.sigBytes;r[i>>>5]|=128<<24-i%32;var n=e.floor(s/4294967296),o=s;r[15+(i+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),r[14+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(r.length+1),this._process();for(var a=this._hash,c=a.words,u=0;u<4;u++){var d=c[u];c[u]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8)}return a},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});function u(e,t,r,s,i,n,o){var a=e+(t&r|~t&s)+i+o;return(a<<n|a>>>32-n)+t}function d(e,t,r,s,i,n,o){var a=e+(t&s|r&~s)+i+o;return(a<<n|a>>>32-n)+t}function l(e,t,r,s,i,n,o){var a=e+(t^r^s)+i+o;return(a<<n|a>>>32-n)+t}function p(e,t,r,s,i,n,o){var a=e+(r^(t|~s))+i+o;return(a<<n|a>>>32-n)+t}t.MD5=n._createHelper(c),t.HmacMD5=n._createHmacHelper(c)}(Math),r.MD5)})),digestAuthentication=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=tslib_es6.__importDefault(md5),s=function(){function e(e,t,r){this.logger=e.getLogger("sipjs.digestauthentication"),this.username=t,this.password=r,this.nc=0,this.ncHex="00000000"}return e.prototype.authenticate=function(e,t,r){if(this.algorithm=t.algorithm,this.realm=t.realm,this.nonce=t.nonce,this.opaque=t.opaque,this.stale=t.stale,this.algorithm){if("MD5"!==this.algorithm)return this.logger.warn("challenge with Digest algorithm different than 'MD5', authentication aborted"),!1}else this.algorithm="MD5";if(!this.realm)return this.logger.warn("challenge without Digest realm, authentication aborted"),!1;if(!this.nonce)return this.logger.warn("challenge without Digest nonce, authentication aborted"),!1;if(t.qop)if(t.qop.indexOf("auth")>-1)this.qop="auth";else{if(!(t.qop.indexOf("auth-int")>-1))return this.logger.warn("challenge without Digest qop different than 'auth' or 'auth-int', authentication aborted"),!1;this.qop="auth-int"}else this.qop=void 0;return this.method=e.method,this.uri=e.ruri,this.cnonce=utils.createRandomToken(12),this.nc+=1,this.updateNcHex(),4294967296===this.nc&&(this.nc=1,this.ncHex="00000001"),this.calculateResponse(r),!0},e.prototype.toString=function(){var e=[];if(!this.response)throw new Error("response field does not exist, cannot generate Authorization header");return e.push("algorithm="+this.algorithm),e.push('username="'+this.username+'"'),e.push('realm="'+this.realm+'"'),e.push('nonce="'+this.nonce+'"'),e.push('uri="'+this.uri+'"'),e.push('response="'+this.response+'"'),this.opaque&&e.push('opaque="'+this.opaque+'"'),this.qop&&(e.push("qop="+this.qop),e.push('cnonce="'+this.cnonce+'"'),e.push("nc="+this.ncHex)),"Digest "+e.join(", ")},e.prototype.updateNcHex=function(){var e=Number(this.nc).toString(16);this.ncHex="00000000".substr(0,8-e.length)+e},e.prototype.calculateResponse=function(e){var t,s=r.default(this.username+":"+this.realm+":"+this.password);"auth"===this.qop?(t=r.default(this.method+":"+this.uri),this.response=r.default(s+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+t)):"auth-int"===this.qop?(t=r.default(this.method+":"+this.uri+":"+r.default(e||"")),this.response=r.default(s+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+t)):void 0===this.qop&&(t=r.default(this.method+":"+this.uri),this.response=r.default(s+":"+this.nonce+":"+t))},e}();t.DigestAuthentication=s}));unwrapExports(digestAuthentication);var digestAuthentication_1=digestAuthentication.DigestAuthentication,outgoingResponse=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.constructOutgoingResponse=function(e,t){var r="\r\n";if(t.statusCode<100||t.statusCode>699)throw new TypeError("Invalid statusCode: "+t.statusCode);var s=t.reasonPhrase?t.reasonPhrase:utils.getReasonPhrase(t.statusCode),i="SIP/2.0 "+t.statusCode+" "+s+r;t.statusCode>=100&&t.statusCode,t.statusCode;var n="From: "+e.getHeader("From")+r,o="Call-ID: "+e.callId+r,a="CSeq: "+e.cseq+" "+e.method+r,c=e.getHeaders("via").reduce((function(e,t){return e+"Via: "+t+r}),""),u="To: "+e.getHeader("to");if(t.statusCode>100&&!e.parseHeader("to").hasParam("tag")){var d=t.toTag;d||(d=utils.newTag()),u+=";tag="+d}u+=r;var l="";t.supported&&(l="Supported: "+t.supported.join(", ")+r);var p="";t.userAgent&&(p="User-Agent: "+t.userAgent+r);var h="";return t.extraHeaders&&(h=t.extraHeaders.reduce((function(e,t){return e+t.trim()+r}),"")),i+=c,i+=n,i+=u,i+=a,i+=o,i+=l,i+=p,i+=h,t.body?(i+="Content-Type: "+t.body.contentType+r,i+="Content-Length: "+utils.str_utf8_length(t.body.content)+r+r,i+=t.body.content):i+="Content-Length: 0\r\n\r\n",{message:i}}}));unwrapExports(outgoingResponse);var outgoingResponse_1=outgoingResponse.constructOutgoingResponse,messages=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(methods,t),tslib_es6.__exportStar(body,t),tslib_es6.__exportStar(digestAuthentication,t),tslib_es6.__exportStar(grammar$1,t),tslib_es6.__exportStar(incomingMessage,t),tslib_es6.__exportStar(incomingRequestMessage,t),tslib_es6.__exportStar(incomingResponseMessage,t),tslib_es6.__exportStar(nameAddrHeader,t),tslib_es6.__exportStar(outgoingRequestMessage,t),tslib_es6.__exportStar(outgoingResponse,t),tslib_es6.__exportStar(parameters,t),tslib_es6.__exportStar(uri,t)}));unwrapExports(messages);var dialog=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.core=e,this.dialogState=t,this.core.dialogs.set(this.id,this)}return e.initialDialogStateForUserAgentClient=function(e,t){var r=t.getHeaders("record-route").reverse(),s=t.parseHeader("contact");if(!s)throw new Error("Contact undefined.");if(!(s instanceof messages.NameAddrHeader))throw new Error("Contact not instance of NameAddrHeader.");var i=s.uri,n=e.cseq,o=e.callId,a=e.fromTag,c=t.toTag;if(!o)throw new Error("Call id undefined.");if(!a)throw new Error("From tag undefined.");if(!c)throw new Error("To tag undefined.");if(!e.from)throw new Error("From undefined.");if(!e.to)throw new Error("To undefined.");var u=e.from.uri,d=e.to.uri;if(!t.statusCode)throw new Error("Incoming response status code undefined.");return{id:o+a+c,early:t.statusCode<200,callId:o,localTag:a,remoteTag:c,localSequenceNumber:n,remoteSequenceNumber:undefined,localURI:u,remoteURI:d,remoteTarget:i,routeSet:r,secure:!1}},e.initialDialogStateForUserAgentServer=function(e,t,r){void 0===r&&(r=!1);var s=e.getHeaders("record-route"),i=e.parseHeader("contact");if(!i)throw new Error("Contact undefined.");if(!(i instanceof messages.NameAddrHeader))throw new Error("Contact not instance of NameAddrHeader.");var n=i.uri,o=e.cseq,a=e.callId,c=t,u=e.fromTag,d=e.from.uri;return{id:a+c+u,early:r,callId:a,localTag:c,remoteTag:u,localSequenceNumber:undefined,remoteSequenceNumber:o,localURI:e.to.uri,remoteURI:d,remoteTarget:n,routeSet:s,secure:!1}},e.prototype.dispose=function(){this.core.dialogs.delete(this.id)},Object.defineProperty(e.prototype,"id",{get:function(){return this.dialogState.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"early",{get:function(){return this.dialogState.early},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"callId",{get:function(){return this.dialogState.callId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localTag",{get:function(){return this.dialogState.localTag},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteTag",{get:function(){return this.dialogState.remoteTag},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localSequenceNumber",{get:function(){return this.dialogState.localSequenceNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteSequenceNumber",{get:function(){return this.dialogState.remoteSequenceNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localURI",{get:function(){return this.dialogState.localURI},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteURI",{get:function(){return this.dialogState.remoteURI},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteTarget",{get:function(){return this.dialogState.remoteTarget},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"routeSet",{get:function(){return this.dialogState.routeSet},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"secure",{get:function(){return this.dialogState.secure},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userAgentCore",{get:function(){return this.core},enumerable:!0,configurable:!0}),e.prototype.confirm=function(){this.dialogState.early=!1},e.prototype.receiveRequest=function(e){if(e.method!==messages.C.ACK){if(this.remoteSequenceNumber){if(e.cseq<=this.remoteSequenceNumber)throw new Error("Out of sequence in dialog request. Did you forget to call sequenceGuard()?");this.dialogState.remoteSequenceNumber=e.cseq}this.remoteSequenceNumber||(this.dialogState.remoteSequenceNumber=e.cseq)}},e.prototype.recomputeRouteSet=function(e){this.dialogState.routeSet=e.getHeaders("record-route").reverse()},e.prototype.createOutgoingRequestMessage=function(e,t){var r,s=this.remoteURI,i=this.remoteTag,n=this.localURI,o=this.localTag,a=this.callId;r=t&&t.cseq?t.cseq:this.dialogState.localSequenceNumber?this.dialogState.localSequenceNumber+=1:this.dialogState.localSequenceNumber=1;var c=this.remoteTarget,u=this.routeSet,d=t&&t.extraHeaders,l=t&&t.body;return this.userAgentCore.makeOutgoingRequestMessage(e,c,n,s,{callId:a,cseq:r,fromTag:o,toTag:i,routeSet:u},d,l)},e.prototype.sequenceGuard=function(e){return e.method===messages.C.ACK||(!(this.remoteSequenceNumber&&e.cseq<=this.remoteSequenceNumber)||(this.core.replyStateless(e,{statusCode:500}),!1))},e}();t.Dialog=r}));unwrapExports(dialog);var dialog_1=dialog.Dialog,session=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Initial="Initial",e.Early="Early",e.AckWait="AckWait",e.Confirmed="Confirmed",e.Terminated="Terminated"}(t.SessionState||(t.SessionState={})),function(e){e.Initial="Initial",e.HaveLocalOffer="HaveLocalOffer",e.HaveRemoteOffer="HaveRemoteOffer",e.Stable="Stable",e.Closed="Closed"}(t.SignalingState||(t.SignalingState={}))}));unwrapExports(session);var session_1=session.SessionState,session_2=session.SignalingState,session$1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(session,t)}));unwrapExports(session$1);var timers=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=500,s=5e3;t.Timers={T1:r,T2:4e3,T4:s,TIMER_B:32e3,TIMER_D:0,TIMER_F:32e3,TIMER_H:32e3,TIMER_I:0,TIMER_J:0,TIMER_K:0,TIMER_L:32e3,TIMER_M:32e3,TIMER_N:32e3,PROVISIONAL_RESPONSE_INTERVAL:6e4}}));unwrapExports(timers);var timers_1=timers.Timers,exception=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t){var r=this.constructor,s=e.call(this,t)||this;return Object.setPrototypeOf(s,r.prototype),s}return tslib_es6.__extends(t,e),t}(Error);t.Exception=r}));unwrapExports(exception);var exception_1=exception.Exception,transactionStateError=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t){return e.call(this,t||"Transaction state error.")||this}return tslib_es6.__extends(t,e),t}(exception.Exception);t.TransactionStateError=r}));unwrapExports(transactionStateError);var transactionStateError_1=transactionStateError.TransactionStateError,transportError=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t){return e.call(this,t||"Unspecified transport error.")||this}return tslib_es6.__extends(t,e),t}(exception.Exception);t.TransportError=r}));unwrapExports(transportError);var transportError_1=transportError.TransportError,exceptions=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(exception,t),tslib_es6.__exportStar(transactionStateError,t),tslib_es6.__exportStar(transportError,t)}));unwrapExports(exceptions);var transaction=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i,n){var o=e.call(this)||this;return o._transport=t,o._user=r,o._id=s,o._state=i,o.logger=r.loggerFactory.getLogger(n,s),o.logger.debug("Constructing "+o.typeToString()+" with id "+o.id+"."),o}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.logger.debug("Destroyed "+this.typeToString()+" with id "+this.id+".")},Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"kind",{get:function(){throw new Error("Invalid kind.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transport",{get:function(){return this._transport},enumerable:!0,configurable:!0}),t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)},t.prototype.logTransportError=function(e,t){this.logger.error(e.message),this.logger.error("Transport error occurred in "+this.typeToString()+" with id "+this.id+"."),this.logger.error(t)},t.prototype.send=function(e){var t=this;return this.transport.send(e).catch((function(e){var r;if(!(e instanceof exceptions.TransportError))throw r=e&&"string"==typeof e.message?new exceptions.TransportError(e.message):new exceptions.TransportError,t.onTransportError(r),r;t.onTransportError(e)}))},t.prototype.setState=function(e){this.logger.debug('State change to "'+e+'" on '+this.typeToString()+" with id "+this.id+"."),this._state=e,this._user.onStateChange&&this._user.onStateChange(e),this.emit("stateChanged")},t.prototype.typeToString=function(){return"UnknownType"},t}(EventEmitter.EventEmitter);t.Transaction=r}));unwrapExports(transaction);var transaction_1=transaction.Transaction,clientTransaction=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(r,s,i,n,o){var a=e.call(this,s,i,t.makeId(r),n,o)||this;a._request=r,a.user=i;var c=s.server&&s.server.scheme?s.server.scheme:void 0;return r.setViaHeader(a.id,c),a}return tslib_es6.__extends(t,e),t.makeId=function(e){if("CANCEL"===e.method){if(!e.branch)throw new Error("Outgoing CANCEL request without a branch.");return e.branch}return"z9hG4bK"+Math.floor(1e7*Math.random())},Object.defineProperty(t.prototype,"request",{get:function(){return this._request},enumerable:!0,configurable:!0}),t.prototype.onRequestTimeout=function(){this.user.onRequestTimeout&&this.user.onRequestTimeout()},t}(transaction.Transaction);t.ClientTransaction=r}));unwrapExports(clientTransaction);var clientTransaction_1=clientTransaction.ClientTransaction,transactionState=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Accepted="Accepted",e.Calling="Calling",e.Completed="Completed",e.Confirmed="Confirmed",e.Proceeding="Proceeding",e.Terminated="Terminated",e.Trying="Trying"}(t.TransactionState||(t.TransactionState={}))}));unwrapExports(transactionState);var transactionState_1=transactionState.TransactionState,inviteClientTransaction=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,t,r,s,transactionState.TransactionState.Calling,"sip.transaction.ict")||this;return i.ackRetransmissionCache=new Map,i.B=setTimeout((function(){return i.timer_B()}),timers.Timers.TIMER_B),i.send(t.toString()).catch((function(e){i.logTransportError(e,"Failed to send initial outgoing request.")})),i}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.B&&(clearTimeout(this.B),this.B=void 0),this.D&&(clearTimeout(this.D),this.D=void 0),this.M&&(clearTimeout(this.M),this.M=void 0),e.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"kind",{get:function(){return"ict"},enumerable:!0,configurable:!0}),t.prototype.ackResponse=function(e){var t=this,r=e.toTag;if(!r)throw new Error("To tag undefined.");var s="z9hG4bK"+Math.floor(1e7*Math.random()),i=this.transport.server&&this.transport.server.scheme?this.transport.server.scheme:void 0;e.setViaHeader(s,i),this.ackRetransmissionCache.set(r,e),this.send(e.toString()).catch((function(e){t.logTransportError(e,"Failed to send ACK to 2xx response.")}))},t.prototype.receiveResponse=function(e){var t=this,r=e.statusCode;if(!r||r<100||r>699)throw new Error("Invalid status code "+r);switch(this.state){case transactionState.TransactionState.Calling:if(r>=100&&r<=199)return this.stateTransition(transactionState.TransactionState.Proceeding),void(this.user.receiveResponse&&this.user.receiveResponse(e));if(r>=200&&r<=299)return this.ackRetransmissionCache.set(e.toTag,void 0),this.stateTransition(transactionState.TransactionState.Accepted),void(this.user.receiveResponse&&this.user.receiveResponse(e));if(r>=300&&r<=699)return this.stateTransition(transactionState.TransactionState.Completed),this.ack(e),void(this.user.receiveResponse&&this.user.receiveResponse(e));break;case transactionState.TransactionState.Proceeding:if(r>=100&&r<=199)return void(this.user.receiveResponse&&this.user.receiveResponse(e));if(r>=200&&r<=299)return this.ackRetransmissionCache.set(e.toTag,void 0),this.stateTransition(transactionState.TransactionState.Accepted),void(this.user.receiveResponse&&this.user.receiveResponse(e));if(r>=300&&r<=699)return this.stateTransition(transactionState.TransactionState.Completed),this.ack(e),void(this.user.receiveResponse&&this.user.receiveResponse(e));break;case transactionState.TransactionState.Accepted:if(r>=200&&r<=299){if(!this.ackRetransmissionCache.has(e.toTag))return this.ackRetransmissionCache.set(e.toTag,void 0),void(this.user.receiveResponse&&this.user.receiveResponse(e));var s=this.ackRetransmissionCache.get(e.toTag);return s?void this.send(s.toString()).catch((function(e){t.logTransportError(e,"Failed to send retransmission of ACK to 2xx response.")})):void 0}break;case transactionState.TransactionState.Completed:if(r>=300&&r<=699)return void this.ack(e);break;case transactionState.TransactionState.Terminated:break;default:throw new Error("Invalid state "+this.state)}var i="Received unexpected "+r+" response while in state "+this.state+".";this.logger.warn(i)},t.prototype.onTransportError=function(e){this.user.onTransportError&&this.user.onTransportError(e),this.stateTransition(transactionState.TransactionState.Terminated,!0)},t.prototype.typeToString=function(){return"INVITE client transaction"},t.prototype.ack=function(e){var t=this,r=this.request.ruri,s=this.request.callId,i=this.request.cseq,n=this.request.getHeader("from"),o=e.getHeader("to"),a=this.request.getHeader("via"),c=this.request.getHeader("route");if(!n)throw new Error("From undefined.");if(!o)throw new Error("To undefined.");if(!a)throw new Error("Via undefined.");var u="ACK "+r+" SIP/2.0\r\n";c&&(u+="Route: "+c+"\r\n"),u+="Via: "+a+"\r\n",u+="To: "+o+"\r\n",u+="From: "+n+"\r\n",u+="Call-ID: "+s+"\r\n",u+="CSeq: "+i+" ACK\r\n",u+="Max-Forwards: 70\r\n",u+="Content-Length: 0\r\n\r\n",this.send(u).catch((function(e){t.logTransportError(e,"Failed to send ACK to non-2xx response.")}))},t.prototype.stateTransition=function(e,t){var r=this;void 0===t&&(t=!1);var s=function(){throw new Error("Invalid state transition from "+r.state+" to "+e)};switch(e){case transactionState.TransactionState.Calling:s();break;case transactionState.TransactionState.Proceeding:this.state!==transactionState.TransactionState.Calling&&s();break;case transactionState.TransactionState.Accepted:case transactionState.TransactionState.Completed:this.state!==transactionState.TransactionState.Calling&&this.state!==transactionState.TransactionState.Proceeding&&s();break;case transactionState.TransactionState.Terminated:this.state!==transactionState.TransactionState.Calling&&this.state!==transactionState.TransactionState.Accepted&&this.state!==transactionState.TransactionState.Completed&&(t||s());break;default:s()}this.B&&(clearTimeout(this.B),this.B=void 0),transactionState.TransactionState.Proceeding,e===transactionState.TransactionState.Completed&&(this.D=setTimeout((function(){return r.timer_D()}),timers.Timers.TIMER_D)),e===transactionState.TransactionState.Accepted&&(this.M=setTimeout((function(){return r.timer_M()}),timers.Timers.TIMER_M)),e===transactionState.TransactionState.Terminated&&this.dispose(),this.setState(e)},t.prototype.timer_A=function(){},t.prototype.timer_B=function(){this.logger.debug("Timer B expired for INVITE client transaction "+this.id+"."),this.state===transactionState.TransactionState.Calling&&(this.onRequestTimeout(),this.stateTransition(transactionState.TransactionState.Terminated))},t.prototype.timer_D=function(){this.logger.debug("Timer D expired for INVITE client transaction "+this.id+"."),this.state===transactionState.TransactionState.Completed&&this.stateTransition(transactionState.TransactionState.Terminated)},t.prototype.timer_M=function(){this.logger.debug("Timer M expired for INVITE client transaction "+this.id+"."),this.state===transactionState.TransactionState.Accepted&&this.stateTransition(transactionState.TransactionState.Terminated)},t}(clientTransaction.ClientTransaction);t.InviteClientTransaction=r}));unwrapExports(inviteClientTransaction);var inviteClientTransaction_1=inviteClientTransaction.InviteClientTransaction,serverTransaction=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i,n){var o=e.call(this,r,s,t.viaBranch,i,n)||this;return o._request=t,o.user=s,o}return tslib_es6.__extends(t,e),Object.defineProperty(t.prototype,"request",{get:function(){return this._request},enumerable:!0,configurable:!0}),t}(transaction.Transaction);t.ServerTransaction=r}));unwrapExports(serverTransaction);var serverTransaction_1=serverTransaction.ServerTransaction,inviteServerTransaction=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,t,r,s,transactionState.TransactionState.Proceeding,"sip.transaction.ist")||this}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.stopProgressExtensionTimer(),this.H&&(clearTimeout(this.H),this.H=void 0),this.I&&(clearTimeout(this.I),this.I=void 0),this.L&&(clearTimeout(this.L),this.L=void 0),e.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"kind",{get:function(){return"ist"},enumerable:!0,configurable:!0}),t.prototype.receiveRequest=function(e){var t=this;switch(this.state){case transactionState.TransactionState.Proceeding:if(e.method===messages.C.INVITE)return void(this.lastProvisionalResponse&&this.send(this.lastProvisionalResponse).catch((function(e){t.logTransportError(e,"Failed to send retransmission of provisional response.")})));break;case transactionState.TransactionState.Accepted:if(e.method===messages.C.INVITE)return;break;case transactionState.TransactionState.Completed:if(e.method===messages.C.INVITE){if(!this.lastFinalResponse)throw new Error("Last final response undefined.");return void this.send(this.lastFinalResponse).catch((function(e){t.logTransportError(e,"Failed to send retransmission of final response.")}))}if(e.method===messages.C.ACK)return void this.stateTransition(transactionState.TransactionState.Confirmed);break;case transactionState.TransactionState.Confirmed:case transactionState.TransactionState.Terminated:if(e.method===messages.C.INVITE||e.method===messages.C.ACK)return;break;default:throw new Error("Invalid state "+this.state)}var r="INVITE server transaction received unexpected "+e.method+" request while in state "+this.state+".";this.logger.warn(r)},t.prototype.receiveResponse=function(e,t){var r=this;if(e<100||e>699)throw new Error("Invalid status code "+e);switch(this.state){case transactionState.TransactionState.Proceeding:if(e>=100&&e<=199)return this.lastProvisionalResponse=t,e>100&&this.startProgressExtensionTimer(),void this.send(t).catch((function(e){r.logTransportError(e,"Failed to send 1xx response.")}));if(e>=200&&e<=299)return this.lastFinalResponse=t,this.stateTransition(transactionState.TransactionState.Accepted),void this.send(t).catch((function(e){r.logTransportError(e,"Failed to send 2xx response.")}));if(e>=300&&e<=699)return this.lastFinalResponse=t,this.stateTransition(transactionState.TransactionState.Completed),void this.send(t).catch((function(e){r.logTransportError(e,"Failed to send non-2xx final response.")}));break;case transactionState.TransactionState.Accepted:if(e>=200&&e<=299)return void this.send(t).catch((function(e){r.logTransportError(e,"Failed to send 2xx response.")}));break;case transactionState.TransactionState.Completed:case transactionState.TransactionState.Confirmed:case transactionState.TransactionState.Terminated:break;default:throw new Error("Invalid state "+this.state)}var s="INVITE server transaction received unexpected "+e+" response from TU while in state "+this.state+".";throw this.logger.error(s),new Error(s)},t.prototype.retransmitAcceptedResponse=function(){var e=this;this.state===transactionState.TransactionState.Accepted&&this.lastFinalResponse&&this.send(this.lastFinalResponse).catch((function(t){e.logTransportError(t,"Failed to send 2xx response.")}))},t.prototype.onTransportError=function(e){this.user.onTransportError&&this.user.onTransportError(e)},t.prototype.typeToString=function(){return"INVITE server transaction"},t.prototype.stateTransition=function(e){var t=this,r=function(){throw new Error("Invalid state transition from "+t.state+" to "+e)};switch(e){case transactionState.TransactionState.Proceeding:r();break;case transactionState.TransactionState.Accepted:case transactionState.TransactionState.Completed:this.state!==transactionState.TransactionState.Proceeding&&r();break;case transactionState.TransactionState.Confirmed:this.state!==transactionState.TransactionState.Completed&&r();break;case transactionState.TransactionState.Terminated:this.state!==transactionState.TransactionState.Accepted&&this.state!==transactionState.TransactionState.Completed&&this.state!==transactionState.TransactionState.Confirmed&&r();break;default:r()}this.stopProgressExtensionTimer(),e===transactionState.TransactionState.Accepted&&(this.L=setTimeout((function(){return t.timer_L()}),timers.Timers.TIMER_L)),e===transactionState.TransactionState.Completed&&(this.H=setTimeout((function(){return t.timer_H()}),timers.Timers.TIMER_H)),e===transactionState.TransactionState.Confirmed&&(this.I=setTimeout((function(){return t.timer_I()}),timers.Timers.TIMER_I)),e===transactionState.TransactionState.Terminated&&this.dispose(),this.setState(e)},t.prototype.startProgressExtensionTimer=function(){var e=this;void 0===this.progressExtensionTimer&&(this.progressExtensionTimer=setInterval((function(){if(e.logger.debug("Progress extension timer expired for INVITE server transaction "+e.id+"."),!e.lastProvisionalResponse)throw new Error("Last provisional response undefined.");e.send(e.lastProvisionalResponse).catch((function(t){e.logTransportError(t,"Failed to send retransmission of provisional response.")}))}),timers.Timers.PROVISIONAL_RESPONSE_INTERVAL))},t.prototype.stopProgressExtensionTimer=function(){void 0!==this.progressExtensionTimer&&(clearInterval(this.progressExtensionTimer),this.progressExtensionTimer=void 0)},t.prototype.timer_G=function(){},t.prototype.timer_H=function(){this.logger.debug("Timer H expired for INVITE server transaction "+this.id+"."),this.state===transactionState.TransactionState.Completed&&(this.logger.warn("ACK to negative final response was never received, terminating transaction."),this.stateTransition(transactionState.TransactionState.Terminated))},t.prototype.timer_I=function(){this.logger.debug("Timer I expired for INVITE server transaction "+this.id+"."),this.stateTransition(transactionState.TransactionState.Terminated)},t.prototype.timer_L=function(){this.logger.debug("Timer L expired for INVITE server transaction "+this.id+"."),this.state===transactionState.TransactionState.Accepted&&this.stateTransition(transactionState.TransactionState.Terminated)},t}(serverTransaction.ServerTransaction);t.InviteServerTransaction=r}));unwrapExports(inviteServerTransaction);var inviteServerTransaction_1=inviteServerTransaction.InviteServerTransaction,nonInviteClientTransaction=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,t,r,s,transactionState.TransactionState.Trying,"sip.transaction.nict")||this;return i.F=setTimeout((function(){return i.timer_F()}),timers.Timers.TIMER_F),i.send(t.toString()).catch((function(e){i.logTransportError(e,"Failed to send initial outgoing request.")})),i}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.F&&(clearTimeout(this.F),this.F=void 0),this.K&&(clearTimeout(this.K),this.K=void 0),e.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"kind",{get:function(){return"nict"},enumerable:!0,configurable:!0}),t.prototype.receiveResponse=function(e){var t=e.statusCode;if(!t||t<100||t>699)throw new Error("Invalid status code "+t);switch(this.state){case transactionState.TransactionState.Trying:if(t>=100&&t<=199)return this.stateTransition(transactionState.TransactionState.Proceeding),void(this.user.receiveResponse&&this.user.receiveResponse(e));if(t>=200&&t<=699)return this.stateTransition(transactionState.TransactionState.Completed),408===t?void this.onRequestTimeout():void(this.user.receiveResponse&&this.user.receiveResponse(e));break;case transactionState.TransactionState.Proceeding:if(t>=100&&t<=199&&this.user.receiveResponse)return this.user.receiveResponse(e);if(t>=200&&t<=699)return this.stateTransition(transactionState.TransactionState.Completed),408===t?void this.onRequestTimeout():void(this.user.receiveResponse&&this.user.receiveResponse(e));case transactionState.TransactionState.Completed:case transactionState.TransactionState.Terminated:return;default:throw new Error("Invalid state "+this.state)}var r="Non-INVITE client transaction received unexpected "+t+" response while in state "+this.state+".";this.logger.warn(r)},t.prototype.onTransportError=function(e){this.user.onTransportError&&this.user.onTransportError(e),this.stateTransition(transactionState.TransactionState.Terminated,!0)},t.prototype.typeToString=function(){return"non-INVITE client transaction"},t.prototype.stateTransition=function(e,t){var r=this;void 0===t&&(t=!1);var s=function(){throw new Error("Invalid state transition from "+r.state+" to "+e)};switch(e){case transactionState.TransactionState.Trying:s();break;case transactionState.TransactionState.Proceeding:this.state!==transactionState.TransactionState.Trying&&s();break;case transactionState.TransactionState.Completed:this.state!==transactionState.TransactionState.Trying&&this.state!==transactionState.TransactionState.Proceeding&&s();break;case transactionState.TransactionState.Terminated:this.state!==transactionState.TransactionState.Trying&&this.state!==transactionState.TransactionState.Proceeding&&this.state!==transactionState.TransactionState.Completed&&(t||s());break;default:s()}e===transactionState.TransactionState.Completed&&(this.F&&(clearTimeout(this.F),this.F=void 0),this.K=setTimeout((function(){return r.timer_K()}),timers.Timers.TIMER_K)),e===transactionState.TransactionState.Terminated&&this.dispose(),this.setState(e)},t.prototype.timer_F=function(){this.logger.debug("Timer F expired for non-INVITE client transaction "+this.id+"."),this.state!==transactionState.TransactionState.Trying&&this.state!==transactionState.TransactionState.Proceeding||(this.onRequestTimeout(),this.stateTransition(transactionState.TransactionState.Terminated))},t.prototype.timer_K=function(){this.state===transactionState.TransactionState.Completed&&this.stateTransition(transactionState.TransactionState.Terminated)},t}(clientTransaction.ClientTransaction);t.NonInviteClientTransaction=r}));unwrapExports(nonInviteClientTransaction);var nonInviteClientTransaction_1=nonInviteClientTransaction.NonInviteClientTransaction,nonInviteServerTransaction=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,t,r,s,transactionState.TransactionState.Trying,"sip.transaction.nist")||this}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.J&&(clearTimeout(this.J),this.J=void 0),e.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"kind",{get:function(){return"nist"},enumerable:!0,configurable:!0}),t.prototype.receiveRequest=function(e){var t=this;switch(this.state){case transactionState.TransactionState.Trying:break;case transactionState.TransactionState.Proceeding:if(!this.lastResponse)throw new Error("Last response undefined.");this.send(this.lastResponse).catch((function(e){t.logTransportError(e,"Failed to send retransmission of provisional response.")}));break;case transactionState.TransactionState.Completed:if(!this.lastResponse)throw new Error("Last response undefined.");this.send(this.lastResponse).catch((function(e){t.logTransportError(e,"Failed to send retransmission of final response.")}));break;case transactionState.TransactionState.Terminated:break;default:throw new Error("Invalid state "+this.state)}},t.prototype.receiveResponse=function(e,t){var r=this;if(e<100||e>699)throw new Error("Invalid status code "+e);if(e>100&&e<=199)throw new Error("Provisional response other than 100 not allowed.");switch(this.state){case transactionState.TransactionState.Trying:if(this.lastResponse=t,e>=100&&e<200)return this.stateTransition(transactionState.TransactionState.Proceeding),void this.send(t).catch((function(e){r.logTransportError(e,"Failed to send provisional response.")}));if(e>=200&&e<=699)return this.stateTransition(transactionState.TransactionState.Completed),void this.send(t).catch((function(e){r.logTransportError(e,"Failed to send final response.")}));break;case transactionState.TransactionState.Proceeding:if(this.lastResponse=t,e>=200&&e<=699)return this.stateTransition(transactionState.TransactionState.Completed),void this.send(t).catch((function(e){r.logTransportError(e,"Failed to send final response.")}));break;case transactionState.TransactionState.Completed:return;case transactionState.TransactionState.Terminated:break;default:throw new Error("Invalid state "+this.state)}var s="Non-INVITE server transaction received unexpected "+e+" response from TU while in state "+this.state+".";throw this.logger.error(s),new Error(s)},t.prototype.onTransportError=function(e){this.user.onTransportError&&this.user.onTransportError(e),this.stateTransition(transactionState.TransactionState.Terminated,!0)},t.prototype.typeToString=function(){return"non-INVITE server transaction"},t.prototype.stateTransition=function(e,t){var r=this;void 0===t&&(t=!1);var s=function(){throw new Error("Invalid state transition from "+r.state+" to "+e)};switch(e){case transactionState.TransactionState.Trying:s();break;case transactionState.TransactionState.Proceeding:this.state!==transactionState.TransactionState.Trying&&s();break;case transactionState.TransactionState.Completed:this.state!==transactionState.TransactionState.Trying&&this.state!==transactionState.TransactionState.Proceeding&&s();break;case transactionState.TransactionState.Terminated:this.state!==transactionState.TransactionState.Proceeding&&this.state!==transactionState.TransactionState.Completed&&(t||s());break;default:s()}e===transactionState.TransactionState.Completed&&(this.J=setTimeout((function(){return r.timer_J()}),timers.Timers.TIMER_J)),e===transactionState.TransactionState.Terminated&&this.dispose(),this.setState(e)},t.prototype.timer_J=function(){this.logger.debug("Timer J expired for NON-INVITE server transaction "+this.id+"."),this.state===transactionState.TransactionState.Completed&&this.stateTransition(transactionState.TransactionState.Terminated)},t}(serverTransaction.ServerTransaction);t.NonInviteServerTransaction=r}));unwrapExports(nonInviteServerTransaction);var nonInviteServerTransaction_1=nonInviteServerTransaction.NonInviteServerTransaction,transactions=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(clientTransaction,t),tslib_es6.__exportStar(inviteClientTransaction,t),tslib_es6.__exportStar(inviteServerTransaction,t),tslib_es6.__exportStar(nonInviteClientTransaction,t),tslib_es6.__exportStar(nonInviteServerTransaction,t),tslib_es6.__exportStar(inviteClientTransaction,t),tslib_es6.__exportStar(serverTransaction,t),tslib_es6.__exportStar(transactionState,t),tslib_es6.__exportStar(transaction,t)}));unwrapExports(transactions);var userAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r,s){this.transactionConstructor=e,this.core=t,this.message=r,this.delegate=s,this.challenged=!1,this.stale=!1,this.logger=this.loggerFactory.getLogger("sip.user-agent-client"),this.init()}return e.prototype.dispose=function(){this.transaction.dispose()},Object.defineProperty(e.prototype,"loggerFactory",{get:function(){return this.core.loggerFactory},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transaction",{get:function(){if(!this._transaction)throw new Error("Transaction undefined.");return this._transaction},enumerable:!0,configurable:!0}),e.prototype.cancel=function(t,r){var s=this;if(void 0===r&&(r={}),!this.transaction)throw new Error("Transaction undefined.");if(!this.message.to)throw new Error("To undefined.");if(!this.message.from)throw new Error("From undefined.");var i=this.core.makeOutgoingRequestMessage(messages.C.CANCEL,this.message.ruri,this.message.from.uri,this.message.to.uri,{toTag:this.message.toTag,fromTag:this.message.fromTag,callId:this.message.callId,cseq:this.message.cseq},r.extraHeaders);if(i.branch=this.message.branch,this.message.headers.Route&&(i.headers.Route=this.message.headers.Route),t&&i.setHeader("Reason",t),this.transaction.state===transactions.TransactionState.Proceeding)new e(transactions.NonInviteClientTransaction,this.core,i);else this.transaction.once("stateChanged",(function(){if(s.transaction&&s.transaction.state===transactions.TransactionState.Proceeding)new e(transactions.NonInviteClientTransaction,s.core,i)}));return i},e.prototype.authenticationGuard=function(e){var t,r,s=e.statusCode;if(!s)throw new Error("Response status code undefined.");if(401!==s&&407!==s)return!0;if(401===s?(t=e.parseHeader("www-authenticate"),r="authorization"):(t=e.parseHeader("proxy-authenticate"),r="proxy-authorization"),!t)return this.logger.warn(s+" with wrong or missing challenge, cannot authenticate"),!0;if(this.challenged&&(this.stale||!0!==t.stale))return this.logger.warn(s+" apparently in authentication loop, cannot authenticate"),!0;if(!this.credentials&&(this.credentials=this.core.configuration.authenticationFactory(),!this.credentials))return this.logger.warn("Unable to obtain credentials, cannot authenticate"),!0;if(!this.credentials.authenticate(this.message,t))return!0;this.challenged=!0,t.stale&&(this.stale=!0);var i=this.message.cseq+=1;return this.message.setHeader("cseq",i+" "+this.message.method),this.message.setHeader(r,this.credentials.toString()),this.init(),!1},e.prototype.receiveResponse=function(e){if(this.authenticationGuard(e)){var t=e.statusCode?e.statusCode.toString():"";if(!t)throw new Error("Response status code undefined.");switch(!0){case/^100$/.test(t):this.delegate&&this.delegate.onTrying&&this.delegate.onTrying({message:e});break;case/^1[0-9]{2}$/.test(t):this.delegate&&this.delegate.onProgress&&this.delegate.onProgress({message:e});break;case/^2[0-9]{2}$/.test(t):this.delegate&&this.delegate.onAccept&&this.delegate.onAccept({message:e});break;case/^3[0-9]{2}$/.test(t):this.delegate&&this.delegate.onRedirect&&this.delegate.onRedirect({message:e});break;case/^[4-6][0-9]{2}$/.test(t):this.delegate&&this.delegate.onReject&&this.delegate.onReject({message:e});break;default:throw new Error("Invalid status code "+t)}}},e.prototype.init=function(){var e=this,t={loggerFactory:this.loggerFactory,onRequestTimeout:function(){return e.onRequestTimeout()},onStateChange:function(t){t===transactions.TransactionState.Terminated&&(e.core.userAgentClients.delete(s),r===e._transaction&&e.dispose())},onTransportError:function(t){return e.onTransportError(t)},receiveResponse:function(t){return e.receiveResponse(t)}},r=new this.transactionConstructor(this.message,this.core.transport,t);this._transaction=r;var s=r.id+r.request.method;this.core.userAgentClients.set(s,this)},e.prototype.onRequestTimeout=function(){this.logger.warn("User agent client request timed out. Generating internal 408 Request Timeout.");var e=new messages.IncomingResponseMessage;e.statusCode=408,e.reasonPhrase="Request Timeout",this.receiveResponse(e)},e.prototype.onTransportError=function(e){this.logger.error(e.message),this.logger.error("User agent client request transport error. Generating internal 503 Service Unavailable.");var t=new messages.IncomingResponseMessage;t.statusCode=503,t.reasonPhrase="Service Unavailable",this.receiveResponse(t)},e}();t.UserAgentClient=r}));unwrapExports(userAgentClient);var userAgentClient_1=userAgentClient.UserAgentClient,byeUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i,n=t.createOutgoingRequestMessage(messages.C.BYE,s);return i=e.call(this,transactions.NonInviteClientTransaction,t.userAgentCore,n,r)||this,t.dispose(),i}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.ByeUserAgentClient=r}));unwrapExports(byeUserAgentClient);var byeUserAgentClient_1=byeUserAgentClient.ByeUserAgentClient,userAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r,s){this.transactionConstructor=e,this.core=t,this.message=r,this.delegate=s,this.logger=this.loggerFactory.getLogger("sip.user-agent-server"),this.toTag=r.toTag?r.toTag:utils.newTag(),this.init()}return e.prototype.dispose=function(){this.transaction.dispose()},Object.defineProperty(e.prototype,"loggerFactory",{get:function(){return this.core.loggerFactory},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transaction",{get:function(){if(!this._transaction)throw new Error("Transaction undefined.");return this._transaction},enumerable:!0,configurable:!0}),e.prototype.accept=function(e){if(void 0===e&&(e={statusCode:200}),!this.acceptable)throw new exceptions.TransactionStateError(this.message.method+" not acceptable in state "+this.transaction.state+".");var t=e.statusCode;if(t<200||t>299)throw new TypeError("Invalid statusCode: "+t);return this.reply(e)},e.prototype.progress=function(e){if(void 0===e&&(e={statusCode:180}),!this.progressable)throw new exceptions.TransactionStateError(this.message.method+" not progressable in state "+this.transaction.state+".");var t=e.statusCode;if(t<101||t>199)throw new TypeError("Invalid statusCode: "+t);return this.reply(e)},e.prototype.redirect=function(e,t){if(void 0===t&&(t={statusCode:302}),!this.redirectable)throw new exceptions.TransactionStateError(this.message.method+" not redirectable in state "+this.transaction.state+".");var r=t.statusCode;if(r<300||r>399)throw new TypeError("Invalid statusCode: "+r);var s=new Array;return e.forEach((function(e){return s.push("Contact: "+e.toString())})),t.extraHeaders=(t.extraHeaders||[]).concat(s),this.reply(t)},e.prototype.reject=function(e){if(void 0===e&&(e={statusCode:480}),!this.rejectable)throw new exceptions.TransactionStateError(this.message.method+" not rejectable in state "+this.transaction.state+".");var t=e.statusCode;if(t<400||t>699)throw new TypeError("Invalid statusCode: "+t);return this.reply(e)},e.prototype.trying=function(e){if(!this.tryingable)throw new exceptions.TransactionStateError(this.message.method+" not tryingable in state "+this.transaction.state+".");return this.reply({statusCode:100})},e.prototype.receiveCancel=function(e){this.delegate&&this.delegate.onCancel&&this.delegate.onCancel(e)},Object.defineProperty(e.prototype,"acceptable",{get:function(){if(this.transaction instanceof transactions.InviteServerTransaction)return this.transaction.state===transactions.TransactionState.Proceeding||this.transaction.state===transactions.TransactionState.Accepted;if(this.transaction instanceof transactions.NonInviteServerTransaction)return this.transaction.state===transactions.TransactionState.Trying||this.transaction.state===transactions.TransactionState.Proceeding;throw new Error("Unknown transaction type.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"progressable",{get:function(){if(this.transaction instanceof transactions.InviteServerTransaction)return this.transaction.state===transactions.TransactionState.Proceeding;if(this.transaction instanceof transactions.NonInviteServerTransaction)return!1;throw new Error("Unknown transaction type.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"redirectable",{get:function(){if(this.transaction instanceof transactions.InviteServerTransaction)return this.transaction.state===transactions.TransactionState.Proceeding;if(this.transaction instanceof transactions.NonInviteServerTransaction)return this.transaction.state===transactions.TransactionState.Trying||this.transaction.state===transactions.TransactionState.Proceeding;throw new Error("Unknown transaction type.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rejectable",{get:function(){if(this.transaction instanceof transactions.InviteServerTransaction)return this.transaction.state===transactions.TransactionState.Proceeding;if(this.transaction instanceof transactions.NonInviteServerTransaction)return this.transaction.state===transactions.TransactionState.Trying||this.transaction.state===transactions.TransactionState.Proceeding;throw new Error("Unknown transaction type.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tryingable",{get:function(){if(this.transaction instanceof transactions.InviteServerTransaction)return this.transaction.state===transactions.TransactionState.Proceeding;if(this.transaction instanceof transactions.NonInviteServerTransaction)return this.transaction.state===transactions.TransactionState.Trying;throw new Error("Unknown transaction type.")},enumerable:!0,configurable:!0}),e.prototype.reply=function(e){e.toTag||100===e.statusCode||(e.toTag=this.toTag),e.userAgent=e.userAgent||this.core.configuration.userAgentHeaderFieldValue,e.supported=e.supported||this.core.configuration.supportedOptionTagsResponse;var t=messages.constructOutgoingResponse(this.message,e);return this.transaction.receiveResponse(e.statusCode,t.message),t},e.prototype.init=function(){var e=this,t={loggerFactory:this.loggerFactory,onStateChange:function(t){t===transactions.TransactionState.Terminated&&(e.core.userAgentServers.delete(s),e.dispose())},onTransportError:function(t){e.logger.error(t.message),e.delegate&&e.delegate.onTransportError?e.delegate.onTransportError(t):e.logger.error("User agent server response transport error.")}},r=new this.transactionConstructor(this.message,this.core.transport,t);this._transaction=r;var s=r.id;this.core.userAgentServers.set(r.id,this)},e}();t.UserAgentServer=r}));unwrapExports(userAgentServer);var userAgentServer_1=userAgentServer.UserAgentServer,byeUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,transactions.NonInviteServerTransaction,t.userAgentCore,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentServer.UserAgentServer);t.ByeUserAgentServer=r}));unwrapExports(byeUserAgentServer);var byeUserAgentServer_1=byeUserAgentServer.ByeUserAgentServer,infoUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=t.createOutgoingRequestMessage(messages.C.INFO,s);return e.call(this,transactions.NonInviteClientTransaction,t.userAgentCore,i,r)||this}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.InfoUserAgentClient=r}));unwrapExports(infoUserAgentClient);var infoUserAgentClient_1=infoUserAgentClient.InfoUserAgentClient,infoUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,transactions.NonInviteServerTransaction,t.userAgentCore,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentServer.UserAgentServer);t.InfoUserAgentServer=r}));unwrapExports(infoUserAgentServer);var infoUserAgentServer_1=infoUserAgentServer.InfoUserAgentServer,notifyUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=t.createOutgoingRequestMessage(messages.C.NOTIFY,s);return e.call(this,transactions.NonInviteClientTransaction,t.userAgentCore,i,r)||this}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.NotifyUserAgentClient=r}));unwrapExports(notifyUserAgentClient);var notifyUserAgentClient_1=notifyUserAgentClient.NotifyUserAgentClient,notifyUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=void 0!==t.userAgentCore?t.userAgentCore:t;return e.call(this,transactions.NonInviteServerTransaction,i,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentServer.UserAgentServer);t.NotifyUserAgentServer=r}));unwrapExports(notifyUserAgentServer);var notifyUserAgentServer_1=notifyUserAgentServer.NotifyUserAgentServer,prackUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i,n=t.createOutgoingRequestMessage(messages.C.PRACK,s);return i=e.call(this,transactions.NonInviteClientTransaction,t.userAgentCore,n,r)||this,t.signalingStateTransition(n),i}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.PrackUserAgentClient=r}));unwrapExports(prackUserAgentClient);var prackUserAgentClient_1=prackUserAgentClient.PrackUserAgentClient,prackUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,transactions.NonInviteServerTransaction,t.userAgentCore,r,s)||this;return t.signalingStateTransition(r),i.dialog=t,i}return tslib_es6.__extends(t,e),t.prototype.accept=function(t){return void 0===t&&(t={statusCode:200}),t.body&&this.dialog.signalingStateTransition(t.body),e.prototype.accept.call(this,t)},t}(userAgentServer.UserAgentServer);t.PrackUserAgentServer=r}));unwrapExports(prackUserAgentServer);var prackUserAgentServer_1=prackUserAgentServer.PrackUserAgentServer,reInviteUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=this,n=t.createOutgoingRequestMessage(messages.C.INVITE,s);return(i=e.call(this,transactions.InviteClientTransaction,t.userAgentCore,n,r)||this).delegate=r,t.signalingStateTransition(n),t.reinviteUserAgentClient=i,i.dialog=t,i}return tslib_es6.__extends(t,e),t.prototype.receiveResponse=function(e){var t=this,r=e.statusCode?e.statusCode.toString():"";if(!r)throw new Error("Response status code undefined.");switch(!0){case/^100$/.test(r):this.delegate&&this.delegate.onTrying&&this.delegate.onTrying({message:e});break;case/^1[0-9]{2}$/.test(r):this.delegate&&this.delegate.onProgress&&this.delegate.onProgress({message:e,session:this.dialog,prack:function(e){throw new Error("Unimplemented.")}});break;case/^2[0-9]{2}$/.test(r):this.dialog.signalingStateTransition(e),this.delegate&&this.delegate.onAccept&&this.delegate.onAccept({message:e,session:this.dialog,ack:function(e){return t.dialog.ack(e)}});break;case/^3[0-9]{2}$/.test(r):this.delegate&&this.delegate.onRedirect&&this.delegate.onRedirect({message:e});break;case/^[4-6][0-9]{2}$/.test(r):this.delegate&&this.delegate.onReject&&this.delegate.onReject({message:e});break;default:throw new Error("Invalid status code "+r)}},t}(userAgentClient.UserAgentClient);t.ReInviteUserAgentClient=r}));unwrapExports(reInviteUserAgentClient);var reInviteUserAgentClient_1=reInviteUserAgentClient.ReInviteUserAgentClient,reInviteUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,transactions.InviteServerTransaction,t.userAgentCore,r,s)||this;return t.reinviteUserAgentServer=i,i.dialog=t,i}return tslib_es6.__extends(t,e),t.prototype.accept=function(t){void 0===t&&(t={statusCode:200}),t.extraHeaders=t.extraHeaders||[],t.extraHeaders=t.extraHeaders.concat(this.dialog.routeSet.map((function(e){return"Record-Route: "+e})));var r=e.prototype.accept.call(this,t),s=this.dialog,i=tslib_es6.__assign({},r,{session:s});return t.body&&this.dialog.signalingStateTransition(t.body),this.dialog.reConfirm(),i},t.prototype.progress=function(t){void 0===t&&(t={statusCode:180});var r=e.prototype.progress.call(this,t),s=this.dialog,i=tslib_es6.__assign({},r,{session:s});return t.body&&this.dialog.signalingStateTransition(t.body),i},t}(userAgentServer.UserAgentServer);t.ReInviteUserAgentServer=r}));unwrapExports(reInviteUserAgentServer);var reInviteUserAgentServer_1=reInviteUserAgentServer.ReInviteUserAgentServer,referUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=t.createOutgoingRequestMessage(messages.C.REFER,s);return e.call(this,transactions.NonInviteClientTransaction,t.userAgentCore,i,r)||this}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.ReferUserAgentClient=r}));unwrapExports(referUserAgentClient);var referUserAgentClient_1=referUserAgentClient.ReferUserAgentClient,referUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=void 0!==t.userAgentCore?t.userAgentCore:t;return e.call(this,transactions.NonInviteServerTransaction,i,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentServer.UserAgentServer);t.ReferUserAgentServer=r}));unwrapExports(referUserAgentServer);var referUserAgentServer_1=referUserAgentServer.ReferUserAgentServer,sessionDialog=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i){var n=e.call(this,r,s)||this;return n.initialTransaction=t,n._signalingState=session$1.SignalingState.Initial,n.ackWait=!1,n.delegate=i,t instanceof transactions.InviteServerTransaction&&(n.ackWait=!0),n.early||n.start2xxRetransmissionTimer(),n.signalingStateTransition(t.request),n.logger=r.loggerFactory.getLogger("sip.invite-dialog"),n.logger.log("INVITE dialog "+n.id+" constructed"),n}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._signalingState=session$1.SignalingState.Closed,this._offer=void 0,this._answer=void 0,this.invite2xxTimer&&(clearTimeout(this.invite2xxTimer),this.invite2xxTimer=void 0),this.logger.log("INVITE dialog "+this.id+" destroyed")},Object.defineProperty(t.prototype,"sessionState",{get:function(){return this.early?session$1.SessionState.Early:this.ackWait?session$1.SessionState.AckWait:this._signalingState===session$1.SignalingState.Closed?session$1.SessionState.Terminated:session$1.SessionState.Confirmed},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"signalingState",{get:function(){return this._signalingState},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"offer",{get:function(){return this._offer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"answer",{get:function(){return this._answer},enumerable:!0,configurable:!0}),t.prototype.confirm=function(){this.early&&this.start2xxRetransmissionTimer(),e.prototype.confirm.call(this)},t.prototype.reConfirm=function(){this.reinviteUserAgentServer&&this.startReInvite2xxRetransmissionTimer()},t.prototype.ack=function(e){var t;if(void 0===e&&(e={}),this.logger.log("INVITE dialog "+this.id+" sending ACK request"),this.reinviteUserAgentClient){if(!(this.reinviteUserAgentClient.transaction instanceof transactions.InviteClientTransaction))throw new Error("Transaction not instance of InviteClientTransaction.");t=this.reinviteUserAgentClient.transaction,this.reinviteUserAgentClient=void 0}else{if(!(this.initialTransaction instanceof transactions.InviteClientTransaction))throw new Error("Initial transaction not instance of InviteClientTransaction.");t=this.initialTransaction}e.cseq=t.request.cseq;var r=this.createOutgoingRequestMessage(messages.C.ACK,e);return t.ackResponse(r),this.signalingStateTransition(r),{message:r}},t.prototype.bye=function(e,t){if(this.logger.log("INVITE dialog "+this.id+" sending BYE request"),this.initialTransaction instanceof transactions.InviteServerTransaction){if(this.early)throw new Error("UAS MUST NOT send a BYE on early dialogs.");if(this.ackWait&&this.initialTransaction.state!==transactions.TransactionState.Terminated)throw new Error("UAS MUST NOT send a BYE on a confirmed dialog until it has received an ACK for its 2xx response or until the server transaction times out.")}return new byeUserAgentClient.ByeUserAgentClient(this,e,t)},t.prototype.info=function(e,t){if(this.logger.log("INVITE dialog "+this.id+" sending INFO request"),this.early)throw new Error("Dialog not confirmed.");return new infoUserAgentClient.InfoUserAgentClient(this,e,t)},t.prototype.invite=function(e,t){if(this.logger.log("INVITE dialog "+this.id+" sending INVITE request"),this.early)throw new Error("Dialog not confirmed.");if(this.reinviteUserAgentClient)throw new Error("There is an ongoing re-INVITE client transaction.");if(this.reinviteUserAgentServer)throw new Error("There is an ongoing re-INVITE server transaction.");return new reInviteUserAgentClient.ReInviteUserAgentClient(this,e,t)},t.prototype.notify=function(e,t){if(this.logger.log("INVITE dialog "+this.id+" sending NOTIFY request"),this.early)throw new Error("Dialog not confirmed.");return new notifyUserAgentClient.NotifyUserAgentClient(this,e,t)},t.prototype.prack=function(e,t){return this.logger.log("INVITE dialog "+this.id+" sending PRACK request"),new prackUserAgentClient.PrackUserAgentClient(this,e,t)},t.prototype.refer=function(e,t){if(this.logger.log("INVITE dialog "+this.id+" sending REFER request"),this.early)throw new Error("Dialog not confirmed.");return new referUserAgentClient.ReferUserAgentClient(this,e,t)},t.prototype.receiveRequest=function(t){if(this.logger.log("INVITE dialog "+this.id+" received "+t.method+" request"),t.method===messages.C.ACK){if(this.ackWait){if(this.initialTransaction instanceof transactions.InviteClientTransaction)return void this.logger.warn("INVITE dialog "+this.id+" received unexpected "+t.method+" request, dropping.");if(this.initialTransaction.request.cseq!==t.cseq)return void this.logger.warn("INVITE dialog "+this.id+" received unexpected "+t.method+" request, dropping.");this.ackWait=!1}else{if(!this.reinviteUserAgentServer)return void this.logger.warn("INVITE dialog "+this.id+" received unexpected "+t.method+" request, dropping.");if(this.reinviteUserAgentServer.transaction.request.cseq!==t.cseq)return void this.logger.warn("INVITE dialog "+this.id+" received unexpected "+t.method+" request, dropping.");this.reinviteUserAgentServer=void 0}return this.signalingStateTransition(t),void(this.delegate&&this.delegate.onAck&&this.delegate.onAck({message:t}))}if(this.sequenceGuard(t)){if(t.method===messages.C.INVITE){if(this.reinviteUserAgentServer){var r=["Retry-After: "+(Math.floor(10*Math.random())+1)];return void this.core.replyStateless(t,{statusCode:500,extraHeaders:r})}if(this.reinviteUserAgentClient)return void this.core.replyStateless(t,{statusCode:491})}if(e.prototype.receiveRequest.call(this,t),t.method===messages.C.INVITE){var s=t.parseHeader("contact");if(!s)throw new Error("Contact undefined.");if(!(s instanceof messages.NameAddrHeader))throw new Error("Contact not instance of NameAddrHeader.");this.dialogState.remoteTarget=s.uri}switch(t.method){case messages.C.BYE:var i=new byeUserAgentServer.ByeUserAgentServer(this,t);this.delegate&&this.delegate.onBye?this.delegate.onBye(i):i.accept(),this.dispose();break;case messages.C.INFO:i=new infoUserAgentServer.InfoUserAgentServer(this,t);this.delegate&&this.delegate.onInfo?this.delegate.onInfo(i):i.reject({statusCode:469,extraHeaders:["Recv-Info :"]});break;case messages.C.INVITE:i=new reInviteUserAgentServer.ReInviteUserAgentServer(this,t);this.delegate&&this.delegate.onInvite?this.delegate.onInvite(i):i.reject({statusCode:488});break;case messages.C.NOTIFY:i=new notifyUserAgentServer.NotifyUserAgentServer(this,t);this.delegate&&this.delegate.onNotify?this.delegate.onNotify(i):i.accept();break;case messages.C.PRACK:i=new prackUserAgentServer.PrackUserAgentServer(this,t);this.delegate&&this.delegate.onPrack?this.delegate.onPrack(i):i.accept();break;case messages.C.REFER:i=new referUserAgentServer.ReferUserAgentServer(this,t);this.delegate&&this.delegate.onRefer?this.delegate.onRefer(i):i.reject();break;default:this.logger.log("INVITE dialog "+this.id+" received unimplemented "+t.method+" request"),this.core.replyStateless(t,{statusCode:501})}}else this.logger.log("INVITE dialog "+this.id+" rejected out of order "+t.method+" request.")},t.prototype.reliableSequenceGuard=function(e){var t=e.statusCode;if(!t)throw new Error("Status code undefined");if(t>100&&t<200){var r=e.getHeader("require"),s=e.getHeader("rseq"),i=r&&r.includes("100rel")&&s?Number(s):void 0;if(i){if(this.rseq&&this.rseq+1!==i)return!1;this.rseq||(this.rseq=i)}}return!0},t.prototype.signalingStateTransition=function(e){var t=messages.getBody(e);if(t&&"session"===t.contentDisposition){if(e instanceof messages.IncomingRequestMessage)switch(this._signalingState){case session$1.SignalingState.Initial:case session$1.SignalingState.Stable:this._signalingState=session$1.SignalingState.HaveRemoteOffer,this._offer=t,this._answer=void 0;break;case session$1.SignalingState.HaveLocalOffer:this._signalingState=session$1.SignalingState.Stable,this._answer=t;break;case session$1.SignalingState.HaveRemoteOffer:case session$1.SignalingState.Closed:break;default:throw new Error("Unexpected signaling state.")}if(e instanceof messages.IncomingResponseMessage)switch(this._signalingState){case session$1.SignalingState.Initial:case session$1.SignalingState.Stable:this._signalingState=session$1.SignalingState.HaveRemoteOffer,this._offer=t,this._answer=void 0;break;case session$1.SignalingState.HaveLocalOffer:this._signalingState=session$1.SignalingState.Stable,this._answer=t;break;case session$1.SignalingState.HaveRemoteOffer:case session$1.SignalingState.Closed:break;default:throw new Error("Unexpected signaling state.")}if(e instanceof messages.OutgoingRequestMessage)switch(this._signalingState){case session$1.SignalingState.Initial:case session$1.SignalingState.Stable:this._signalingState=session$1.SignalingState.HaveLocalOffer,this._offer=t,this._answer=void 0;break;case session$1.SignalingState.HaveLocalOffer:break;case session$1.SignalingState.HaveRemoteOffer:this._signalingState=session$1.SignalingState.Stable,this._answer=t;break;case session$1.SignalingState.Closed:break;default:throw new Error("Unexpected signaling state.")}if(messages.isBody(e))switch(this._signalingState){case session$1.SignalingState.Initial:case session$1.SignalingState.Stable:this._signalingState=session$1.SignalingState.HaveLocalOffer,this._offer=t,this._answer=void 0;break;case session$1.SignalingState.HaveLocalOffer:break;case session$1.SignalingState.HaveRemoteOffer:this._signalingState=session$1.SignalingState.Stable,this._answer=t;break;case session$1.SignalingState.Closed:break;default:throw new Error("Unexpected signaling state.")}}},t.prototype.start2xxRetransmissionTimer=function(){var e=this;if(this.initialTransaction instanceof transactions.InviteServerTransaction){var t=this.initialTransaction,r=timers.Timers.T1,s=function(){e.ackWait?(e.logger.log("No ACK for 2xx response received, attempting retransmission"),t.retransmitAcceptedResponse(),r=Math.min(2*r,timers.Timers.T2),e.invite2xxTimer=setTimeout(s,r)):e.invite2xxTimer=void 0};this.invite2xxTimer=setTimeout(s,r);var i=function(){t.state===transactions.TransactionState.Terminated&&(t.removeListener("stateChanged",i),e.invite2xxTimer&&(clearTimeout(e.invite2xxTimer),e.invite2xxTimer=void 0),e.ackWait&&(e.delegate&&e.delegate.onAckTimeout?e.delegate.onAckTimeout():e.bye()))};t.addListener("stateChanged",i)}},t.prototype.startReInvite2xxRetransmissionTimer=function(){var e=this;if(this.reinviteUserAgentServer&&this.reinviteUserAgentServer.transaction instanceof transactions.InviteServerTransaction){var t=this.reinviteUserAgentServer.transaction,r=timers.Timers.T1,s=function(){e.reinviteUserAgentServer?(e.logger.log("No ACK for 2xx response received, attempting retransmission"),t.retransmitAcceptedResponse(),r=Math.min(2*r,timers.Timers.T2),e.invite2xxTimer=setTimeout(s,r)):e.invite2xxTimer=void 0};this.invite2xxTimer=setTimeout(s,r);var i=function(){t.state===transactions.TransactionState.Terminated&&(t.removeListener("stateChanged",i),e.invite2xxTimer&&(clearTimeout(e.invite2xxTimer),e.invite2xxTimer=void 0),e.reinviteUserAgentServer)};t.addListener("stateChanged",i)}},t}(dialog.Dialog);t.SessionDialog=r}));unwrapExports(sessionDialog);var sessionDialog_1=sessionDialog.SessionDialog,subscription=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Initial="Initial",e.NotifyWait="NotifyWait",e.Pending="Pending",e.Active="Active",e.Terminated="Terminated"}(t.SubscriptionState||(t.SubscriptionState={}))}));unwrapExports(subscription);var subscription_1=subscription.SubscriptionState,subscription$1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(subscription,t)}));unwrapExports(subscription$1);var allowedMethods=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AllowedMethods=[messages.C.ACK,messages.C.BYE,messages.C.CANCEL,messages.C.INFO,messages.C.INVITE,messages.C.MESSAGE,messages.C.NOTIFY,messages.C.OPTIONS,messages.C.PRACK,messages.C.REFER,messages.C.SUBSCRIBE]}));unwrapExports(allowedMethods);var allowedMethods_1=allowedMethods.AllowedMethods,reSubscribeUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=this,n=t.createOutgoingRequestMessage(messages.C.SUBSCRIBE,s);return(i=e.call(this,transactions.NonInviteClientTransaction,t.userAgentCore,n,r)||this).dialog=t,i}return tslib_es6.__extends(t,e),t.prototype.waitNotifyStop=function(){},t.prototype.receiveResponse=function(t){if(t.statusCode&&t.statusCode>=200&&t.statusCode<300){var r=t.getHeader("Expires");if(r){var s=Number(r);this.dialog.subscriptionExpires>s&&(this.dialog.subscriptionExpires=s)}else this.logger.warn("Expires header missing in a 200-class response to SUBSCRIBE")}if(t.statusCode&&t.statusCode>=400&&t.statusCode<700){[404,405,410,416,480,481,482,483,484,485,489,501,604].includes(t.statusCode)&&this.dialog.terminate()}e.prototype.receiveResponse.call(this,t)},t}(userAgentClient.UserAgentClient);t.ReSubscribeUserAgentClient=r}));unwrapExports(reSubscribeUserAgentClient);var reSubscribeUserAgentClient_1=reSubscribeUserAgentClient.ReSubscribeUserAgentClient,subscriptionDialog=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i,n,o){var a=e.call(this,i,n)||this;return a.delegate=o,a._autoRefresh=!1,a._subscriptionEvent=t,a._subscriptionExpires=r,a._subscriptionExpiresInitial=r,a._subscriptionExpiresLastSet=Math.floor(Date.now()/1e3),a._subscriptionRefresh=void 0,a._subscriptionRefreshLastSet=void 0,a._subscriptionState=s,a.logger=i.loggerFactory.getLogger("sip.subscribe-dialog"),a.logger.log("SUBSCRIBE dialog "+a.id+" constructed"),a}return tslib_es6.__extends(t,e),t.initialDialogStateForSubscription=function(e,t){var r=t.getHeaders("record-route"),s=t.parseHeader("contact");if(!s)throw new Error("Contact undefined.");if(!(s instanceof messages.NameAddrHeader))throw new Error("Contact not instance of NameAddrHeader.");var i=s.uri,n=e.cseq,o=e.callId,a=e.fromTag,c=t.fromTag;if(!o)throw new Error("Call id undefined.");if(!a)throw new Error("From tag undefined.");if(!c)throw new Error("To tag undefined.");if(!e.from)throw new Error("From undefined.");if(!e.to)throw new Error("To undefined.");return{id:o+a+c,early:!1,callId:o,localTag:a,remoteTag:c,localSequenceNumber:n,remoteSequenceNumber:undefined,localURI:e.from.uri,remoteURI:e.to.uri,remoteTarget:i,routeSet:r,secure:!1}},t.prototype.dispose=function(){e.prototype.dispose.call(this),this.N&&(clearTimeout(this.N),this.N=void 0),this.refreshTimerClear(),this.logger.log("SUBSCRIBE dialog "+this.id+" destroyed")},Object.defineProperty(t.prototype,"autoRefresh",{get:function(){return this._autoRefresh},set:function(e){this._autoRefresh=!0,this.refreshTimerSet()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"subscriptionEvent",{get:function(){return this._subscriptionEvent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"subscriptionExpires",{get:function(){var e=Math.floor(Date.now()/1e3)-this._subscriptionExpiresLastSet,t=this._subscriptionExpires-e;return Math.max(t,0)},set:function(e){if(e<0)throw new Error("Expires must be greater than or equal to zero.");if(this._subscriptionExpires=e,this._subscriptionExpiresLastSet=Math.floor(Date.now()/1e3),this.autoRefresh){var t=this.subscriptionRefresh;(void 0===t||t>=e)&&this.refreshTimerSet()}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"subscriptionExpiresInitial",{get:function(){return this._subscriptionExpiresInitial},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"subscriptionRefresh",{get:function(){if(void 0!==this._subscriptionRefresh&&void 0!==this._subscriptionRefreshLastSet){var e=Math.floor(Date.now()/1e3)-this._subscriptionRefreshLastSet,t=this._subscriptionRefresh-e;return Math.max(t,0)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"subscriptionState",{get:function(){return this._subscriptionState},enumerable:!0,configurable:!0}),t.prototype.receiveRequest=function(t){if(this.logger.log("SUBSCRIBE dialog "+this.id+" received "+t.method+" request"),this.sequenceGuard(t))if(e.prototype.receiveRequest.call(this,t),t.method===messages.C.NOTIFY)this.onNotify(t);else this.logger.log("SUBSCRIBE dialog "+this.id+" received unimplemented "+t.method+" request"),this.core.replyStateless(t,{statusCode:501});else this.logger.log("SUBSCRIBE dialog "+this.id+" rejected out of order "+t.method+" request.")},t.prototype.refresh=function(){var e="Allow: "+allowedMethods.AllowedMethods.toString(),t={};return t.extraHeaders=(t.extraHeaders||[]).slice(),t.extraHeaders.push(e),t.extraHeaders.push("Event: "+this.subscriptionEvent),t.extraHeaders.push("Expires: "+this.subscriptionExpiresInitial),t.extraHeaders.push("Contact: "+this.core.configuration.contact.toString()),this.subscribe(void 0,t)},t.prototype.subscribe=function(e,t){var r=this;if(void 0===t&&(t={}),this.subscriptionState!==subscription$1.SubscriptionState.Pending&&this.subscriptionState!==subscription$1.SubscriptionState.Active)throw new Error("Invalid state "+this.subscriptionState+'. May only re-subscribe while in state "pending" or "active".');this.logger.log("SUBSCRIBE dialog "+this.id+" sending SUBSCRIBE request");var s=new reSubscribeUserAgentClient.ReSubscribeUserAgentClient(this,e,t);return this.N=setTimeout((function(){return r.timer_N()}),timers.Timers.TIMER_N),s},t.prototype.terminate=function(){this.stateTransition(subscription$1.SubscriptionState.Terminated),this.onTerminated()},t.prototype.unsubscribe=function(){var e="Allow: "+allowedMethods.AllowedMethods.toString(),t={};return t.extraHeaders=(t.extraHeaders||[]).slice(),t.extraHeaders.push(e),t.extraHeaders.push("Event: "+this.subscriptionEvent),t.extraHeaders.push("Expires: 0"),t.extraHeaders.push("Contact: "+this.core.configuration.contact.toString()),this.subscribe(void 0,t)},t.prototype.onNotify=function(e){var t=e.parseHeader("Event").event;if(t&&t===this.subscriptionEvent){this.N&&(clearTimeout(this.N),this.N=void 0);var r=e.parseHeader("Subscription-State");if(r&&r.state){var s=r.state,i=r.expires?Math.max(r.expires,0):void 0;switch(s){case"pending":this.stateTransition(subscription$1.SubscriptionState.Pending,i);break;case"active":this.stateTransition(subscription$1.SubscriptionState.Active,i);break;case"terminated":this.stateTransition(subscription$1.SubscriptionState.Terminated,i);break;default:this.logger.warn("Unrecognized subscription state.")}var n=new notifyUserAgentServer.NotifyUserAgentServer(this,e);this.delegate&&this.delegate.onNotify?this.delegate.onNotify(n):n.accept()}else this.core.replyStateless(e,{statusCode:489})}else this.core.replyStateless(e,{statusCode:489})},t.prototype.onRefresh=function(e){this.delegate&&this.delegate.onRefresh&&this.delegate.onRefresh(e)},t.prototype.onTerminated=function(){this.delegate&&this.delegate.onTerminated&&this.delegate.onTerminated()},t.prototype.refreshTimerClear=function(){this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=void 0)},t.prototype.refreshTimerSet=function(){var e=this;if(this.refreshTimerClear(),this.autoRefresh&&this.subscriptionExpires>0){var t=900*this.subscriptionExpires;this._subscriptionRefresh=Math.floor(t/1e3),this._subscriptionRefreshLastSet=Math.floor(Date.now()/1e3),this.refreshTimer=setTimeout((function(){e.refreshTimer=void 0,e._subscriptionRefresh=void 0,e._subscriptionRefreshLastSet=void 0,e.onRefresh(e.refresh())}),t)}},t.prototype.stateTransition=function(e,t){var r=this,s=function(){r.logger.warn("Invalid subscription state transition from "+r.subscriptionState+" to "+e)};switch(e){case subscription$1.SubscriptionState.Initial:case subscription$1.SubscriptionState.NotifyWait:return void s();case subscription$1.SubscriptionState.Pending:if(this.subscriptionState!==subscription$1.SubscriptionState.NotifyWait&&this.subscriptionState!==subscription$1.SubscriptionState.Pending)return void s();break;case subscription$1.SubscriptionState.Active:case subscription$1.SubscriptionState.Terminated:if(this.subscriptionState!==subscription$1.SubscriptionState.NotifyWait&&this.subscriptionState!==subscription$1.SubscriptionState.Pending&&this.subscriptionState!==subscription$1.SubscriptionState.Active)return void s();break;default:return void s()}e===subscription$1.SubscriptionState.Pending&&t&&(this.subscriptionExpires=t),e===subscription$1.SubscriptionState.Active&&t&&(this.subscriptionExpires=t),e===subscription$1.SubscriptionState.Terminated&&this.dispose(),this._subscriptionState=e},t.prototype.timer_N=function(){this.subscriptionState!==subscription$1.SubscriptionState.Terminated&&(this.stateTransition(subscription$1.SubscriptionState.Terminated),this.onTerminated())},t}(dialog.Dialog);t.SubscriptionDialog=r}));unwrapExports(subscriptionDialog);var subscriptionDialog_1=subscriptionDialog.SubscriptionDialog,dialogs=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(dialog,t),tslib_es6.__exportStar(sessionDialog,t),tslib_es6.__exportStar(subscriptionDialog,t)}));unwrapExports(dialogs);var levels=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.error=0]="error",e[e.warn=1]="warn",e[e.log=2]="log",e[e.debug=3]="debug"}(t.Levels||(t.Levels={}))}));unwrapExports(levels);var levels_1=levels.Levels,logger=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r){this.logger=e,this.category=t,this.label=r}return e.prototype.error=function(e){this.genericLog(levels.Levels.error,e)},e.prototype.warn=function(e){this.genericLog(levels.Levels.warn,e)},e.prototype.log=function(e){this.genericLog(levels.Levels.log,e)},e.prototype.debug=function(e){this.genericLog(levels.Levels.debug,e)},e.prototype.genericLog=function(e,t){this.logger.genericLog(e,this.category,this.label,t)},e}();t.Logger=r}));unwrapExports(logger);var logger_1=logger.Logger,loggerFactory=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.builtinEnabled=!0,this._level=levels.Levels.log,this.loggers={},this.logger=this.getLogger("sip:loggerfactory")}return Object.defineProperty(e.prototype,"level",{get:function(){return this._level},set:function(e){e>=0&&e<=3?this._level=e:e>3?this._level=3:levels.Levels.hasOwnProperty(e)?this._level=e:this.logger.error("invalid 'level' parameter value: "+JSON.stringify(e))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connector",{get:function(){return this._connector},set:function(e){e?"function"==typeof e?this._connector=e:this.logger.error("invalid 'connector' parameter value: "+JSON.stringify(e)):this._connector=void 0},enumerable:!0,configurable:!0}),e.prototype.getLogger=function(e,t){if(t&&3===this.level)return new logger.Logger(this,e,t);if(this.loggers[e])return this.loggers[e];var r=new logger.Logger(this,e);return this.loggers[e]=r,r},e.prototype.genericLog=function(e,t,r,s){this.level>=e&&this.builtinEnabled&&this.print(e,t,r,s),this.connector&&this.connector(levels.Levels[e],t,r,s)},e.prototype.print=function(e,t,r,s){if("string"==typeof s){var i=[new Date,t];r&&i.push(r),s=i.concat(s).join(" | ")}switch(e){case levels.Levels.error:console.error(s);break;case levels.Levels.warn:console.warn(s);break;case levels.Levels.log:console.log(s);break;case levels.Levels.debug:console.debug(s)}},e}();t.LoggerFactory=r}));unwrapExports(loggerFactory);var loggerFactory_1=loggerFactory.LoggerFactory,log$1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(levels,t),tslib_es6.__exportStar(loggerFactory,t),tslib_es6.__exportStar(logger,t)}));unwrapExports(log$1);var cancelUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,transactions.NonInviteClientTransaction,t,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.CancelUserAgentClient=r}));unwrapExports(cancelUserAgentClient);var cancelUserAgentClient_1=cancelUserAgentClient.CancelUserAgentClient,inviteUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,transactions.InviteClientTransaction,t,r,s)||this;return i.confirmedDialogAcks=new Map,i.confirmedDialogs=new Map,i.earlyDialogs=new Map,i.delegate=s,i}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.earlyDialogs.forEach((function(e){return e.dispose()})),this.earlyDialogs.clear(),e.prototype.dispose.call(this)},t.prototype.receiveResponse=function(e){var t=this;if(this.authenticationGuard(e)){var r=e.statusCode?e.statusCode.toString():"";if(!r)throw new Error("Response status code undefined.");switch(!0){case/^100$/.test(r):return void(this.delegate&&this.delegate.onTrying&&this.delegate.onTrying({message:e}));case/^1[0-9]{2}$/.test(r):if(!e.toTag)return void this.logger.warn("Non-100 1xx INVITE response received without a to tag, dropping.");var s=dialogs.Dialog.initialDialogStateForUserAgentClient(this.message,e),i=this.earlyDialogs.get(s.id);if(!i){if(!((a=this.transaction)instanceof transactions.InviteClientTransaction))throw new Error("Transaction not instance of InviteClientTransaction.");i=new dialogs.SessionDialog(a,this.core,s),this.earlyDialogs.set(i.id,i)}if(!i.reliableSequenceGuard(e))return void this.logger.warn("1xx INVITE reliable response received out of order, dropping.");i.signalingState!==session$1.SignalingState.Initial&&i.signalingState!==session$1.SignalingState.HaveLocalOffer||i.signalingStateTransition(e);var n=i;return void(this.delegate&&this.delegate.onProgress&&this.delegate.onProgress({message:e,session:n,prack:function(e){return n.prack(void 0,e)}}));case/^2[0-9]{2}$/.test(r):s=dialogs.Dialog.initialDialogStateForUserAgentClient(this.message,e);var o=this.confirmedDialogs.get(s.id);if(o){if(u=this.confirmedDialogAcks.get(s.id)){if(!((a=this.transaction)instanceof transactions.InviteClientTransaction))throw new Error("Client transaction not instance of InviteClientTransaction.");a.ackResponse(u.message)}return}if(o=this.earlyDialogs.get(s.id))o.confirm(),o.recomputeRouteSet(e),this.earlyDialogs.delete(o.id),this.confirmedDialogs.set(o.id,o);else{var a;if(!((a=this.transaction)instanceof transactions.InviteClientTransaction))throw new Error("Transaction not instance of InviteClientTransaction.");o=new dialogs.SessionDialog(a,this.core,s),this.confirmedDialogs.set(o.id,o)}o.signalingState!==session$1.SignalingState.Initial&&o.signalingState!==session$1.SignalingState.HaveLocalOffer||o.signalingStateTransition(e);var c=o;if(this.delegate&&this.delegate.onAccept)this.delegate.onAccept({message:e,session:c,ack:function(e){var r=c.ack(e);return t.confirmedDialogAcks.set(c.id,r),r}});else{var u=c.ack();this.confirmedDialogAcks.set(c.id,u)}return;case/^3[0-9]{2}$/.test(r):return this.earlyDialogs.forEach((function(e){return e.dispose()})),this.earlyDialogs.clear(),void(this.delegate&&this.delegate.onRedirect&&this.delegate.onRedirect({message:e}));case/^[4-6][0-9]{2}$/.test(r):return this.earlyDialogs.forEach((function(e){return e.dispose()})),this.earlyDialogs.clear(),void(this.delegate&&this.delegate.onReject&&this.delegate.onReject({message:e}));default:throw new Error("Invalid status code "+r)}throw new Error("Executing what should be an unreachable code path receiving "+r+" response.")}},t}(userAgentClient.UserAgentClient);t.InviteUserAgentClient=r}));unwrapExports(inviteUserAgentClient);var inviteUserAgentClient_1=inviteUserAgentClient.InviteUserAgentClient,inviteUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,transactions.InviteServerTransaction,t,r,s)||this;return i.core=t,i}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.earlyDialog&&this.earlyDialog.dispose(),e.prototype.dispose.call(this)},t.prototype.accept=function(t){if(void 0===t&&(t={statusCode:200}),!this.acceptable)throw new exceptions.TransactionStateError(this.message.method+" not acceptable in state "+this.transaction.state+".");if(!this.confirmedDialog)if(this.earlyDialog)this.earlyDialog.confirm(),this.confirmedDialog=this.earlyDialog,this.earlyDialog=void 0;else{var r=this.transaction;if(!(r instanceof transactions.InviteServerTransaction))throw new Error("Transaction not instance of InviteClientTransaction.");var s=dialogs.Dialog.initialDialogStateForUserAgentServer(this.message,this.toTag);this.confirmedDialog=new dialogs.SessionDialog(r,this.core,s)}var i=this.message.getHeaders("record-route").map((function(e){return"Record-Route: "+e})),n="Contact: "+this.core.configuration.contact.toString(),o="Allow: "+allowedMethods.AllowedMethods.toString();if(!t.body)if(this.confirmedDialog.signalingState===session$1.SignalingState.Stable)t.body=this.confirmedDialog.answer;else if(this.confirmedDialog.signalingState===session$1.SignalingState.Initial||this.confirmedDialog.signalingState===session$1.SignalingState.HaveRemoteOffer)throw new Error("Response must have a body.");t.statusCode=t.statusCode||200,t.extraHeaders=t.extraHeaders||[],t.extraHeaders=t.extraHeaders.concat(i),t.extraHeaders.push(o),t.extraHeaders.push(n);var a=e.prototype.accept.call(this,t),c=this.confirmedDialog,u=tslib_es6.__assign({},a,{session:c});return t.body&&this.confirmedDialog.signalingState!==session$1.SignalingState.Stable&&this.confirmedDialog.signalingStateTransition(t.body),u},t.prototype.progress=function(t){if(void 0===t&&(t={statusCode:180}),!this.progressable)throw new exceptions.TransactionStateError(this.message.method+" not progressable in state "+this.transaction.state+".");if(!this.earlyDialog){var r=this.transaction;if(!(r instanceof transactions.InviteServerTransaction))throw new Error("Transaction not instance of InviteClientTransaction.");var s=dialogs.Dialog.initialDialogStateForUserAgentServer(this.message,this.toTag,!0);this.earlyDialog=new dialogs.SessionDialog(r,this.core,s)}var i=this.message.getHeaders("record-route").map((function(e){return"Record-Route: "+e})),n="Contact: "+this.core.configuration.contact;t.extraHeaders=t.extraHeaders||[],t.extraHeaders=t.extraHeaders.concat(i),t.extraHeaders.push(n);var o=e.prototype.progress.call(this,t),a=this.earlyDialog,c=tslib_es6.__assign({},o,{session:a});return t.body&&this.earlyDialog.signalingState!==session$1.SignalingState.Stable&&this.earlyDialog.signalingStateTransition(t.body),c},t.prototype.redirect=function(t,r){return void 0===r&&(r={statusCode:302}),e.prototype.redirect.call(this,t,r)},t.prototype.reject=function(t){return void 0===t&&(t={statusCode:486}),e.prototype.reject.call(this,t)},t}(userAgentServer.UserAgentServer);t.InviteUserAgentServer=r}));unwrapExports(inviteUserAgentServer);var inviteUserAgentServer_1=inviteUserAgentServer.InviteUserAgentServer,messageUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,transactions.NonInviteClientTransaction,t,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.MessageUserAgentClient=r}));unwrapExports(messageUserAgentClient);var messageUserAgentClient_1=messageUserAgentClient.MessageUserAgentClient,messageUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,transactions.NonInviteServerTransaction,t,r,s)||this;return i.core=t,i}return tslib_es6.__extends(t,e),t}(userAgentServer.UserAgentServer);t.MessageUserAgentServer=r}));unwrapExports(messageUserAgentServer);var messageUserAgentServer_1=messageUserAgentServer.MessageUserAgentServer,publishUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,transactions.NonInviteClientTransaction,t,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.PublishUserAgentClient=r}));unwrapExports(publishUserAgentClient);var publishUserAgentClient_1=publishUserAgentClient.PublishUserAgentClient,reSubscribeUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,transactions.NonInviteServerTransaction,t.userAgentCore,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentServer.UserAgentServer);t.ReSubscribeUserAgentServer=r}));unwrapExports(reSubscribeUserAgentServer);var reSubscribeUserAgentServer_1=reSubscribeUserAgentServer.ReSubscribeUserAgentServer,registerUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){return e.call(this,transactions.NonInviteClientTransaction,t,r,s)||this}return tslib_es6.__extends(t,e),t}(userAgentClient.UserAgentClient);t.RegisterUserAgentClient=r}));unwrapExports(registerUserAgentClient);var registerUserAgentClient_1=registerUserAgentClient.RegisterUserAgentClient,subscribeUserAgentClient=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=this,n=r.getHeader("Event");if(!n)throw new Error("Event undefined");var o=r.getHeader("Expires");if(!o)throw new Error("Expires undefined");return(i=e.call(this,transactions.NonInviteClientTransaction,t,r,s)||this).delegate=s,i.subscriberId=r.callId+r.fromTag+n,i.subscriptionExpiresRequested=i.subscriptionExpires=Number(o),i.subscriptionEvent=n,i.subscriptionState=subscription$1.SubscriptionState.NotifyWait,i.waitNotifyStart(),i}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this)},t.prototype.onNotify=function(e){var t=e.message.parseHeader("Event").event;if(!t||t!==this.subscriptionEvent)return this.logger.warn("Failed to parse event."),void e.reject({statusCode:489});var r=e.message.parseHeader("Subscription-State");if(!r||!r.state)return this.logger.warn("Failed to parse subscription state."),void e.reject({statusCode:489});var s=r.state;switch(s){case"pending":case"active":case"terminated":break;default:return this.logger.warn("Invalid subscription state "+s),void e.reject({statusCode:489})}if("terminated"!==s&&!e.message.parseHeader("contact"))return this.logger.warn("Failed to parse contact."),void e.reject({statusCode:489});if(this.dialog)throw new Error("Dialog already created. This implementation only supports install of single subscriptions.");switch(this.waitNotifyStop(),this.subscriptionExpires=r.expires?Math.min(this.subscriptionExpires,Math.max(r.expires,0)):this.subscriptionExpires,s){case"pending":this.subscriptionState=subscription$1.SubscriptionState.Pending;break;case"active":this.subscriptionState=subscription$1.SubscriptionState.Active;break;case"terminated":this.subscriptionState=subscription$1.SubscriptionState.Terminated;break;default:throw new Error("Unrecognized state "+s+".")}if(this.subscriptionState!==subscription$1.SubscriptionState.Terminated){var i=subscriptionDialog.SubscriptionDialog.initialDialogStateForSubscription(this.message,e.message);this.dialog=new subscriptionDialog.SubscriptionDialog(this.subscriptionEvent,this.subscriptionExpires,this.subscriptionState,this.core,i)}if(this.delegate&&this.delegate.onNotify){var n=e,o=this.dialog;this.delegate.onNotify({request:n,subscription:o})}else e.accept()},t.prototype.waitNotifyStart=function(){var e=this;this.N||(this.core.subscribers.set(this.subscriberId,this),this.N=setTimeout((function(){return e.timer_N()}),timers.Timers.TIMER_N))},t.prototype.waitNotifyStop=function(){this.N&&(this.core.subscribers.delete(this.subscriberId),clearTimeout(this.N),this.N=void 0)},t.prototype.receiveResponse=function(t){if(this.authenticationGuard(t)){if(t.statusCode&&t.statusCode>=200&&t.statusCode<300){var r=t.getHeader("Expires");if(r){var s=Number(r);s>this.subscriptionExpiresRequested&&this.logger.warn("Expires header in a 200-class response to SUBSCRIBE with a higher value than the one in the request"),s<this.subscriptionExpires&&(this.subscriptionExpires=s)}else this.logger.warn("Expires header missing in a 200-class response to SUBSCRIBE");this.dialog&&this.dialog.subscriptionExpires>this.subscriptionExpires&&(this.dialog.subscriptionExpires=this.subscriptionExpires)}t.statusCode&&t.statusCode>=300&&t.statusCode<700&&this.waitNotifyStop(),e.prototype.receiveResponse.call(this,t)}},t.prototype.timer_N=function(){this.logger.warn("Timer N expired for SUBSCRIBE user agent client. Timed out waiting for NOTIFY."),this.waitNotifyStop(),this.delegate&&this.delegate.onNotifyTimeout&&this.delegate.onNotifyTimeout()},t}(userAgentClient.UserAgentClient);t.SubscribeUserAgentClient=r}));unwrapExports(subscribeUserAgentClient);var subscribeUserAgentClient_1=subscribeUserAgentClient.SubscribeUserAgentClient,subscribeUserAgentServer=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){var i=e.call(this,transactions.NonInviteServerTransaction,t,r,s)||this;return i.core=t,i}return tslib_es6.__extends(t,e),t}(userAgentServer.UserAgentServer);t.SubscribeUserAgentServer=r}));unwrapExports(subscribeUserAgentServer);var subscribeUserAgentServer_1=subscribeUserAgentServer.SubscribeUserAgentServer,userAgents=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(byeUserAgentClient,t),tslib_es6.__exportStar(byeUserAgentServer,t),tslib_es6.__exportStar(cancelUserAgentClient,t),tslib_es6.__exportStar(infoUserAgentServer,t),tslib_es6.__exportStar(inviteUserAgentClient,t),tslib_es6.__exportStar(inviteUserAgentServer,t),tslib_es6.__exportStar(messageUserAgentClient,t),tslib_es6.__exportStar(messageUserAgentServer,t),tslib_es6.__exportStar(notifyUserAgentClient,t),tslib_es6.__exportStar(notifyUserAgentServer,t),tslib_es6.__exportStar(publishUserAgentClient,t),tslib_es6.__exportStar(prackUserAgentClient,t),tslib_es6.__exportStar(prackUserAgentServer,t),tslib_es6.__exportStar(reInviteUserAgentClient,t),tslib_es6.__exportStar(reInviteUserAgentServer,t),tslib_es6.__exportStar(reSubscribeUserAgentClient,t),tslib_es6.__exportStar(reSubscribeUserAgentServer,t),tslib_es6.__exportStar(referUserAgentClient,t),tslib_es6.__exportStar(referUserAgentServer,t),tslib_es6.__exportStar(registerUserAgentClient,t),tslib_es6.__exportStar(subscribeUserAgentClient,t),tslib_es6.__exportStar(subscribeUserAgentServer,t),tslib_es6.__exportStar(userAgentClient,t),tslib_es6.__exportStar(userAgentServer,t)}));unwrapExports(userAgents);var userAgentCore=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=["application/sdp","application/dtmf-relay"],s=function(){function e(e,t){void 0===t&&(t={}),this.userAgentClients=new Map,this.userAgentServers=new Map,this.configuration=e,this.delegate=t,this.dialogs=new Map,this.subscribers=new Map,this.logger=e.loggerFactory.getLogger("sip.user-agent-core")}return e.prototype.dispose=function(){this.reset()},e.prototype.reset=function(){this.dialogs.forEach((function(e){return e.dispose()})),this.dialogs.clear(),this.subscribers.forEach((function(e){return e.dispose()})),this.subscribers.clear(),this.userAgentClients.forEach((function(e){return e.dispose()})),this.userAgentClients.clear(),this.userAgentServers.forEach((function(e){return e.dispose()})),this.userAgentServers.clear()},Object.defineProperty(e.prototype,"loggerFactory",{get:function(){return this.configuration.loggerFactory},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transport",{get:function(){var e=this.configuration.transportAccessor();if(!e)throw new Error("Transport undefined.");return e},enumerable:!0,configurable:!0}),e.prototype.invite=function(e,t){return new userAgents.InviteUserAgentClient(this,e,t)},e.prototype.message=function(e,t){return new userAgents.MessageUserAgentClient(this,e,t)},e.prototype.publish=function(e,t){return new userAgents.PublishUserAgentClient(this,e,t)},e.prototype.register=function(e,t){return new userAgents.RegisterUserAgentClient(this,e,t)},e.prototype.subscribe=function(e,t){return new userAgents.SubscribeUserAgentClient(this,e,t)},e.prototype.request=function(e,t){return new userAgents.UserAgentClient(transactions.NonInviteClientTransaction,this,e,t)},e.prototype.makeOutgoingRequestMessage=function(e,t,r,s,i,n,o){var a=this.configuration.sipjsId,c=this.configuration.displayName,u=this.configuration.viaForceRport,d=this.configuration.hackViaTcp,l=this.configuration.supportedOptionTags.slice();e===messages.C.REGISTER&&l.push("path","gruu"),e===messages.C.INVITE&&(this.configuration.contact.pubGruu||this.configuration.contact.tempGruu)&&l.push("gruu");var p={callIdPrefix:a,forceRport:u,fromDisplayName:c,hackViaTcp:d,optionTags:l,routeSet:this.configuration.routeSet,userAgentString:this.configuration.userAgentHeaderFieldValue,viaHost:this.configuration.viaHost},h=tslib_es6.__assign({},p,i);return new messages.OutgoingRequestMessage(e,t,r,s,h,n,o)},e.prototype.receiveIncomingRequestFromTransport=function(e){this.receiveRequestFromTransport(e)},e.prototype.receiveIncomingResponseFromTransport=function(e){this.receiveResponseFromTransport(e)},e.prototype.replyStateless=function(e,t){var r=this.configuration.userAgentHeaderFieldValue,s=this.configuration.supportedOptionTagsResponse;t=tslib_es6.__assign({},t,{userAgent:r,supported:s});var i=messages.constructOutgoingResponse(e,t);return this.transport.send(i.message),i},e.prototype.receiveRequestFromTransport=function(e){var t=e.viaBranch,r=this.userAgentServers.get(t);e.method===messages.C.ACK&&r&&r.transaction.state===transactions.TransactionState.Accepted&&r instanceof userAgents.InviteUserAgentServer?this.logger.warn("Discarding out of dialog ACK after 2xx response sent on transaction "+t+"."):e.method!==messages.C.CANCEL?r?r.transaction.receiveRequest(e):this.receiveRequest(e):r?(this.replyStateless(e,{statusCode:200}),r.transaction instanceof transactions.InviteServerTransaction&&r.transaction.state===transactions.TransactionState.Proceeding&&r instanceof userAgents.InviteUserAgentServer&&r.receiveCancel(e)):this.replyStateless(e,{statusCode:481})},e.prototype.receiveRequest=function(e){if(allowedMethods.AllowedMethods.includes(e.method)){if(!e.ruri)throw new Error("Request-URI undefined.");if("sip"===e.ruri.scheme){var t=e.ruri,r=function(e){return!!e&&e.user===t.user};if(!r(this.configuration.aor)&&!(r(this.configuration.contact.uri)||r(this.configuration.contact.pubGruu)||r(this.configuration.contact.tempGruu)))return this.logger.warn("Request-URI does not point to us."),void(e.method!==messages.C.ACK&&this.replyStateless(e,{statusCode:404}));if(e.method!==messages.C.INVITE||e.hasHeader("Contact")){if(!e.toTag){var s=e.viaBranch;if(!this.userAgentServers.has(s))if(Array.from(this.userAgentServers.values()).some((function(t){return t.transaction.request.fromTag===e.fromTag&&t.transaction.request.callId===e.callId&&t.transaction.request.cseq===e.cseq})))return void this.replyStateless(e,{statusCode:482})}e.toTag?this.receiveInsideDialogRequest(e):this.receiveOutsideDialogRequest(e)}else this.replyStateless(e,{statusCode:400,reasonPhrase:"Missing Contact Header"})}else this.replyStateless(e,{statusCode:416})}else{var i="Allow: "+allowedMethods.AllowedMethods.toString();this.replyStateless(e,{statusCode:405,extraHeaders:[i]})}},e.prototype.receiveInsideDialogRequest=function(e){if(e.method===messages.C.NOTIFY){var t=e.parseHeader("Event");if(!t||!t.event)return void this.replyStateless(e,{statusCode:489});var s=e.callId+e.toTag+t.event,i=this.subscribers.get(s);if(i){var n=new userAgents.NotifyUserAgentServer(this,e);return void i.onNotify(n)}}var o=e.callId+e.toTag+e.fromTag,a=this.dialogs.get(o);if(a){if(e.method===messages.C.OPTIONS){var c="Allow: "+allowedMethods.AllowedMethods.toString(),u="Accept: "+r.toString();return void this.replyStateless(e,{statusCode:200,extraHeaders:[c,u]})}a.receiveRequest(e)}else e.method!==messages.C.ACK&&this.replyStateless(e,{statusCode:481})},e.prototype.receiveOutsideDialogRequest=function(e){switch(e.method){case messages.C.ACK:break;case messages.C.BYE:this.replyStateless(e,{statusCode:481});break;case messages.C.CANCEL:throw new Error("Unexpected out of dialog request method "+e.method+".");case messages.C.INFO:this.replyStateless(e,{statusCode:405});break;case messages.C.INVITE:var t=new userAgents.InviteUserAgentServer(this,e);this.delegate.onInvite?this.delegate.onInvite(t):t.reject();break;case messages.C.MESSAGE:t=new userAgents.MessageUserAgentServer(this,e);this.delegate.onMessage?this.delegate.onMessage(t):t.accept();break;case messages.C.NOTIFY:t=new userAgents.NotifyUserAgentServer(this,e);this.delegate.onNotify?this.delegate.onNotify(t):this.replyStateless(e,{statusCode:405});break;case messages.C.OPTIONS:var s="Allow: "+allowedMethods.AllowedMethods.toString(),i="Accept: "+r.toString();this.replyStateless(e,{statusCode:200,extraHeaders:[s,i]});break;case messages.C.REFER:t=new userAgents.ReferUserAgentServer(this,e);this.delegate.onRefer?this.delegate.onRefer(t):this.replyStateless(e,{statusCode:405});break;case messages.C.SUBSCRIBE:t=new userAgents.SubscribeUserAgentServer(this,e);this.delegate.onSubscribe?this.delegate.onSubscribe(t):t.reject();break;default:throw new Error("Unexpected out of dialog request method "+e.method+".")}},e.prototype.receiveResponseFromTransport=function(e){if(e.getHeaders("via").length>1)this.logger.warn("More than one Via header field present in the response, dropping");else{var t=e.viaBranch+e.method,r=this.userAgentClients.get(t);r?r.transaction.receiveResponse(e):this.logger.warn("Discarding unmatched "+e.statusCode+" response to "+e.method+" "+t+".")}},e}();t.UserAgentCore=s}));unwrapExports(userAgentCore);var userAgentCore_1=userAgentCore.UserAgentCore,userAgentCore$1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(userAgentCore,t)}));unwrapExports(userAgentCore$1);var transport=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r){var s=e.call(this)||this;return s.logger=t,s}return tslib_es6.__extends(t,e),t.prototype.connect=function(e){var t=this;return void 0===e&&(e={}),this.connectPromise(e).then((function(e){e.overrideEvent||t.emit("connected")}))},t.prototype.send=function(e,t){var r=this;return this.sendPromise(e).then((function(e){e.overrideEvent||r.emit("messageSent",e.msg)}))},t.prototype.disconnect=function(e){var t=this;return void 0===e&&(e={}),this.disconnectPromise(e).then((function(e){e.overrideEvent||t.emit("disconnected")}))},t.prototype.afterConnected=function(e){this.isConnected()?e():this.once("connected",e)},t.prototype.waitForConnected=function(){var e=this;return console.warn("DEPRECATION WARNING Transport.waitForConnected(): use afterConnected() instead"),new Promise((function(t){e.afterConnected(t)}))},t}(EventEmitter.EventEmitter);t.Transport=r}));unwrapExports(transport);var transport_1=transport.Transport,core$1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),tslib_es6.__exportStar(dialogs,t),tslib_es6.__exportStar(exceptions,t),tslib_es6.__exportStar(log$1,t),tslib_es6.__exportStar(messages,t),tslib_es6.__exportStar(session$1,t),tslib_es6.__exportStar(subscription$1,t),tslib_es6.__exportStar(transactions,t),tslib_es6.__exportStar(userAgentCore$1,t),tslib_es6.__exportStar(userAgents,t),tslib_es6.__exportStar(timers,t),tslib_es6.__exportStar(transport,t)}));unwrapExports(core$1);var _args=[["sip.js@0.14.4","/home/jos/Projects/Spindle/vialer/vialer-web-calling"]],_from="sip.js@0.14.4",_id="sip.js@0.14.4",_inBundle=!1,_integrity="sha512-98630KJpNeLz2VvHNBJPmaq9ZPC9b2VeEMdfF9kLJ+mB2J+TjW4Wfz1ArCDrSBkVuIa28lqISDjk8iConUx6UA==",_location="/sip.js",_phantomChildren={},_requested={type:"version",registry:!0,raw:"sip.js@0.14.4",name:"sip.js",escapedName:"sip.js",rawSpec:"0.14.4",saveSpec:null,fetchSpec:"0.14.4"},_requiredBy=["/"],_resolved="https://registry.npmjs.org/sip.js/-/sip.js-0.14.4.tgz",_spec="0.14.4",_where="/home/jos/Projects/Spindle/vialer/vialer-web-calling",author={name:"OnSIP",email:"developer@onsip.com",url:"https://sipjs.com/aboutus/"},bugs={url:"https://github.com/onsip/SIP.js/issues"},contributors=[{url:"https://github.com/onsip/SIP.js/blob/master/THANKS.md"}],dependencies={"crypto-js":"^3.1.9-1"},description="A simple, intuitive, and powerful JavaScript signaling library",devDependencies={"@types/crypto-js":"^3.1.43","@types/jasmine":"^3.3.13","@types/node":"^12.0.7","circular-dependency-plugin":"^5.0.2","jasmine-core":"^3.4.0",karma:"^4.1.0","karma-chrome-launcher":"^2.2.0","karma-cli":"^2.0.0","karma-jasmine":"^2.0.1","karma-jasmine-html-reporter":"^1.4.2","karma-mocha-reporter":"^2.2.5","karma-sourcemap-loader":"^0.3.7","karma-webpack":"^3.0.5",pegjs:"^0.10.0","ts-loader":"^6.0.2","ts-pegjs":"0.2.5",tslint:"^5.17.0",typescript:"^3.5.1",webpack:"^4.33.0","webpack-cli":"^3.3.3"},engines={node:">=8.0"},homepage="https://sipjs.com",keywords=["sip","webrtc","library","websocket","javascript","typescript"],license="MIT",main="./lib/index.js",name="sip.js",repository={type:"git",url:"git+https://github.com/onsip/SIP.js.git"},scripts={browserTest:"npm run build-test && sleep 2 && open http://0.0.0.0:9876/debug.html & karma start --reporters kjhtml --no-single-run",build:"npm run generate-grammar && npm run build-lib && npm run build-reg-bundle && npm run build-min-bundle && npm run copy-dist-files","build-bundles":"npm run build-reg-bundle && npm run build-min-bundle","build-lib":"tsc -p src","build-min-bundle":"webpack --progress --config build/webpack.config.js --env.buildType min","build-reg-bundle":"webpack --progress --config build/webpack.config.js --env.buildType reg","build-test":"tsc -p test",buildAndBrowserTest:"npm run build && npm run browserTest",buildAndTest:"npm run build && npm run commandLineTest",commandLineTest:"npm run build-test && karma start --reporters mocha --browsers ChromeHeadless --single-run","copy-dist-files":"cp dist/sip.js dist/sip-$npm_package_version.js && cp dist/sip.min.js dist/sip-$npm_package_version.min.js","generate-grammar":"node build/grammarGenerator.js",prebuild:"tslint -p tsconfig-base.json -c tslint.json"},title="SIP.js",types="./lib/index.d.ts",version="0.14.4",_package={_args:_args,_from:_from,_id:_id,_inBundle:_inBundle,_integrity:_integrity,_location:_location,_phantomChildren:_phantomChildren,_requested:_requested,_requiredBy:_requiredBy,_resolved:_resolved,_spec:_spec,_where:_where,author:author,bugs:bugs,contributors:contributors,dependencies:dependencies,description:description,devDependencies:devDependencies,engines:engines,homepage:homepage,keywords:keywords,license:license,main:main,name:name,repository:repository,scripts:scripts,title:title,types:types,version:version},_package$1=Object.freeze({_args:_args,_from:_from,_id:_id,_inBundle:_inBundle,_integrity:_integrity,_location:_location,_phantomChildren:_phantomChildren,_requested:_requested,_requiredBy:_requiredBy,_resolved:_resolved,_spec:_spec,_where:_where,author:author,bugs:bugs,contributors:contributors,dependencies:dependencies,description:description,devDependencies:devDependencies,engines:engines,homepage:homepage,keywords:keywords,license:license,main:main,name:name,repository:repository,scripts:scripts,title:title,types:types,version:version,default:_package}),pkg=getCjsExportFromNamespace(_package$1),Constants=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.USER_AGENT=pkg.title+"/"+pkg.version,e.SIP="sip",e.SIPS="sips",function(e){e.CONNECTION_ERROR="Connection Error",e.INTERNAL_ERROR="Internal Error",e.REQUEST_TIMEOUT="Request Timeout",e.SIP_FAILURE_CODE="SIP Failure Code",e.ADDRESS_INCOMPLETE="Address Incomplete",e.AUTHENTICATION_ERROR="Authentication Error",e.BUSY="Busy",e.DIALOG_ERROR="Dialog Error",e.INCOMPATIBLE_SDP="Incompatible SDP",e.NOT_FOUND="Not Found",e.REDIRECTED="Redirected",e.REJECTED="Rejected",e.UNAVAILABLE="Unavailable",e.BAD_MEDIA_DESCRIPTION="Bad Media Description",e.CANCELED="Canceled",e.EXPIRES="Expires",e.NO_ACK="No ACK",e.NO_ANSWER="No Answer",e.NO_PRACK="No PRACK",e.RTP_TIMEOUT="RTP Timeout",e.USER_DENIED_MEDIA_ACCESS="User Denied Media Access",e.WEBRTC_ERROR="WebRTC Error",e.WEBRTC_NOT_SUPPORTED="WebRTC Not Supported"}(e.causes||(e.causes={})),function(e){e.REQUIRED="required",e.SUPPORTED="supported",e.UNSUPPORTED="none"}(e.supported||(e.supported={})),e.SIP_ERROR_CAUSES={ADDRESS_INCOMPLETE:[484],AUTHENTICATION_ERROR:[401,407],BUSY:[486,600],INCOMPATIBLE_SDP:[488,606],NOT_FOUND:[404,604],REDIRECTED:[300,301,302,305,380],REJECTED:[403,603],UNAVAILABLE:[480,410,408,430]},e.ACK="ACK",e.BYE="BYE",e.CANCEL="CANCEL",e.INFO="INFO",e.INVITE="INVITE",e.MESSAGE="MESSAGE",e.NOTIFY="NOTIFY",e.OPTIONS="OPTIONS",e.REGISTER="REGISTER",e.UPDATE="UPDATE",e.SUBSCRIBE="SUBSCRIBE",e.PUBLISH="PUBLISH",e.REFER="REFER",e.PRACK="PRACK",e.REASON_PHRASE={100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"},e.OPTION_TAGS={"100rel":!0,199:!0,answermode:!0,"early-session":!0,eventlist:!0,explicitsub:!0,"from-change":!0,"geolocation-http":!0,"geolocation-sip":!0,gin:!0,gruu:!0,histinfo:!0,ice:!0,join:!0,"multiple-refer":!0,norefersub:!0,nosub:!0,outbound:!0,path:!0,policy:!0,precondition:!0,pref:!0,privacy:!0,"recipient-list-invite":!0,"recipient-list-message":!0,"recipient-list-subscribe":!0,replaces:!0,"resource-priority":!0,"sdp-anat":!0,"sec-agree":!0,tdialog:!0,timer:!0,uui:!0},function(e){e.INFO="info",e.RTP="rtp"}(e.dtmfType||(e.dtmfType={}))}(t.C||(t.C={}))}));unwrapExports(Constants);var Constants_1=Constants.C,Enums=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.STATUS_EARLY=1]="STATUS_EARLY",e[e.STATUS_CONFIRMED=2]="STATUS_CONFIRMED"}(t.DialogStatus||(t.DialogStatus={})),function(e){e[e.STATUS_NULL=0]="STATUS_NULL",e[e.STATUS_INVITE_SENT=1]="STATUS_INVITE_SENT",e[e.STATUS_1XX_RECEIVED=2]="STATUS_1XX_RECEIVED",e[e.STATUS_INVITE_RECEIVED=3]="STATUS_INVITE_RECEIVED",e[e.STATUS_WAITING_FOR_ANSWER=4]="STATUS_WAITING_FOR_ANSWER",e[e.STATUS_ANSWERED=5]="STATUS_ANSWERED",e[e.STATUS_WAITING_FOR_PRACK=6]="STATUS_WAITING_FOR_PRACK",e[e.STATUS_WAITING_FOR_ACK=7]="STATUS_WAITING_FOR_ACK",e[e.STATUS_CANCELED=8]="STATUS_CANCELED",e[e.STATUS_TERMINATED=9]="STATUS_TERMINATED",e[e.STATUS_ANSWERED_WAITING_FOR_PRACK=10]="STATUS_ANSWERED_WAITING_FOR_PRACK",e[e.STATUS_EARLY_MEDIA=11]="STATUS_EARLY_MEDIA",e[e.STATUS_CONFIRMED=12]="STATUS_CONFIRMED"}(t.SessionStatus||(t.SessionStatus={})),function(e){e[e.ClientContext=0]="ClientContext",e[e.ConfigurationError=1]="ConfigurationError",e[e.Dialog=2]="Dialog",e[e.DigestAuthentication=3]="DigestAuthentication",e[e.DTMF=4]="DTMF",e[e.IncomingMessage=5]="IncomingMessage",e[e.IncomingRequest=6]="IncomingRequest",e[e.IncomingResponse=7]="IncomingResponse",e[e.InvalidStateError=8]="InvalidStateError",e[e.InviteClientContext=9]="InviteClientContext",e[e.InviteServerContext=10]="InviteServerContext",e[e.Logger=11]="Logger",e[e.LoggerFactory=12]="LoggerFactory",e[e.MethodParameterError=13]="MethodParameterError",e[e.NameAddrHeader=14]="NameAddrHeader",e[e.NotSupportedError=15]="NotSupportedError",e[e.OutgoingRequest=16]="OutgoingRequest",e[e.Parameters=17]="Parameters",e[e.PublishContext=18]="PublishContext",e[e.ReferClientContext=19]="ReferClientContext",e[e.ReferServerContext=20]="ReferServerContext",e[e.RegisterContext=21]="RegisterContext",e[e.RenegotiationError=22]="RenegotiationError",e[e.RequestSender=23]="RequestSender",e[e.ServerContext=24]="ServerContext",e[e.Session=25]="Session",e[e.SessionDescriptionHandler=26]="SessionDescriptionHandler",e[e.SessionDescriptionHandlerError=27]="SessionDescriptionHandlerError",e[e.SessionDescriptionHandlerObserver=28]="SessionDescriptionHandlerObserver",e[e.Subscription=29]="Subscription",e[e.Transport=30]="Transport",e[e.UA=31]="UA",e[e.URI=32]="URI"}(t.TypeStrings||(t.TypeStrings={})),function(e){e[e.STATUS_INIT=0]="STATUS_INIT",e[e.STATUS_STARTING=1]="STATUS_STARTING",e[e.STATUS_READY=2]="STATUS_READY",e[e.STATUS_USER_CLOSED=3]="STATUS_USER_CLOSED",e[e.STATUS_NOT_READY=4]="STATUS_NOT_READY"}(t.UAStatus||(t.UAStatus={}))}));unwrapExports(Enums);var Enums_1=Enums.DialogStatus,Enums_2=Enums.SessionStatus,Enums_3=Enums.TypeStrings,Enums_4=Enums.UAStatus,Utils_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.defer=function(){var e={};return e.promise=new Promise((function(t,r){e.resolve=t,e.reject=r})),e},e.reducePromises=function(e,t){return e.reduce((function(e,t){return e=e.then(t)}),Promise.resolve(t))},e.str_utf8_length=function(e){return encodeURIComponent(e).replace(/%[A-F\d]{2}/g,"U").length},e.generateFakeSDP=function(e){if(e){var t=e.indexOf("o="),r=e.indexOf("\r\n",t);return"v=0\r\n"+e.slice(t,r)+"\r\ns=-\r\nt=0 0\r\nc=IN IP4 0.0.0.0"}},e.isDecimal=function(e){var t=parseInt(e,10);return!isNaN(t)&&parseFloat(e)===t},e.createRandomToken=function(e,t){void 0===t&&(t=32);for(var r="",s=0;s<e;s++){r+=Math.floor(Math.random()*t).toString(t)}return r},e.newTag=function(){return e.createRandomToken(10)},e.newUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=Math.floor(16*Math.random());return("x"===e?t:t%4+8).toString(16)}))},e.normalizeTarget=function(t,r){if(t){if(t instanceof uri.URI)return t;if("string"==typeof t){var s=t.split("@"),i=void 0,n=void 0;switch(s.length){case 1:if(!r)return;i=t,n=r;break;case 2:i=s[0],n=s[1];break;default:i=s.slice(0,s.length-1).join("@"),n=s[s.length-1]}return i=i.replace(/^(sips?|tel):/i,""),/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(i)&&(i=i.replace(/[\-\.\(\)]/g,"")),t=Constants.C.SIP+":"+e.escapeUser(i)+"@"+n,grammar$1.Grammar.URIParse(t)}}else;},e.escapeUser=function(e){return encodeURIComponent(decodeURIComponent(e)).replace(/%3A/gi,":").replace(/%2B/gi,"+").replace(/%3F/gi,"?").replace(/%2F/gi,"/")},e.headerize=function(e){for(var t={"Call-Id":"Call-ID",Cseq:"CSeq","Min-Se":"Min-SE",Rack:"RAck",Rseq:"RSeq","Www-Authenticate":"WWW-Authenticate"},r=e.toLowerCase().replace(/_/g,"-").split("-"),s=r.length,i="",n=0;n<s;n++)0!==n&&(i+="-"),i+=r[n].charAt(0).toUpperCase()+r[n].substring(1);return t[i]&&(i=t[i]),i},e.sipErrorCause=function(e){for(var t in Constants.C.SIP_ERROR_CAUSES)if(-1!==Constants.C.SIP_ERROR_CAUSES[t].indexOf(e))return Constants.C.causes[t];return Constants.C.causes.SIP_FAILURE_CODE},e.getReasonPhrase=function(e,t){return t||Constants.C.REASON_PHRASE[e]||""},e.getReasonHeaderValue=function(t,r){return"SIP;cause="+t+';text="'+(r=e.getReasonPhrase(t,r))+'"'},e.getCancelReason=function(t,r){if(t&&t<200||t>699)throw new TypeError("Invalid statusCode: "+t);if(t)return e.getReasonHeaderValue(t,r)},e.buildStatusLine=function(t,r){if(!t||t<100||t>699)throw new TypeError("Invalid statusCode: "+t);if(r&&"string"!=typeof r&&!(r instanceof String))throw new TypeError("Invalid reason: "+r);return"SIP/2.0 "+t+" "+(r=e.getReasonPhrase(t,r))+"\r\n"},e.fromBodyObj=function(e){var t=e.body,r=e.contentType;return{contentDisposition:function(e){return"application/sdp"===e?"session":"render"}(r),contentType:r,content:t}},e.toBodyObj=function(e){return{body:e.content,contentType:e.contentType}}}(t.Utils||(t.Utils={}))}));unwrapExports(Utils_1);var Utils_2=Utils_1.Utils,ClientContext_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(r,s,i,n){var o=e.call(this)||this;return o.data={},t.initializer(o,r,s,i,n),o}return tslib_es6.__extends(t,e),t.initializer=function(e,t,r,s,i){if(e.type=Enums.TypeStrings.ClientContext,void 0===s)throw new TypeError("Not enough arguments");e.ua=t,e.logger=t.getLogger("sip.clientcontext"),e.method=r;var n=t.normalizeTarget(s);if(!n)throw new TypeError("Invalid target: "+s);var o=t.userAgentCore.configuration.aor;if(i&&i.params&&i.params.fromUri&&!(o="string"==typeof i.params.fromUri?core$1.Grammar.URIParse(i.params.fromUri):i.params.fromUri))throw new TypeError("Invalid from URI: "+i.params.fromUri);var a=n;if(i&&i.params&&i.params.toUri&&!(a="string"==typeof i.params.toUri?core$1.Grammar.URIParse(i.params.toUri):i.params.toUri))throw new TypeError("Invalid to URI: "+i.params.toUri);var c,u,d=((i=(i=Object.create(i||Object.prototype))||{}).extraHeaders||[]).slice(),l=i.params||{};i.body&&(c={body:i.body,contentType:i.contentType?i.contentType:"application/sdp"},e.body=c),c&&(u=Utils_1.Utils.fromBodyObj(c)),e.request=t.userAgentCore.makeOutgoingRequestMessage(r,n,o,a,l,d,u),e.request.from&&(e.localIdentity=e.request.from),e.request.to&&(e.remoteIdentity=e.request.to)},t.prototype.send=function(){var e=this;return this.ua.userAgentCore.request(this.request,{onAccept:function(t){return e.receiveResponse(t.message)},onProgress:function(t){return e.receiveResponse(t.message)},onRedirect:function(t){return e.receiveResponse(t.message)},onReject:function(t){return e.receiveResponse(t.message)},onTrying:function(t){return e.receiveResponse(t.message)}}),this},t.prototype.receiveResponse=function(e){var t=e.statusCode||0,r=Utils_1.Utils.getReasonPhrase(t);switch(!0){case/^1[0-9]{2}$/.test(t.toString()):this.emit("progress",e,r);break;case/^2[0-9]{2}$/.test(t.toString()):this.ua.applicants[this.toString()]&&delete this.ua.applicants[this.toString()],this.emit("accepted",e,r);break;default:this.ua.applicants[this.toString()]&&delete this.ua.applicants[this.toString()],this.emit("rejected",e,r),this.emit("failed",e,r)}},t.prototype.onRequestTimeout=function(){this.emit("failed",void 0,Constants.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",void 0,Constants.C.causes.CONNECTION_ERROR)},t}(EventEmitter.EventEmitter);t.ClientContext=r}));unwrapExports(ClientContext_1);var ClientContext_2=ClientContext_1.ClientContext,Exceptions_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){var t=function(e){function t(){return e.call(this,"The session description handler has closed.")||this}return tslib_es6.__extends(t,e),t}(core$1.Exception);e.ClosedSessionDescriptionHandlerError=t;var r=function(e){function t(){return e.call(this,"The session has terminated.")||this}return tslib_es6.__extends(t,e),t}(core$1.Exception);e.TerminatedSessionError=r;var s=function(e){function t(t){return e.call(this,t||"Unsupported session description content type.")||this}return tslib_es6.__extends(t,e),t}(core$1.Exception);e.UnsupportedSessionDescriptionContentTypeError=s}(t.Exceptions||(t.Exceptions={}));var r=function(e){function t(t,r,s){var i=e.call(this,s)||this;return i.code=t,i.name=r,i.message=s,i}return tslib_es6.__extends(t,e),t}(core$1.Exception);!function(e){var t=function(e){function t(t,r){var s=e.call(this,1,"CONFIGURATION_ERROR",r?"Invalid value "+JSON.stringify(r)+" for parameter '"+t+"'":"Missing parameter: "+t)||this;return s.type=Enums.TypeStrings.ConfigurationError,s.parameter=t,s.value=r,s}return tslib_es6.__extends(t,e),t}(r);e.ConfigurationError=t;var s=function(e){function t(t){var r=e.call(this,2,"INVALID_STATE_ERROR","Invalid status: "+t)||this;return r.type=Enums.TypeStrings.InvalidStateError,r.status=t,r}return tslib_es6.__extends(t,e),t}(r);e.InvalidStateError=s;var i=function(e){function t(t){var r=e.call(this,3,"NOT_SUPPORTED_ERROR",t)||this;return r.type=Enums.TypeStrings.NotSupportedError,r}return tslib_es6.__extends(t,e),t}(r);e.NotSupportedError=i;var n=function(e){function t(t){var r=e.call(this,5,"RENEGOTIATION_ERROR",t)||this;return r.type=Enums.TypeStrings.RenegotiationError,r}return tslib_es6.__extends(t,e),t}(r);e.RenegotiationError=n;var o=function(e){function t(t,r,s){var i=e.call(this,6,"METHOD_PARAMETER_ERROR",s?"Invalid value "+JSON.stringify(s)+" for parameter '"+r+"'":"Missing parameter: "+r)||this;return i.type=Enums.TypeStrings.MethodParameterError,i.method=t,i.parameter=r,i.value=s,i}return tslib_es6.__extends(t,e),t}(r);e.MethodParameterError=o;var a=function(e){function t(t,r,s){var i=e.call(this,8,"SESSION_DESCRIPTION_HANDLER_ERROR",s||"Error with Session Description Handler")||this;return i.type=Enums.TypeStrings.SessionDescriptionHandlerError,i.method=t,i.error=r,i}return tslib_es6.__extends(t,e),t}(r);e.SessionDescriptionHandlerError=a}(t.Exceptions||(t.Exceptions={}))}));unwrapExports(Exceptions_1);var Exceptions_2=Exceptions_1.Exceptions,Parser_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){function t(e,t){var r=t,s=0,i=0;if(e.substring(r,r+2).match(/(^\r\n)/))return-2;for(;0===s;){if(-1===(i=e.indexOf("\r\n",r)))return i;!e.substring(i+2,i+4).match(/(^\r\n)/)&&e.charAt(i+2).match(/(^\s+)/)?r=i+2:s=i}return s}function r(e,t,r,s){var i,n=t.indexOf(":",r),o=t.substring(r,n).trim(),a=t.substring(n+1,s).trim();switch(o.toLowerCase()){case"via":case"v":e.addHeader("via",a),1===e.getHeaders("via").length?(i=e.parseHeader("Via"))&&(e.via=i,e.viaBranch=i.branch):i=0;break;case"from":case"f":e.setHeader("from",a),(i=e.parseHeader("from"))&&(e.from=i,e.fromTag=i.getParam("tag"));break;case"to":case"t":e.setHeader("to",a),(i=e.parseHeader("to"))&&(e.to=i,e.toTag=i.getParam("tag"));break;case"record-route":if(-1===(i=core$1.Grammar.parse(a,"Record_Route"))){i=void 0;break}for(var c in i)i[c]&&(e.addHeader("record-route",a.substring(i[c].position,i[c].offset)),e.headers["Record-Route"][e.getHeaders("record-route").length-1].parsed=i[c].parsed);break;case"call-id":case"i":e.setHeader("call-id",a),(i=e.parseHeader("call-id"))&&(e.callId=a);break;case"contact":case"m":if(-1===(i=core$1.Grammar.parse(a,"Contact"))){i=void 0;break}if(!(i instanceof Array)){i=void 0;break}i.forEach((function(t){e.addHeader("contact",a.substring(t.position,t.offset)),e.headers.Contact[e.getHeaders("contact").length-1].parsed=t.parsed}));break;case"content-length":case"l":e.setHeader("content-length",a),i=e.parseHeader("content-length");break;case"content-type":case"c":e.setHeader("content-type",a),i=e.parseHeader("content-type");break;case"cseq":e.setHeader("cseq",a),(i=e.parseHeader("cseq"))&&(e.cseq=i.value),e instanceof core$1.IncomingResponseMessage&&(e.method=i.method);break;case"max-forwards":e.setHeader("max-forwards",a),i=e.parseHeader("max-forwards");break;case"www-authenticate":e.setHeader("www-authenticate",a),i=e.parseHeader("www-authenticate");break;case"proxy-authenticate":e.setHeader("proxy-authenticate",a),i=e.parseHeader("proxy-authenticate");break;case"refer-to":case"r":e.setHeader("refer-to",a),(i=e.parseHeader("refer-to"))&&(e.referTo=i);break;default:e.setHeader(o,a),i=0}return void 0!==i||{error:"error parsing header '"+o+"'"}}e.getHeader=t,e.parseHeader=r,e.parseMessage=function(e,s){var i=0,n=e.indexOf("\r\n");if(-1!==n){var o,a=e.substring(0,n),c=core$1.Grammar.parse(a,"Request_Response");if(-1!==c){var u;for(c.status_code?((o=new core$1.IncomingResponseMessage).statusCode=c.status_code,o.reasonPhrase=c.reason_phrase):((o=new core$1.IncomingRequestMessage).method=c.method,o.ruri=c.uri),o.data=e,i=n+2;;){if(-2===(n=t(e,i))){u=i+2;break}if(-1===n)return void s.error("malformed message");if(!0!==r(o,e,i,n))return void s.error(c.error);i=n+2}return o.hasHeader("content-length")?o.body=e.substr(u,Number(o.getHeader("content-length"))):o.body=e.substring(u),o}s.warn('error parsing first line of SIP message: "'+a+'"')}else s.warn("no CRLF found, not a SIP message, discarded")}}(t.Parser||(t.Parser={}))}));unwrapExports(Parser_1);var Parser_2=Parser_1.Parser,PublishContext_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i){void 0===i&&(i={});var n=this;if(i.extraHeaders=(i.extraHeaders||[]).slice(),i.contentType=i.contentType||"text/plain","number"!=typeof i.expires||i.expires%1!=0?i.expires=3600:i.expires=Number(i.expires),"boolean"!=typeof i.unpublishOnClose&&(i.unpublishOnClose=!0),null==r||""===r)throw new Exceptions_1.Exceptions.MethodParameterError("Publish","Target",r);if(void 0===(r=t.normalizeTarget(r)))throw new Exceptions_1.Exceptions.MethodParameterError("Publish","Target",r);if((n=e.call(this,t,Constants.C.PUBLISH,r,i)||this).type=Enums.TypeStrings.PublishContext,n.options=i,n.target=r,null==s||""===s)throw new Exceptions_1.Exceptions.MethodParameterError("Publish","Event",s);return n.event=s,n.logger=t.getLogger("sip.publish"),n.pubRequestExpires=n.options.expires,t.on("transportCreated",(function(e){e.on("transportError",(function(){return n.onTransportError()}))})),n}return tslib_es6.__extends(t,e),t.prototype.publish=function(e){this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.options.body=e,this.pubRequestBody=this.options.body,0===this.pubRequestExpires&&(this.pubRequestExpires=this.options.expires,this.pubRequestEtag=void 0),this.ua.publishers[this.target.toString()+":"+this.event]||(this.ua.publishers[this.target.toString()+":"+this.event]=this),this.sendPublishRequest()},t.prototype.unpublish=function(){this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,this.pubRequestExpires=0,void 0!==this.pubRequestEtag&&this.sendPublishRequest()},t.prototype.close=function(){this.options.unpublishOnClose?this.unpublish():(this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,this.pubRequestExpires=0,this.pubRequestEtag=void 0),this.ua.publishers[this.target.toString()+":"+this.event]&&delete this.ua.publishers[this.target.toString()+":"+this.event]},t.prototype.onRequestTimeout=function(){e.prototype.onRequestTimeout.call(this),this.emit("unpublished",void 0,Constants.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){e.prototype.onTransportError.call(this),this.emit("unpublished",void 0,Constants.C.causes.CONNECTION_ERROR)},t.prototype.receiveResponse=function(e){var t=this,r=e.statusCode||0,s=Utils_1.Utils.getReasonPhrase(r);switch(!0){case/^1[0-9]{2}$/.test(r.toString()):this.emit("progress",e,s);break;case/^2[0-9]{2}$/.test(r.toString()):if(e.hasHeader("SIP-ETag")?this.pubRequestEtag=e.getHeader("SIP-ETag"):this.logger.warn("SIP-ETag header missing in a 200-class response to PUBLISH"),e.hasHeader("Expires")){var i=Number(e.getHeader("Expires"));"number"==typeof i&&i>=0&&i<=this.pubRequestExpires?this.pubRequestExpires=i:this.logger.warn("Bad Expires header in a 200-class response to PUBLISH")}else this.logger.warn("Expires header missing in a 200-class response to PUBLISH");0!==this.pubRequestExpires?(this.publishRefreshTimer=setTimeout((function(){return t.refreshRequest()}),900*this.pubRequestExpires),this.emit("published",e,s)):this.emit("unpublished",e,s);break;case/^412$/.test(r.toString()):void 0!==this.pubRequestEtag&&0!==this.pubRequestExpires?(this.logger.warn("412 response to PUBLISH, recovering"),this.pubRequestEtag=void 0,this.emit("progress",e,s),this.publish(this.options.body)):(this.logger.warn("412 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",e,s),this.emit("unpublished",e,s));break;case/^423$/.test(r.toString()):if(0!==this.pubRequestExpires&&e.hasHeader("Min-Expires")){var n=Number(e.getHeader("Min-Expires"));"number"==typeof n||n>this.pubRequestExpires?(this.logger.warn("423 code in response to PUBLISH, adjusting the Expires value and trying to recover"),this.pubRequestExpires=n,this.emit("progress",e,s),this.publish(this.options.body)):(this.logger.warn("Bad 423 response Min-Expires header received for PUBLISH"),this.pubRequestExpires=0,this.emit("failed",e,s),this.emit("unpublished",e,s))}else this.logger.warn("423 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",e,s),this.emit("unpublished",e,s);break;default:this.pubRequestExpires=0,this.emit("failed",e,s),this.emit("unpublished",e,s)}0===this.pubRequestExpires&&(this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,this.pubRequestEtag=void 0)},t.prototype.send=function(){var e=this;return this.ua.userAgentCore.publish(this.request,{onAccept:function(t){return e.receiveResponse(t.message)},onProgress:function(t){return e.receiveResponse(t.message)},onRedirect:function(t){return e.receiveResponse(t.message)},onReject:function(t){return e.receiveResponse(t.message)},onTrying:function(t){return e.receiveResponse(t.message)}}),this},t.prototype.refreshRequest=function(){if(this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,void 0===this.pubRequestEtag)throw new Exceptions_1.Exceptions.MethodParameterError("Publish","Body",void 0);if(0===this.pubRequestExpires)throw new Exceptions_1.Exceptions.MethodParameterError("Publish","Expire",this.pubRequestExpires);this.sendPublishRequest()},t.prototype.sendPublishRequest=function(){var e=Object.create(this.options||Object.prototype);e.extraHeaders=(this.options.extraHeaders||[]).slice(),e.extraHeaders.push("Event: "+this.event),e.extraHeaders.push("Expires: "+this.pubRequestExpires),void 0!==this.pubRequestEtag&&e.extraHeaders.push("SIP-If-Match: "+this.pubRequestEtag);var t=this.target instanceof core$1.URI?this.target:this.ua.normalizeTarget(this.target);if(!t)throw new Error("ruri undefined.");var r,s,i=this.options.params||{};void 0!==this.pubRequestBody&&(r={body:this.pubRequestBody,contentType:this.options.contentType}),r&&(s=Utils_1.Utils.fromBodyObj(r)),this.request=this.ua.userAgentCore.makeOutgoingRequestMessage(Constants.C.PUBLISH,t,i.fromUri?i.fromUri:this.ua.userAgentCore.configuration.aor,i.toUri?i.toUri:this.target,i,e.extraHeaders,s),this.send()},t}(ClientContext_1.ClientContext);t.PublishContext=r}));unwrapExports(PublishContext_1);var PublishContext_2=PublishContext_1.PublishContext,ServerContext_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(r,s){var i=e.call(this)||this;return i.incomingRequest=s,i.data={},t.initializer(i,r,s),i}return tslib_es6.__extends(t,e),t.initializer=function(e,t,r){var s=r.message;if(e.type=Enums.TypeStrings.ServerContext,e.ua=t,e.logger=t.getLogger("sip.servercontext"),e.request=s,s.body&&(e.body=s.body),s.hasHeader("Content-Type")&&(e.contentType=s.getHeader("Content-Type")),e.method=s.method,e.localIdentity=s.to,e.remoteIdentity=s.from,s.hasHeader("P-Asserted-Identity")){var i=s.getHeader("P-Asserted-Identity");i&&(e.assertedIdentity=core$1.Grammar.nameAddrHeaderParse(i))}},t.prototype.progress=function(e){return void 0===e&&(e={}),e.statusCode=e.statusCode||180,e.minCode=100,e.maxCode=199,e.events=["progress"],this.reply(e)},t.prototype.accept=function(e){return void 0===e&&(e={}),e.statusCode=e.statusCode||200,e.minCode=200,e.maxCode=299,e.events=["accepted"],this.reply(e)},t.prototype.reject=function(e){return void 0===e&&(e={}),e.statusCode=e.statusCode||480,e.minCode=300,e.maxCode=699,e.events=["rejected","failed"],this.reply(e)},t.prototype.reply=function(e){var t=this;void 0===e&&(e={});var r=e.statusCode||100,s=e.minCode||100,i=e.maxCode||699,n=Utils_1.Utils.getReasonPhrase(r,e.reasonPhrase),o=e.extraHeaders||[],a=e.body?core$1.fromBodyLegacy(e.body):void 0,c=e.events||[];if(r<s||r>i)throw new TypeError("Invalid statusCode: "+r);var u,d={statusCode:r,reasonPhrase:n,extraHeaders:o,body:a},l=r.toString();switch(!0){case/^100$/.test(l):u=this.incomingRequest.trying(d).message;break;case/^1[0-9]{2}$/.test(l):u=this.incomingRequest.progress(d).message;break;case/^2[0-9]{2}$/.test(l):u=this.incomingRequest.accept(d).message;break;case/^3[0-9]{2}$/.test(l):u=this.incomingRequest.redirect([],d).message;break;case/^[4-6][0-9]{2}$/.test(l):u=this.incomingRequest.reject(d).message;break;default:throw new Error("Invalid status code "+r)}return c.forEach((function(e){t.emit(e,u,n)})),this},t.prototype.onRequestTimeout=function(){this.emit("failed",void 0,Constants.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",void 0,Constants.C.causes.CONNECTION_ERROR)},t}(EventEmitter.EventEmitter);t.ServerContext=r}));unwrapExports(ServerContext_1);var ServerContext_2=ServerContext_1.ServerContext,ReferContext=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i){void 0===i&&(i={});var n=this;if(void 0===t||void 0===r||void 0===s)throw new TypeError("Not enough arguments");return(n=e.call(this,t,Constants.C.REFER,r.remoteIdentity.uri.toString(),i)||this).type=Enums.TypeStrings.ReferClientContext,n.options=i,n.extraHeaders=(n.options.extraHeaders||[]).slice(),n.applicant=r,n.target=n.initReferTo(s),n.ua&&n.extraHeaders.push("Referred-By: <"+n.ua.configuration.uri+">"),n.extraHeaders.push("Contact: "+r.contact),n.extraHeaders.push("Allow: "+["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"].toString()),n.extraHeaders.push("Refer-To: "+n.target),n.errorListener=n.onTransportError.bind(n),t.transport&&t.transport.on("transportError",n.errorListener),n}return tslib_es6.__extends(t,e),t.prototype.refer=function(e){var t=this;void 0===e&&(e={});var r=(this.extraHeaders||[]).slice();return e.extraHeaders&&r.concat(e.extraHeaders),this.applicant.sendRequest(Constants.C.REFER,{extraHeaders:this.extraHeaders,receiveResponse:function(r){var s=r&&r.statusCode?r.statusCode.toString():"";/^1[0-9]{2}$/.test(s)?t.emit("referRequestProgress",t):/^2[0-9]{2}$/.test(s)?t.emit("referRequestAccepted",t):/^[4-6][0-9]{2}$/.test(s)&&t.emit("referRequestRejected",t),e.receiveResponse&&e.receiveResponse(r)}}),this},t.prototype.receiveNotify=function(e){var t=e.message.hasHeader("Content-Type")?e.message.getHeader("Content-Type"):void 0;if(t&&-1!==t.search(/^message\/sipfrag/)){var r=core$1.Grammar.parse(e.message.body,"sipfrag");if(-1===r)return void e.reject({statusCode:489,reasonPhrase:"Bad Event"});switch(!0){case/^1[0-9]{2}$/.test(r.status_code):this.emit("referProgress",this);break;case/^2[0-9]{2}$/.test(r.status_code):this.emit("referAccepted",this),!this.options.activeAfterTransfer&&this.applicant.terminate&&this.applicant.terminate();break;default:this.emit("referRejected",this)}return e.accept(),void this.emit("notify",e.message)}e.reject({statusCode:489,reasonPhrase:"Bad Event"})},t.prototype.initReferTo=function(e){var t;if("string"==typeof e){var r=core$1.Grammar.parse(e,"Refer_To");t=r&&r.uri?r.uri:e;var s=this.ua.normalizeTarget(e);if(!s)throw new TypeError("Invalid target: "+e);t=s}else{if(!e.session)throw new Error("Session undefined.");var i=e.remoteIdentity.friendlyName,n=e.session.remoteTarget.toString(),o=e.session.callId,a=e.session.remoteTag,c=e.session.localTag;t='"'+i+'" <'+n+"?Replaces="+encodeURIComponent(o+";to-tag="+a+";from-tag="+c)+">"}return t},t}(ClientContext_1.ClientContext);t.ReferClientContext=r;var s=function(e){function t(t,r,s){var i=e.call(this,t,r)||this;return i.session=s,i.type=Enums.TypeStrings.ReferServerContext,i.ua=t,i.status=Enums.SessionStatus.STATUS_INVITE_RECEIVED,i.fromTag=i.request.fromTag,i.id=i.request.callId+i.fromTag,i.contact=i.ua.contact.toString(),i.logger=t.getLogger("sip.referservercontext",i.id),i.cseq=Math.floor(1e4*Math.random()),i.callId=i.request.callId,i.fromUri=i.request.to.uri,i.fromTag=i.request.to.parameters.tag,i.remoteTarget=i.request.headers.Contact[0].parsed.uri,i.toUri=i.request.from.uri,i.toTag=i.request.fromTag,i.routeSet=i.request.getHeaders("record-route"),i.request.hasHeader("refer-to")?(i.referTo=i.request.parseHeader("refer-to"),i.referredSession=i.ua.findSession(i.request),i.request.hasHeader("referred-by")&&(i.referredBy=i.request.getHeader("referred-by")),i.referTo.uri.hasHeader("replaces")&&(i.replaces=i.referTo.uri.getHeader("replaces")),i.errorListener=i.onTransportError.bind(i),t.transport&&t.transport.on("transportError",i.errorListener),i.status=Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER,i):(i.logger.warn("Invalid REFER packet. A refer-to header is required. Rejecting refer."),i.reject(),i)}return tslib_es6.__extends(t,e),t.prototype.progress=function(){if(this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);this.incomingRequest.trying()},t.prototype.reject=function(t){if(void 0===t&&(t={}),this.status===Enums.SessionStatus.STATUS_TERMINATED)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);this.logger.log("Rejecting refer"),this.status=Enums.SessionStatus.STATUS_TERMINATED,e.prototype.reject.call(this,t),this.emit("referRequestRejected",this)},t.prototype.accept=function(e,t){var r=this;if(void 0===e&&(e={}),this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);if(this.status=Enums.SessionStatus.STATUS_ANSWERED,this.incomingRequest.accept({statusCode:202,reasonPhrase:"Accepted"}),this.emit("referRequestAccepted",this),e.followRefer){this.logger.log("Accepted refer, attempting to automatically follow it");var s=this.referTo.uri;if(!s.scheme||!s.scheme.match("^sips?$"))return this.logger.error("SIP.js can only automatically follow SIP refer target"),void this.reject();var i=e.inviteOptions||{},n=(i.extraHeaders||[]).slice();if(this.replaces&&n.push("Replaces: "+decodeURIComponent(this.replaces)),this.referredBy&&n.push("Referred-By: "+this.referredBy),i.extraHeaders=n,s.clearHeaders(),this.targetSession=this.ua.invite(s.toString(),i,t),this.emit("referInviteSent",this),this.targetSession){this.targetSession.once("progress",(function(e){var t=e.statusCode||100,s=e.reasonPhrase;r.sendNotify(("SIP/2.0 "+t+" "+s).trim()),r.emit("referProgress",r),r.referredSession&&r.referredSession.emit("referProgress",r)})),this.targetSession.once("accepted",(function(){r.logger.log("Successfully followed the refer"),r.sendNotify("SIP/2.0 200 OK"),r.emit("referAccepted",r),r.referredSession&&r.referredSession.emit("referAccepted",r)}));var o=function(e){if(r.status!==Enums.SessionStatus.STATUS_TERMINATED){if(r.logger.log("Refer was not successful. Resuming session"),e&&429===e.statusCode)return r.logger.log("Alerting referrer that identity is required."),void r.sendNotify("SIP/2.0 429 Provide Referrer Identity");r.sendNotify("SIP/2.0 603 Declined"),r.status=Enums.SessionStatus.STATUS_TERMINATED,r.emit("referRejected",r),r.referredSession&&r.referredSession.emit("referRejected")}};this.targetSession.once("rejected",o),this.targetSession.once("failed",o)}}else this.logger.log("Accepted refer, but did not automatically follow it"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)},t.prototype.sendNotify=function(e){if(this.status!==Enums.SessionStatus.STATUS_ANSWERED)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);if(-1===core$1.Grammar.parse(e,"sipfrag"))throw new Error("sipfrag body is required to send notify for refer");var t={contentDisposition:"render",contentType:"message/sipfrag",content:e};if(this.session)this.session.notify(void 0,{extraHeaders:["Event: refer","Subscription-State: terminated"],body:t});else{var r=this.ua.userAgentCore.makeOutgoingRequestMessage(Constants.C.NOTIFY,this.remoteTarget,this.fromUri,this.toUri,{cseq:this.cseq+=1,callId:this.callId,fromTag:this.fromTag,toTag:this.toTag,routeSet:this.routeSet},["Event: refer","Subscription-State: terminated","Content-Type: message/sipfrag"],t),s=this.ua.transport;if(!s)throw new Error("Transport undefined.");var i={loggerFactory:this.ua.getLoggerFactory()};new core$1.NonInviteClientTransaction(r,s,i)}},t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)},t}(ServerContext_1.ServerContext);t.ReferServerContext=s}));unwrapExports(ReferContext);var ReferContext_1=ReferContext.ReferClientContext,ReferContext_2=ReferContext.ReferServerContext,RegisterContext_1=createCommonjsModule((function(e,t){function r(e){var t={expires:600,extraContactHeaderParams:[],instanceId:void 0,params:{},regId:void 0,registrar:void 0},r={mandatory:{},optional:{expires:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>=0)return t}},extraContactHeaderParams:function(e){if(e instanceof Array)return e.filter((function(e){return"string"==typeof e}))},instanceId:function(e){if("string"==typeof e)return/^uuid:/i.test(e)&&(e=e.substr(5)),-1===core$1.Grammar.parse(e,"uuid")?void 0:e},params:function(e){if("object"==typeof e)return e},regId:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>=0)return t}},registrar:function(e){if("string"==typeof e){/^sip:/i.test(e)||(e=Constants.C.SIP+":"+e);var t=core$1.Grammar.URIParse(e);return t?t.user?void 0:t:void 0}}}};for(var s in r.mandatory){if(!e.hasOwnProperty(s))throw new Exceptions_1.Exceptions.ConfigurationError(s);var i=e[s];if(void 0===(n=r.mandatory[s](i)))throw new Exceptions_1.Exceptions.ConfigurationError(s,i);t[s]=n}for(var s in r.optional)if(e.hasOwnProperty(s)){var n;if((i=e[s])instanceof Array&&0===i.length)continue;if(null===i||""===i||void 0===i||"number"==typeof i&&isNaN(i))continue;if(void 0===(n=r.optional[s](i)))throw new Exceptions_1.Exceptions.ConfigurationError(s,i);t[s]=n}return t}Object.defineProperty(t,"__esModule",{value:!0});var s=function(e){function t(t,s){void 0===s&&(s={});var i=this,n=r(s);if(n.regId&&!n.instanceId?n.instanceId=Utils_1.Utils.newUUID():!n.regId&&n.instanceId&&(n.regId=1),n.params.toUri=n.params.toUri||t.configuration.uri,n.params.toDisplayName=n.params.toDisplayName||t.configuration.displayName,n.params.callId=n.params.callId||Utils_1.Utils.createRandomToken(22),n.params.cseq=n.params.cseq||Math.floor(1e4*Math.random()),!n.registrar){var o={};"object"==typeof t.configuration.uri?(o=t.configuration.uri.clone()).user=void 0:o=t.configuration.uri,n.registrar=o}for(var a in(i=e.call(this,t,Constants.C.REGISTER,n.registrar,n)||this).type=Enums.TypeStrings.RegisterContext,i.options=n,i.logger=t.getLogger("sip.registercontext"),i.logger.log("configuration parameters for RegisterContext after validation:"),n)n.hasOwnProperty(a)&&i.logger.log("· "+a+": "+JSON.stringify(n[a]));return i.expires=n.expires,i.contact=t.contact.toString(),i.registered=!1,t.on("transportCreated",(function(e){e.on("disconnected",(function(){return i.onTransportDisconnected()}))})),i}return tslib_es6.__extends(t,e),t.prototype.register=function(e){var t=this;void 0===e&&(e={}),this.options=tslib_es6.__assign({},this.options,e);var r=(this.options.extraHeaders||[]).slice();r.push("Contact: "+this.generateContactHeader(this.expires)),r.push("Allow: "+["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"].toString()),this.closeHeaders=this.options.closeWithHeaders?(this.options.extraHeaders||[]).slice():[],this.receiveResponse=function(e){if(e.cseq===t.request.cseq){void 0!==t.registrationTimer&&(clearTimeout(t.registrationTimer),t.registrationTimer=void 0);var r=(e.statusCode||0).toString();switch(!0){case/^1[0-9]{2}$/.test(r):t.emit("progress",e);break;case/^2[0-9]{2}$/.test(r):t.emit("accepted",e);var s=void 0;e.hasHeader("expires")&&(s=Number(e.getHeader("expires"))),void 0!==t.registrationExpiredTimer&&(clearTimeout(t.registrationExpiredTimer),t.registrationExpiredTimer=void 0);var i=e.getHeaders("contact").length;if(!i){t.logger.warn("no Contact header in response to REGISTER, response ignored");break}for(var n=void 0;i--;){if((n=e.parseHeader("contact",i)).uri.user===t.ua.contact.uri.user){s=n.getParam("expires");break}n=void 0}if(!n){t.logger.warn("no Contact header pointing to us, response ignored");break}void 0===s&&(s=t.expires),t.registrationTimer=setTimeout((function(){t.registrationTimer=void 0,t.register(t.options)}),1e3*s-3e3),t.registrationExpiredTimer=setTimeout((function(){t.logger.warn("registration expired"),t.registered&&t.unregistered(void 0,Constants.C.causes.EXPIRES)}),1e3*s),n.hasParam("temp-gruu")&&(t.ua.contact.tempGruu=core$1.Grammar.URIParse(n.getParam("temp-gruu").replace(/"/g,""))),n.hasParam("pub-gruu")&&(t.ua.contact.pubGruu=core$1.Grammar.URIParse(n.getParam("pub-gruu").replace(/"/g,""))),t.registered=!0,t.emit("registered",e||void 0);break;case/^423$/.test(r):e.hasHeader("min-expires")?(t.expires=Number(e.getHeader("min-expires")),t.register(t.options)):(t.logger.warn("423 response received for REGISTER without Min-Expires"),t.registrationFailure(e,Constants.C.causes.SIP_FAILURE_CODE));break;default:t.registrationFailure(e,Utils_1.Utils.sipErrorCause(e.statusCode||0))}}},this.onRequestTimeout=function(){t.registrationFailure(void 0,Constants.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){t.registrationFailure(void 0,Constants.C.causes.CONNECTION_ERROR)},this.request.cseq++,this.request.setHeader("cseq",this.request.cseq+" REGISTER"),this.request.extraHeaders=r,this.send()},t.prototype.close=function(){var e={all:!1,extraHeaders:this.closeHeaders};this.registeredBefore=this.registered,this.registered&&this.unregister(e)},t.prototype.unregister=function(e){var t=this;void 0===e&&(e={}),this.registered||e.all||this.logger.warn("Already unregistered, but sending an unregister anyways.");var r=(e.extraHeaders||[]).slice();this.registered=!1,void 0!==this.registrationTimer&&(clearTimeout(this.registrationTimer),this.registrationTimer=void 0),e.all?(r.push("Contact: *"),r.push("Expires: 0")):r.push("Contact: "+this.generateContactHeader(0)),this.receiveResponse=function(e){var r=e&&e.statusCode?e.statusCode.toString():"";switch(!0){case/^1[0-9]{2}$/.test(r):t.emit("progress",e);break;case/^2[0-9]{2}$/.test(r):t.emit("accepted",e),void 0!==t.registrationExpiredTimer&&(clearTimeout(t.registrationExpiredTimer),t.registrationExpiredTimer=void 0),t.unregistered(e);break;default:t.unregistered(e,Utils_1.Utils.sipErrorCause(e.statusCode||0))}},this.onRequestTimeout=function(){},this.request.cseq++,this.request.setHeader("cseq",this.request.cseq+" REGISTER"),this.request.extraHeaders=r,this.send()},t.prototype.unregistered=function(e,t){this.registered=!1,this.emit("unregistered",e||void 0,t||void 0)},t.prototype.send=function(){var e=this;return this.ua.userAgentCore.register(this.request,{onAccept:function(t){return e.receiveResponse(t.message)},onProgress:function(t){return e.receiveResponse(t.message)},onRedirect:function(t){return e.receiveResponse(t.message)},onReject:function(t){return e.receiveResponse(t.message)},onTrying:function(t){return e.receiveResponse(t.message)}}),this},t.prototype.registrationFailure=function(e,t){this.emit("failed",e||void 0,t||void 0)},t.prototype.onTransportDisconnected=function(){this.registeredBefore=this.registered,void 0!==this.registrationTimer&&(clearTimeout(this.registrationTimer),this.registrationTimer=void 0),void 0!==this.registrationExpiredTimer&&(clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=void 0),this.registered&&this.unregistered(void 0,Constants.C.causes.CONNECTION_ERROR)},t.prototype.generateContactHeader=function(e){void 0===e&&(e=0);var t=this.contact;return this.options.regId&&this.options.instanceId&&(t+=";reg-id="+this.options.regId,t+=';+sip.instance="<urn:uuid:'+this.options.instanceId+'>"'),this.options.extraContactHeaderParams&&this.options.extraContactHeaderParams.forEach((function(e){t+=";"+e})),t+=";expires="+e},t}(ClientContext_1.ClientContext);t.RegisterContext=s}));unwrapExports(RegisterContext_1);var RegisterContext_2=RegisterContext_1.RegisterContext,DTMF_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s){void 0===s&&(s={});var i=e.call(this)||this;if(i.C={MIN_DURATION:70,MAX_DURATION:6e3,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500},i.type=Enums.TypeStrings.DTMF,void 0===r)throw new TypeError("Not enough arguments");if(i.logger=t.ua.getLogger("sip.invitecontext.dtmf",t.id),i.owner=t,"string"==typeof r)r=r.toUpperCase();else{if("number"!=typeof r)throw new TypeError("Invalid tone: "+r);r=r.toString()}if(!r.match(/^[0-9A-D#*]$/))throw new TypeError("Invalid tone: "+r);i.tone=r;var n=s.duration,o=s.interToneGap;if(n&&!Utils_1.Utils.isDecimal(n))throw new TypeError("Invalid tone duration: "+n);if(n?n<i.C.MIN_DURATION?(i.logger.warn("'duration' value is lower than the minimum allowed, setting it to "+i.C.MIN_DURATION+" milliseconds"),n=i.C.MIN_DURATION):n>i.C.MAX_DURATION?(i.logger.warn("'duration' value is greater than the maximum allowed, setting it to "+i.C.MAX_DURATION+" milliseconds"),n=i.C.MAX_DURATION):n=Math.abs(n):n=i.C.DEFAULT_DURATION,i.duration=n,o&&!Utils_1.Utils.isDecimal(o))throw new TypeError("Invalid interToneGap: "+o);return o?o<i.C.MIN_INTER_TONE_GAP?(i.logger.warn("'interToneGap' value is lower than the minimum allowed, setting it to "+i.C.MIN_INTER_TONE_GAP+" milliseconds"),o=i.C.MIN_INTER_TONE_GAP):o=Math.abs(o):o=i.C.DEFAULT_INTER_TONE_GAP,i.interToneGap=o,i}return tslib_es6.__extends(t,e),t.prototype.send=function(e){if(void 0===e&&(e={}),this.owner.status!==Enums.SessionStatus.STATUS_CONFIRMED&&this.owner.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ACK)throw new Exceptions_1.Exceptions.InvalidStateError(this.owner.status);var t=e.extraHeaders?e.extraHeaders.slice():[],r={contentType:"application/dtmf-relay",body:"Signal= "+this.tone+"\r\nDuration= "+this.duration};if(this.owner.session){var s=this.owner.session.info(void 0,{extraHeaders:t,body:Utils_1.Utils.fromBodyObj(r)});this.owner.emit("dtmf",s.message,this)}else;},t.prototype.init_incoming=function(e){e.accept(),this.tone&&this.duration?this.owner.emit("dtmf",e.message,this):this.logger.warn("invalid INFO DTMF received, discarded")},t.prototype.receiveResponse=function(e){var t=e&&e.statusCode?e.statusCode:0;switch(!0){case/^1[0-9]{2}$/.test(t.toString()):break;case/^2[0-9]{2}$/.test(t.toString()):this.emit("succeeded",{originator:"remote",response:e});break;default:var r=Utils_1.Utils.sipErrorCause(t);this.emit("failed",e,r)}},t.prototype.onRequestTimeout=function(){this.emit("failed",void 0,Constants.C.causes.REQUEST_TIMEOUT),this.owner.onRequestTimeout()},t.prototype.onTransportError=function(){this.emit("failed",void 0,Constants.C.causes.CONNECTION_ERROR),this.owner.onTransportError()},t.prototype.onDialogError=function(e){this.emit("failed",e,Constants.C.causes.DIALOG_ERROR),this.owner.onDialogError(e)},t}(EventEmitter.EventEmitter);t.DTMF=r}));unwrapExports(DTMF_1);var DTMF_2=DTMF_1.DTMF,Session_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(r){var s=e.call(this)||this;if(s.data={},s.type=Enums.TypeStrings.Session,!r)throw new Exceptions_1.Exceptions.SessionDescriptionHandlerError("A session description handler is required for the session to function");return s.status=t.C.STATUS_NULL,s.pendingReinvite=!1,s.sessionDescriptionHandlerFactory=r,s.hasOffer=!1,s.hasAnswer=!1,s.timers={ackTimer:void 0,expiresTimer:void 0,invite2xxTimer:void 0,userNoAnswerTimer:void 0,rel1xxTimer:void 0,prackTimer:void 0},s.startTime=void 0,s.endTime=void 0,s.tones=void 0,s.localHold=!1,s.earlySdp=void 0,s.rel100=Constants.C.supported.UNSUPPORTED,s}return tslib_es6.__extends(t,e),t.prototype.dtmf=function(e,t){var r=this;if(void 0===t&&(t={}),this.status!==Enums.SessionStatus.STATUS_CONFIRMED&&this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ACK)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);if(!e||!e.toString().match(/^[0-9A-D#*,]+$/i))throw new TypeError("Invalid tones: "+e);var s=function(){if(r.status!==Enums.SessionStatus.STATUS_TERMINATED&&r.tones&&0!==r.tones.length){var e,i=r.tones.shift();","===i.tone?e=2e3:(i.on("failed",(function(){r.tones=void 0})),i.send(t),e=i.duration+i.interToneGap),setTimeout(s,e)}else r.tones=void 0};e=e.toString();var i=this.ua.configuration.dtmfType;this.sessionDescriptionHandler&&i===Constants.C.dtmfType.RTP&&(this.sessionDescriptionHandler.sendDtmf(e,t)||(this.logger.warn("Attempt to use dtmfType 'RTP' has failed, falling back to INFO packet method"),i=Constants.C.dtmfType.INFO));if(i===Constants.C.dtmfType.INFO){for(var n=[],o=e.split("");o.length>0;)n.push(new DTMF_1.DTMF(this,o.shift(),t));if(this.tones)return this.tones=this.tones.concat(n),this;this.tones=n,s()}return this},t.prototype.bye=function(e){if(void 0===e&&(e={}),this.status===Enums.SessionStatus.STATUS_TERMINATED)return this.logger.error("Error: Attempted to send BYE in a terminated session."),this;this.logger.log("terminating Session");var t=e.statusCode;if(t&&(t<200||t>=700))throw new TypeError("Invalid statusCode: "+t);return e.receiveResponse=function(){},this.sendRequest(Constants.C.BYE,e).terminated()},t.prototype.refer=function(e,t){if(void 0===t&&(t={}),this.status!==Enums.SessionStatus.STATUS_CONFIRMED)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);return this.referContext=new ReferContext.ReferClientContext(this.ua,this,e,t),this.emit("referRequested",this.referContext),this.referContext.refer(t),this.referContext},t.prototype.sendRequest=function(e,t){if(void 0===t&&(t={}),!this.session)throw new Error("Session undefined.");var r;t.body&&(t.body=Utils_1.Utils.fromBodyObj(t.body));var s,i=t.receiveResponse;i&&(r={onAccept:function(e){return i(e.message)},onProgress:function(e){return i(e.message)},onRedirect:function(e){return i(e.message)},onReject:function(e){return i(e.message)},onTrying:function(e){return i(e.message)}});var n=t;switch(e){case Constants.C.BYE:s=this.session.bye(r,n);break;case Constants.C.INVITE:s=this.session.invite(r,n);break;case Constants.C.REFER:s=this.session.refer(r,n);break;default:throw new Error("Unexpected "+e+". Method not implemented by user agent core.")}return this.emit(e.toLowerCase(),s.message),this},t.prototype.close=function(){if(this.status===Enums.SessionStatus.STATUS_TERMINATED)return this;for(var e in this.logger.log("closing INVITE session "+this.id),this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.timers)this.timers[e]&&clearTimeout(this.timers[e]);return this.status=Enums.SessionStatus.STATUS_TERMINATED,this.ua.transport&&this.ua.transport.removeListener("transportError",this.errorListener),delete this.ua.sessions[this.id],this},t.prototype.hold=function(e,t){if(void 0===e&&(e={}),void 0===t&&(t=[]),this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ACK&&this.status!==Enums.SessionStatus.STATUS_CONFIRMED)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);this.localHold?this.logger.log("Session is already on hold, cannot put it on hold again"):(e.modifiers=t,this.sessionDescriptionHandler&&e.modifiers.push(this.sessionDescriptionHandler.holdModifier),this.localHold=!0,this.sendReinvite(e))},t.prototype.unhold=function(e,t){if(void 0===e&&(e={}),void 0===t&&(t=[]),this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ACK&&this.status!==Enums.SessionStatus.STATUS_CONFIRMED)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);this.localHold?(e.modifiers=t,this.localHold=!1,this.sendReinvite(e)):this.logger.log("Session is not on hold, cannot unhold it")},t.prototype.reinvite=function(e,t){return void 0===e&&(e={}),void 0===t&&(t=[]),e.modifiers=t,this.sendReinvite(e)},t.prototype.terminate=function(e){return this},t.prototype.onTransportError=function(){this.status!==Enums.SessionStatus.STATUS_CONFIRMED&&this.status!==Enums.SessionStatus.STATUS_TERMINATED&&this.failed(void 0,Constants.C.causes.CONNECTION_ERROR)},t.prototype.onRequestTimeout=function(){this.status===Enums.SessionStatus.STATUS_CONFIRMED?this.terminated(void 0,Constants.C.causes.REQUEST_TIMEOUT):this.status!==Enums.SessionStatus.STATUS_TERMINATED&&(this.failed(void 0,Constants.C.causes.REQUEST_TIMEOUT),this.terminated(void 0,Constants.C.causes.REQUEST_TIMEOUT))},t.prototype.onDialogError=function(e){this.status===Enums.SessionStatus.STATUS_CONFIRMED?this.terminated(e,Constants.C.causes.DIALOG_ERROR):this.status!==Enums.SessionStatus.STATUS_TERMINATED&&(this.failed(e,Constants.C.causes.DIALOG_ERROR),this.terminated(e,Constants.C.causes.DIALOG_ERROR))},t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)},t.prototype.onAck=function(e){var t=this,r=function(){clearTimeout(t.timers.ackTimer),clearTimeout(t.timers.invite2xxTimer),t.status=Enums.SessionStatus.STATUS_CONFIRMED;var r=e.message.getHeader("Content-Disposition");r&&"render"===r.type&&(t.renderbody=e.message.body,t.rendertype=e.message.getHeader("Content-Type")),t.emit("confirmed",e.message)};this.status===Enums.SessionStatus.STATUS_WAITING_FOR_ACK&&(this.sessionDescriptionHandler&&this.sessionDescriptionHandler.hasDescription(e.message.getHeader("Content-Type")||"")?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(e.message.body,this.sessionDescriptionHandlerOptions,this.modifiers).catch((function(r){throw t.logger.warn(r),t.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),t.failed(e.message,Constants.C.causes.BAD_MEDIA_DESCRIPTION),t.terminated(e.message,Constants.C.causes.BAD_MEDIA_DESCRIPTION),r})).then((function(){return r()}))):r())},t.prototype.receiveRequest=function(e){switch(e.message.method){case Constants.C.BYE:e.accept(),this.status===Enums.SessionStatus.STATUS_CONFIRMED&&(this.emit("bye",e.message),this.terminated(e.message,Constants.C.BYE));break;case Constants.C.INVITE:this.status===Enums.SessionStatus.STATUS_CONFIRMED&&(this.logger.log("re-INVITE received"),this.receiveReinvite(e));break;case Constants.C.INFO:if(this.status===Enums.SessionStatus.STATUS_CONFIRMED||this.status===Enums.SessionStatus.STATUS_WAITING_FOR_ACK){if(this.onInfo)return this.onInfo(e.message);var t=e.message.getHeader("content-type");if(t)if(t.match(/^application\/dtmf-relay/i)){if(e.message.body){var r=e.message.body.split("\r\n",2);if(2===r.length){var s=void 0,i=void 0,n=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/;n.test(r[0])&&(s=r[0].replace(n,"$2"));var o=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;o.test(r[1])&&(i=parseInt(r[1].replace(o,"$2"),10)),s&&i&&new DTMF_1.DTMF(this,s,{duration:i}).init_incoming(e)}}}else e.reject({statusCode:415,extraHeaders:["Accept: application/dtmf-relay"]})}break;case Constants.C.REFER:if(this.status===Enums.SessionStatus.STATUS_CONFIRMED)if(this.logger.log("REFER received"),this.referContext=new ReferContext.ReferServerContext(this.ua,e,this.session),this.listeners("referRequested").length)this.emit("referRequested",this.referContext);else{this.logger.log("No referRequested listeners, automatically accepting and following the refer");var a={followRefer:!0};this.passedOptions&&(a.inviteOptions=this.passedOptions),this.referContext.accept(a,this.modifiers)}break;case Constants.C.NOTIFY:if(this.referContext&&this.referContext.type===Enums.TypeStrings.ReferClientContext&&e.message.hasHeader("event")&&/^refer(;.*)?$/.test(e.message.getHeader("event")))return void this.referContext.receiveNotify(e);e.accept(),this.emit("notify",e.message)}},t.prototype.receiveReinvite=function(e){var t,r=this;if(this.emit("reinvite",this,e.message),e.message.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=core$1.Grammar.nameAddrHeaderParse(e.message.getHeader("P-Asserted-Identity"))),this.sessionDescriptionHandler){if("0"!==e.message.getHeader("Content-Length")||e.message.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(e.message.getHeader("Content-Type")||""))return e.reject({statusCode:415}),void this.emit("reinviteFailed",this);t=this.sessionDescriptionHandler.setDescription(e.message.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers))}else t=this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers);t.catch((function(t){var s;throw t.type===Enums.TypeStrings.SessionDescriptionHandlerError?s=500:t.type===Enums.TypeStrings.RenegotiationError?(r.emit("renegotiationError",t),r.logger.warn(t.toString()),s=488):(r.logger.error(t),s=488),e.reject({statusCode:s}),r.emit("reinviteFailed",r),t})).then((function(t){var s=["Contact: "+r.contact];e.accept({statusCode:200,extraHeaders:s,body:Utils_1.Utils.fromBodyObj(t)}),r.status=Enums.SessionStatus.STATUS_WAITING_FOR_ACK,r.emit("reinviteAccepted",r)}))}else this.logger.warn("No SessionDescriptionHandler to reinvite")},t.prototype.sendReinvite=function(e){var t=this;if(void 0===e&&(e={}),this.pendingReinvite)this.logger.warn("Reinvite in progress. Please wait until complete, then try again.");else if(this.sessionDescriptionHandler){this.pendingReinvite=!0,e.modifiers=e.modifiers||[];var r=(e.extraHeaders||[]).slice();r.push("Contact: "+this.contact),r.push("Allow: "+["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"].toString()),this.sessionDescriptionHandler.getDescription(e.sessionDescriptionHandlerOptions,e.modifiers).then((function(e){if(!t.session)throw new Error("Session undefined.");var s={onAccept:function(e){if(t.status!==Enums.SessionStatus.STATUS_TERMINATED)if(t.pendingReinvite){if(t.status=Enums.SessionStatus.STATUS_CONFIRMED,t.emit("ack",e.ack()),t.pendingReinvite=!1,clearTimeout(t.timers.invite2xxTimer),!t.sessionDescriptionHandler||!t.sessionDescriptionHandler.hasDescription(e.message.getHeader("Content-Type")||""))return t.logger.error("2XX response received to re-invite but did not have a description"),t.emit("reinviteFailed",t),void t.emit("renegotiationError",new Exceptions_1.Exceptions.RenegotiationError("2XX response received to re-invite but did not have a description"));t.sessionDescriptionHandler.setDescription(e.message.body,t.sessionDescriptionHandlerOptions,t.modifiers).catch((function(e){throw t.logger.error("Could not set the description in 2XX response"),t.logger.error(e),t.emit("reinviteFailed",t),t.emit("renegotiationError",e),t.sendRequest(Constants.C.BYE,{extraHeaders:["Reason: "+Utils_1.Utils.getReasonHeaderValue(488,"Not Acceptable Here")]}),t.terminated(void 0,Constants.C.causes.INCOMPATIBLE_SDP),e})).then((function(){t.emit("reinviteAccepted",t)}))}else t.logger.error("Received reinvite response, but have no pending reinvite");else t.logger.error("Received reinvite response, but in STATUS_TERMINATED")},onProgress:function(e){},onRedirect:function(e){t.pendingReinvite=!1,t.logger.log("Received a non 1XX or 2XX response to a re-invite"),t.emit("reinviteFailed",t),t.emit("renegotiationError",new Exceptions_1.Exceptions.RenegotiationError("Invalid response to a re-invite"))},onReject:function(e){t.pendingReinvite=!1,t.logger.log("Received a non 1XX or 2XX response to a re-invite"),t.emit("reinviteFailed",t),t.emit("renegotiationError",new Exceptions_1.Exceptions.RenegotiationError("Invalid response to a re-invite"))},onTrying:function(e){}},i={extraHeaders:r,body:Utils_1.Utils.fromBodyObj(e)};t.session.invite(s,i)})).catch((function(e){if(e.type===Enums.TypeStrings.RenegotiationError)throw t.pendingReinvite=!1,t.emit("renegotiationError",e),t.logger.warn("Renegotiation Error"),t.logger.warn(e.toString()),e;throw t.logger.error("sessionDescriptionHandler error"),t.logger.error(e),e}))}else this.logger.warn("No SessionDescriptionHandler, can't reinvite..")},t.prototype.failed=function(e,t){return this.status===Enums.SessionStatus.STATUS_TERMINATED||this.emit("failed",e,t),this},t.prototype.rejected=function(e,t){return this.emit("rejected",e,t),this},t.prototype.canceled=function(){return this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.emit("cancel"),this},t.prototype.accepted=function(e,t){return e instanceof String||(t=Utils_1.Utils.getReasonPhrase(e&&e.statusCode||0,t)),this.startTime=new Date,this.replacee&&(this.replacee.emit("replaced",this),this.replacee.terminate()),this.emit("accepted",e,t),this},t.prototype.terminated=function(e,t){return this.status===Enums.SessionStatus.STATUS_TERMINATED||(this.endTime=new Date,this.close(),this.emit("terminated",e,t)),this},t.prototype.connecting=function(e){return this.emit("connecting",{request:e}),this},t.C=Enums.SessionStatus,t}(EventEmitter.EventEmitter);t.Session=r;var s=function(e){function t(t,r){var s=this;if(!t.configuration.sessionDescriptionHandlerFactory)throw t.logger.warn("Can't build ISC without SDH Factory"),new Error("ISC Constructor Failed");(s=e.call(this,t.configuration.sessionDescriptionHandlerFactory)||this)._canceled=!1,s.rseq=Math.floor(1e4*Math.random()),s.incomingRequest=r;var i=r.message;ServerContext_1.ServerContext.initializer(s,t,r),s.type=Enums.TypeStrings.InviteServerContext;var n=i.parseHeader("Content-Disposition");n&&"render"===n.type&&(s.renderbody=i.body,s.rendertype=i.getHeader("Content-Type")),s.status=Enums.SessionStatus.STATUS_INVITE_RECEIVED,s.fromTag=i.fromTag,s.id=i.callId+s.fromTag,s.request=i,s.contact=s.ua.contact.toString(),s.logger=t.getLogger("sip.inviteservercontext",s.id),s.ua.sessions[s.id]=s;var o=function(e,t){i.hasHeader(e)&&i.getHeader(e).toLowerCase().indexOf("100rel")>=0&&(s.rel100=t)};if(o("require",Constants.C.supported.REQUIRED),o("supported",Constants.C.supported.SUPPORTED),s.request.toTag=r.toTag,s.status=Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER,s.timers.userNoAnswerTimer=setTimeout((function(){r.reject({statusCode:408}),s.failed(i,Constants.C.causes.NO_ANSWER),s.terminated(i,Constants.C.causes.NO_ANSWER)}),s.ua.configuration.noAnswerTimeout||60),i.hasHeader("expires")){var a=1e3*Number(i.getHeader("expires")||0);s.timers.expiresTimer=setTimeout((function(){s.status===Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER&&(r.reject({statusCode:487}),s.failed(i,Constants.C.causes.EXPIRES),s.terminated(i,Constants.C.causes.EXPIRES))}),a)}return s.errorListener=s.onTransportError.bind(s),t.transport&&t.transport.on("transportError",s.errorListener),s}return tslib_es6.__extends(t,e),Object.defineProperty(t.prototype,"autoSendAnInitialProvisionalResponse",{get:function(){return this.rel100!==Constants.C.supported.REQUIRED},enumerable:!0,configurable:!0}),t.prototype.reply=function(e){return this},t.prototype.reject=function(e){var t=this;if(void 0===e&&(e={}),this.status===Enums.SessionStatus.STATUS_TERMINATED)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);this.logger.log("rejecting RTCSession");var r=e.statusCode||480,s=Utils_1.Utils.getReasonPhrase(r,e.reasonPhrase),i=e.extraHeaders||[];if(r<300||r>699)throw new TypeError("Invalid statusCode: "+r);var n=e.body?core$1.fromBodyLegacy(e.body):void 0,o=r<400?this.incomingRequest.redirect([],{statusCode:r,reasonPhrase:s,extraHeaders:i,body:n}):this.incomingRequest.reject({statusCode:r,reasonPhrase:s,extraHeaders:i,body:n});return["rejected","failed"].forEach((function(e){t.emit(e,o.message,s)})),this.terminated()},t.prototype.accept=function(e){var t=this;return void 0===e&&(e={}),this._accept(e).then((function(e){var r=e.message,s=e.session;s.delegate={onAck:function(e){return t.onAck(e)},onAckTimeout:function(){return t.onAckTimeout()},onBye:function(e){return t.receiveRequest(e)},onInfo:function(e){return t.receiveRequest(e)},onInvite:function(e){return t.receiveRequest(e)},onNotify:function(e){return t.receiveRequest(e)},onPrack:function(e){return t.receiveRequest(e)},onRefer:function(e){return t.receiveRequest(e)}},t.session=s,t.status=Enums.SessionStatus.STATUS_WAITING_FOR_ACK,t.accepted(r,Utils_1.Utils.getReasonPhrase(200))})).catch((function(e){if(t.onContextError(e),!t._canceled)throw e})),this},t.prototype.progress=function(e){var t=this;void 0===e&&(e={});var r=e.statusCode||180;if(r<100||r>199)throw new TypeError("Invalid statusCode: "+r);if(this.status===Enums.SessionStatus.STATUS_TERMINATED)return this.logger.warn("Unexpected call for progress while terminated, ignoring"),this;if(this.status===Enums.SessionStatus.STATUS_ANSWERED)return this.logger.warn("Unexpected call for progress while answered, ignoring"),this;if(this.status===Enums.SessionStatus.STATUS_ANSWERED_WAITING_FOR_PRACK)return this.logger.warn("Unexpected call for progress while answered (waiting for prack), ignoring"),this;if(this.status===Enums.SessionStatus.STATUS_WAITING_FOR_PRACK)return this.logger.warn("Unexpected call for progress while waiting for prack, ignoring"),this;if(100===e.statusCode){try{this.incomingRequest.trying()}catch(e){if(this.onContextError(e),!this._canceled)throw e}return this}return this.rel100===Constants.C.supported.REQUIRED||this.rel100===Constants.C.supported.SUPPORTED&&e.rel100||this.rel100===Constants.C.supported.SUPPORTED&&this.ua.configuration.rel100===Constants.C.supported.REQUIRED?(this._reliableProgressWaitForPrack(e).catch((function(e){if(t.onContextError(e),!t._canceled)throw e})),this):(this._progress(e).catch((function(e){if(t.onContextError(e),!t._canceled)throw e})),this)},t.prototype.terminate=function(e){var t=this;if(void 0===e&&(e={}),!this.session)return this.reject(e),this;switch(this.session.sessionState){case core$1.SessionState.Initial:case core$1.SessionState.Early:return this.reject(e),this;case core$1.SessionState.AckWait:return this.session.delegate={onAck:function(){t.sendRequest(Constants.C.BYE,e)},onAckTimeout:function(){t.sendRequest(Constants.C.BYE,e)}},this.emit("bye",this.request),this.terminated(),this;case core$1.SessionState.Confirmed:return this.bye(e),this;case core$1.SessionState.Terminated:default:return this}},t.prototype.onCancel=function(e){this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER&&this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_PRACK&&this.status!==Enums.SessionStatus.STATUS_ANSWERED_WAITING_FOR_PRACK&&this.status!==Enums.SessionStatus.STATUS_EARLY_MEDIA&&this.status!==Enums.SessionStatus.STATUS_ANSWERED||(this.status=Enums.SessionStatus.STATUS_CANCELED,this.incomingRequest.reject({statusCode:487}),this.canceled(),this.rejected(e,Constants.C.causes.CANCELED),this.failed(e,Constants.C.causes.CANCELED),this.terminated(e,Constants.C.causes.CANCELED))},t.prototype.receiveRequest=function(t){var r=this;if(t.message.method===Constants.C.PRACK)this.status===Enums.SessionStatus.STATUS_WAITING_FOR_PRACK||this.status===Enums.SessionStatus.STATUS_ANSWERED_WAITING_FOR_PRACK?this.hasAnswer?(clearTimeout(this.timers.rel1xxTimer),clearTimeout(this.timers.prackTimer),t.accept(),this.status===Enums.SessionStatus.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=Enums.SessionStatus.STATUS_EARLY_MEDIA,this.accept()),this.status=Enums.SessionStatus.STATUS_EARLY_MEDIA):(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(t.message.getHeader("Content-Type")||"")?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.message.body,this.sessionDescriptionHandlerOptions,this.modifiers).then((function(){clearTimeout(r.timers.rel1xxTimer),clearTimeout(r.timers.prackTimer),t.accept(),r.status===Enums.SessionStatus.STATUS_ANSWERED_WAITING_FOR_PRACK&&(r.status=Enums.SessionStatus.STATUS_EARLY_MEDIA,r.accept()),r.status=Enums.SessionStatus.STATUS_EARLY_MEDIA}),(function(e){r.logger.warn(e),r.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),r.failed(t.message,Constants.C.causes.BAD_MEDIA_DESCRIPTION),r.terminated(t.message,Constants.C.causes.BAD_MEDIA_DESCRIPTION)}))):(this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(t.message,Constants.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(t.message,Constants.C.causes.BAD_MEDIA_DESCRIPTION))):this.status===Enums.SessionStatus.STATUS_EARLY_MEDIA&&t.accept();else e.prototype.receiveRequest.call(this,t)},t.prototype.setupSessionDescriptionHandler=function(){return this.sessionDescriptionHandler?this.sessionDescriptionHandler:this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions)},t.prototype.generateResponseOfferAnswer=function(e){if(!this.session){var t=core$1.getBody(this.incomingRequest.message);return t&&"session"===t.contentDisposition?this.setOfferAndGetAnswer(t,e):this.getOffer(e)}switch(this.session.signalingState){case core$1.SignalingState.Initial:return this.getOffer(e);case core$1.SignalingState.Stable:case core$1.SignalingState.HaveLocalOffer:return Promise.resolve(void 0);case core$1.SignalingState.HaveRemoteOffer:if(!this.session.offer)throw new Error("Session offer undefined");return this.setOfferAndGetAnswer(this.session.offer,e);case core$1.SignalingState.Closed:default:throw new Error("Invalid signaling state "+this.session.signalingState+".")}},t.prototype.handlePrackOfferAnswer=function(e,t){if(!this.session)throw new Error("Session undefined.");var r=core$1.getBody(e.message);if(!r||"session"!==r.contentDisposition)return Promise.resolve(void 0);switch(this.session.signalingState){case core$1.SignalingState.Initial:throw new Error("Invalid signaling state "+this.session.signalingState+".");case core$1.SignalingState.Stable:return this.setAnswer(r,t).then((function(){}));case core$1.SignalingState.HaveLocalOffer:throw new Error("Invalid signaling state "+this.session.signalingState+".");case core$1.SignalingState.HaveRemoteOffer:return this.setOfferAndGetAnswer(r,t);case core$1.SignalingState.Closed:default:throw new Error("Invalid signaling state "+this.session.signalingState+".")}},t.prototype.canceled=function(){return this._canceled=!0,e.prototype.canceled.call(this)},t.prototype.terminated=function(t,r){return this.prackNeverArrived(),e.prototype.terminated.call(this,t,r)},t.prototype._accept=function(e){var t=this;return void 0===e&&(e={}),this.onInfo=e.onInfo,this.status===Enums.SessionStatus.STATUS_WAITING_FOR_PRACK?(this.status=Enums.SessionStatus.STATUS_ANSWERED_WAITING_FOR_PRACK,this.waitForArrivalOfPrack().then((function(){t.status=Enums.SessionStatus.STATUS_ANSWERED,clearTimeout(t.timers.userNoAnswerTimer)})).then((function(){return t.generateResponseOfferAnswer(e)})).then((function(e){return t.incomingRequest.accept({statusCode:200,body:e})}))):this.status!==Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER?Promise.reject(new Exceptions_1.Exceptions.InvalidStateError(this.status)):(this.status=Enums.SessionStatus.STATUS_ANSWERED,this.status=Enums.SessionStatus.STATUS_ANSWERED,clearTimeout(this.timers.userNoAnswerTimer),this.generateResponseOfferAnswer(e).then((function(e){return t.incomingRequest.accept({statusCode:200,body:e})})))},t.prototype._progress=function(e){void 0===e&&(e={});var t=e.statusCode||180,r=e.reasonPhrase,s=(e.extraHeaders||[]).slice(),i=e.body?core$1.fromBodyLegacy(e.body):void 0;if(183===t&&!i)return this._progressWithSDP(e);try{var n=this.incomingRequest.progress({statusCode:t,reasonPhrase:r,extraHeaders:s,body:i});return this.emit("progress",n.message,r),this.session=n.session,Promise.resolve(n)}catch(e){return Promise.reject(e)}},t.prototype._progressWithSDP=function(e){var t=this;void 0===e&&(e={});var r=e.statusCode||183,s=e.reasonPhrase,i=(e.extraHeaders||[]).slice();return this.generateResponseOfferAnswer(e).then((function(e){return t.incomingRequest.progress({statusCode:r,reasonPhrase:s,extraHeaders:i,body:e})})).then((function(e){return t.emit("progress",e.message,s),t.session=e.session,e}))},t.prototype._reliableProgress=function(e){var t=this;void 0===e&&(e={});var r=e.statusCode||183,s=e.reasonPhrase,i=(e.extraHeaders||[]).slice();return i.push("Require: 100rel"),i.push("RSeq: "+Math.floor(1e4*Math.random())),this.generateResponseOfferAnswer(e).then((function(e){return t.incomingRequest.progress({statusCode:r,reasonPhrase:s,extraHeaders:i,body:e})})).then((function(e){return t.emit("progress",e.message,s),t.session=e.session,e}))},t.prototype._reliableProgressWaitForPrack=function(e){var t=this;void 0===e&&(e={});var r,s=e.statusCode||183,i=e.reasonPhrase,n=(e.extraHeaders||[]).slice();return n.push("Require: 100rel"),n.push("RSeq: "+this.rseq++),this.status=Enums.SessionStatus.STATUS_WAITING_FOR_PRACK,new Promise((function(o,a){var c=!0;return t.generateResponseOfferAnswer(e).then((function(e){return r=e,t.incomingRequest.progress({statusCode:s,reasonPhrase:i,extraHeaders:n,body:r})})).then((function(u){var d,l;t.emit("progress",u.message,i),t.session=u.session,u.session.delegate={onPrack:function(r){d=r,clearTimeout(p),clearTimeout(f),c&&(c=!1,t.handlePrackOfferAnswer(d,e).then((function(e){try{l=d.accept({statusCode:200,body:e}),t.status===Enums.SessionStatus.STATUS_WAITING_FOR_PRACK&&(t.status=Enums.SessionStatus.STATUS_WAITING_FOR_ANSWER),t.prackArrived(),o({prackRequest:d,prackResponse:l,progressResponse:u})}catch(e){a(e)}})))}};var p=setTimeout((function(){if(c){c=!1,t.logger.warn("No PRACK received, rejecting INVITE."),clearTimeout(f);try{t.incomingRequest.reject({statusCode:504}),t.terminated(void 0,Constants.C.causes.NO_PRACK),a(new Exceptions_1.Exceptions.TerminatedSessionError)}catch(e){a(e)}}}),64*core$1.Timers.T1),h=function(){try{t.incomingRequest.progress({statusCode:s,reasonPhrase:i,extraHeaders:n,body:r})}catch(e){return c=!1,void a(e)}f=setTimeout(h,g*=2)},g=core$1.Timers.T1,f=setTimeout(h,g)}))}))},t.prototype.onAckTimeout=function(){if(this.status===Enums.SessionStatus.STATUS_WAITING_FOR_ACK){if(this.logger.log("no ACK received for an extended period of time, terminating the call"),!this.session)throw new Error("Session undefined.");this.session.bye(),this.terminated(void 0,Constants.C.causes.NO_ACK)}},t.prototype.onContextError=function(e){var t=480;e instanceof core$1.Exception?e instanceof Exceptions_1.Exceptions.SessionDescriptionHandlerError?(this.logger.error(e.message),e.error&&this.logger.error(e.error)):e instanceof Exceptions_1.Exceptions.TerminatedSessionError?this.logger.warn("Incoming session terminated while waiting for PRACK."):e instanceof Exceptions_1.Exceptions.UnsupportedSessionDescriptionContentTypeError?t=415:e instanceof core$1.Exception&&this.logger.error(e.message):e instanceof Error?this.logger.error(e.message):(this.logger.error("An error occurred in the session description handler."),this.logger.error(e));try{this.incomingRequest.reject({statusCode:t}),this.failed(this.incomingRequest.message,e.message),this.terminated(this.incomingRequest.message,e.message)}catch(e){return}},t.prototype.prackArrived=function(){this.waitingForPrackResolve&&this.waitingForPrackResolve(),this.waitingForPrackPromise=void 0,this.waitingForPrackResolve=void 0,this.waitingForPrackReject=void 0},t.prototype.prackNeverArrived=function(){this.waitingForPrackReject&&this.waitingForPrackReject(new Exceptions_1.Exceptions.TerminatedSessionError),this.waitingForPrackPromise=void 0,this.waitingForPrackResolve=void 0,this.waitingForPrackReject=void 0},t.prototype.waitForArrivalOfPrack=function(){var e=this;if(this.waitingForPrackPromise)throw new Error("Already waiting for PRACK");return this.waitingForPrackPromise=new Promise((function(t,r){e.waitingForPrackResolve=t,e.waitingForPrackReject=r})),this.waitingForPrackPromise},t.prototype.getOffer=function(e){return this.hasOffer=!0,this.getSessionDescriptionHandler().getDescription(e.sessionDescriptionHandlerOptions,e.modifiers).then((function(e){return Utils_1.Utils.fromBodyObj(e)}))},t.prototype.setAnswer=function(e,t){this.hasAnswer=!0;var r=this.getSessionDescriptionHandler();return r.hasDescription(e.contentType)?r.setDescription(e.content,t.sessionDescriptionHandlerOptions,t.modifiers):Promise.reject(new Exceptions_1.Exceptions.UnsupportedSessionDescriptionContentTypeError)},t.prototype.setOfferAndGetAnswer=function(e,t){this.hasOffer=!0,this.hasAnswer=!0;var r=this.getSessionDescriptionHandler();return r.hasDescription(e.contentType)?r.setDescription(e.content,t.sessionDescriptionHandlerOptions,t.modifiers).then((function(){return r.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers)})).then((function(e){return Utils_1.Utils.fromBodyObj(e)})):Promise.reject(new Exceptions_1.Exceptions.UnsupportedSessionDescriptionContentTypeError)},t.prototype.getSessionDescriptionHandler=function(){var e=this.sessionDescriptionHandler=this.setupSessionDescriptionHandler();return this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),e},t}(r);t.InviteServerContext=s;var i=function(e){function t(t,r,s,i){void 0===s&&(s={}),void 0===i&&(i=[]);var n=this;if(!t.configuration.sessionDescriptionHandlerFactory)throw t.logger.warn("Can't build ISC without SDH Factory"),new Error("ICC Constructor Failed");s.params=s.params||{};var o=s.anonymous||!1,a=Utils_1.Utils.newTag();s.params.fromTag=a;var c=t.contact.toString({anonymous:o,outbound:o?!t.contact.tempGruu:!t.contact.pubGruu}),u=(s.extraHeaders||[]).slice();if(o&&t.configuration.uri&&(s.params.fromDisplayName="Anonymous",s.params.fromUri="sip:anonymous@anonymous.invalid",u.push("P-Preferred-Identity: "+t.configuration.uri.toString()),u.push("Privacy: id")),u.push("Contact: "+c),u.push("Allow: "+["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"].toString()),t.configuration.rel100===Constants.C.supported.REQUIRED&&u.push("Require: 100rel"),t.configuration.replaces===Constants.C.supported.REQUIRED&&u.push("Require: replaces"),s.extraHeaders=u,n=e.call(this,t.configuration.sessionDescriptionHandlerFactory)||this,ClientContext_1.ClientContext.initializer(n,t,Constants.C.INVITE,r,s),n.earlyMediaSessionDescriptionHandlers=new Map,n.type=Enums.TypeStrings.InviteClientContext,n.passedOptions=s,n.sessionDescriptionHandlerOptions=s.sessionDescriptionHandlerOptions||{},n.modifiers=i,n.inviteWithoutSdp=s.inviteWithoutSdp||!1,n.anonymous=s.anonymous||!1,n.renderbody=s.renderbody||void 0,n.rendertype=s.rendertype||"text/plain",n.fromTag=a,n.contact=c,n.status!==Enums.SessionStatus.STATUS_NULL)throw new Exceptions_1.Exceptions.InvalidStateError(n.status);return n.isCanceled=!1,n.received100=!1,n.method=Constants.C.INVITE,n.logger=t.getLogger("sip.inviteclientcontext"),t.applicants[n.toString()]=n,n.id=n.request.callId+n.fromTag,n.onInfo=s.onInfo,n.errorListener=n.onTransportError.bind(n),t.transport&&t.transport.on("transportError",n.errorListener),n}return tslib_es6.__extends(t,e),t.prototype.receiveResponse=function(e){throw new Error("Unimplemented.")},t.prototype.send=function(){return this.sendInvite(),this},t.prototype.invite=function(){var e=this;return this.ua.sessions[this.id]=this,Promise.resolve().then((function(){e.isCanceled||e.status===Enums.SessionStatus.STATUS_TERMINATED||(e.inviteWithoutSdp?(e.renderbody&&e.rendertype&&(e.request.body={body:e.renderbody,contentType:e.rendertype}),e.status=Enums.SessionStatus.STATUS_INVITE_SENT,e.send()):(e.sessionDescriptionHandler=e.sessionDescriptionHandlerFactory(e,e.ua.configuration.sessionDescriptionHandlerFactoryOptions||{}),e.emit("SessionDescriptionHandler-created",e.sessionDescriptionHandler),e.sessionDescriptionHandler.getDescription(e.sessionDescriptionHandlerOptions,e.modifiers).then((function(t){e.isCanceled||e.status===Enums.SessionStatus.STATUS_TERMINATED||(e.hasOffer=!0,e.request.body=t,e.status=Enums.SessionStatus.STATUS_INVITE_SENT,e.send())}),(function(t){t.type===Enums.TypeStrings.SessionDescriptionHandlerError&&(e.logger.log(t.message),t.error&&e.logger.log(t.error)),e.status!==Enums.SessionStatus.STATUS_TERMINATED&&(e.failed(void 0,Constants.C.causes.WEBRTC_ERROR),e.terminated(void 0,Constants.C.causes.WEBRTC_ERROR))}))))})),this},t.prototype.cancel=function(e){if(void 0===e&&(e={}),this.status===Enums.SessionStatus.STATUS_TERMINATED||this.status===Enums.SessionStatus.STATUS_CONFIRMED)throw new Exceptions_1.Exceptions.InvalidStateError(this.status);if(this.isCanceled)throw new Exceptions_1.Exceptions.InvalidStateError(Enums.SessionStatus.STATUS_CANCELED);this.isCanceled=!0,this.logger.log("Canceling session");var t=Utils_1.Utils.getCancelReason(e.statusCode,e.reasonPhrase);return e.extraHeaders=(e.extraHeaders||[]).slice(),this.outgoingInviteRequest&&(this.logger.warn("Canceling session before it was created"),this.outgoingInviteRequest.cancel(t,e)),this.canceled()},t.prototype.terminate=function(e){return this.status===Enums.SessionStatus.STATUS_TERMINATED||(this.status===Enums.SessionStatus.STATUS_WAITING_FOR_ACK||this.status===Enums.SessionStatus.STATUS_CONFIRMED?this.bye(e):this.cancel(e)),this},t.prototype.sendInvite=function(){var e=this;this.outgoingInviteRequest=this.ua.userAgentCore.invite(this.request,{onAccept:function(t){return e.onAccept(t)},onProgress:function(t){return e.onProgress(t)},onRedirect:function(t){return e.onRedirect(t)},onReject:function(t){return e.onReject(t)},onTrying:function(t){return e.onTrying(t)}})},t.prototype.ackAndBye=function(e,t,r,s){if(!this.ua.userAgentCore)throw new Error("Method requires user agent core.");var i=[];r&&i.push("Reason: "+Utils_1.Utils.getReasonHeaderValue(r,s));var n=e.ack();this.emit("ack",n.message);var o=t.bye(void 0,{extraHeaders:i});this.emit("bye",o.message)},t.prototype.disposeEarlyMedia=function(){if(!this.earlyMediaSessionDescriptionHandlers)throw new Error("Early media session description handlers undefined.");this.earlyMediaSessionDescriptionHandlers.forEach((function(e){e.close()}))},t.prototype.onAccept=function(e){var t=this;if(!this.earlyMediaSessionDescriptionHandlers)throw new Error("Early media session description handlers undefined.");var r=e.message,s=e.session;if(this.session)this.ackAndBye(e,s);else{if(this.isCanceled)return this.ackAndBye(e,s),void this.emit("bye",this.request);switch(r.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=core$1.Grammar.nameAddrHeaderParse(r.getHeader("P-Asserted-Identity"))),this.session=s,this.session.delegate={onAck:function(e){return t.onAck(e)},onBye:function(e){return t.receiveRequest(e)},onInfo:function(e){return t.receiveRequest(e)},onInvite:function(e){return t.receiveRequest(e)},onNotify:function(e){return t.receiveRequest(e)},onPrack:function(e){return t.receiveRequest(e)},onRefer:function(e){return t.receiveRequest(e)}},s.signalingState){case core$1.SignalingState.Initial:case core$1.SignalingState.HaveLocalOffer:this.ackAndBye(e,s,400,"Missing session description"),this.failed(r,Constants.C.causes.BAD_MEDIA_DESCRIPTION);break;case core$1.SignalingState.HaveRemoteOffer:var i=this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions||{});if(this.sessionDescriptionHandler=i,this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),!i.hasDescription(r.getHeader("Content-Type")||"")){this.ackAndBye(e,s,400,"Missing session description"),this.failed(r,Constants.C.causes.BAD_MEDIA_DESCRIPTION);break}this.hasOffer=!0,i.setDescription(r.body,this.sessionDescriptionHandlerOptions,this.modifiers).then((function(){return i.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers)})).then((function(s){if(!t.isCanceled&&t.status!==Enums.SessionStatus.STATUS_TERMINATED){t.status=Enums.SessionStatus.STATUS_CONFIRMED,t.hasAnswer=!0;var i={contentDisposition:"session",contentType:s.contentType,content:s.body},n=e.ack({body:i});t.emit("ack",n.message),t.accepted(r)}})).catch((function(i){if(i.type!==Enums.TypeStrings.SessionDescriptionHandlerError)throw i;t.logger.warn("invalid description"),t.logger.warn(i.toString()),t.ackAndBye(e,s,488,"Invalid session description"),t.failed(r,Constants.C.causes.BAD_MEDIA_DESCRIPTION)}));break;case core$1.SignalingState.Stable:var n;if(this.renderbody&&this.rendertype&&(n={body:{contentDisposition:"render",contentType:this.rendertype,content:this.renderbody}}),this.hasOffer&&!this.hasAnswer){if(!this.sessionDescriptionHandler)throw new Error("Session description handler undefined.");var o=s.answer;if(!o)throw new Error("Answer is undefined.");this.sessionDescriptionHandler.setDescription(o.content,this.sessionDescriptionHandlerOptions,this.modifiers).then((function(){t.hasAnswer=!0,t.status=Enums.SessionStatus.STATUS_CONFIRMED;var s=e.ack(n);t.emit("ack",s.message),t.accepted(r)})).catch((function(i){t.logger.error(i),t.ackAndBye(e,s,488,"Not Acceptable Here"),t.failed(r,Constants.C.causes.BAD_MEDIA_DESCRIPTION)}))}else{if(this.sessionDescriptionHandler=this.earlyMediaSessionDescriptionHandlers.get(s.id),!this.sessionDescriptionHandler)throw new Error("Session description handler undefined.");this.earlyMediaSessionDescriptionHandlers.delete(s.id),this.hasOffer=!0,this.hasAnswer=!0,this.status=Enums.SessionStatus.STATUS_CONFIRMED;var a=e.ack();this.emit("ack",a.message),this.accepted(r)}break;case core$1.SignalingState.Closed:break;default:throw new Error("Unknown session signaling state.")}this.disposeEarlyMedia()}},t.prototype.onProgress=function(e){var t=this;if(!this.isCanceled){if(!this.outgoingInviteRequest)throw new Error("Outgoing INVITE request undefined.");if(!this.earlyMediaSessionDescriptionHandlers)throw new Error("Early media session description handlers undefined.");var r=e.message,s=e.session;if(this.status=Enums.SessionStatus.STATUS_1XX_RECEIVED,r.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=core$1.Grammar.nameAddrHeaderParse(r.getHeader("P-Asserted-Identity"))),!s)throw new Error("Session undefined.");var i=r.getHeader("require"),n=r.getHeader("rseq"),o=!!(i&&i.includes("100rel")&&n?Number(n):void 0),a=[];if(o&&a.push("RAck: "+r.getHeader("rseq")+" "+r.getHeader("cseq")),s.signalingState===core$1.SignalingState.Initial)return o&&(this.logger.warn("First reliable provisional response received MUST contain an offer when INVITE does not contain an offer."),e.prack({extraHeaders:a})),void this.emit("progress",r);if(s.signalingState===core$1.SignalingState.HaveLocalOffer)return o&&e.prack({extraHeaders:a}),void this.emit("progress",r);if(s.signalingState===core$1.SignalingState.HaveRemoteOffer){if(!o)return void this.logger.warn("Non-reliable provisional response MUST NOT contain an initial offer, discarding response.");var c=this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions||{});return this.emit("SessionDescriptionHandler-created",c),this.earlyMediaSessionDescriptionHandlers.set(s.id,c),void c.setDescription(r.body,this.sessionDescriptionHandlerOptions,this.modifiers).then((function(){return c.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers)})).then((function(s){var i={contentDisposition:"session",contentType:s.contentType,content:s.body};e.prack({extraHeaders:a,body:i}),t.status=Enums.SessionStatus.STATUS_EARLY_MEDIA,t.emit("progress",r)})).catch((function(e){t.status!==Enums.SessionStatus.STATUS_TERMINATED&&(t.failed(void 0,Constants.C.causes.WEBRTC_ERROR),t.terminated(void 0,Constants.C.causes.WEBRTC_ERROR))}))}return s.signalingState===core$1.SignalingState.Stable?(o&&e.prack({extraHeaders:a}),void this.emit("progress",r)):void 0}},t.prototype.onRedirect=function(e){this.disposeEarlyMedia();var t=e.message,r=t.statusCode,s=Utils_1.Utils.sipErrorCause(r||0);this.rejected(t,s),this.failed(t,s),this.terminated(t,s)},t.prototype.onReject=function(e){this.disposeEarlyMedia();var t=e.message,r=t.statusCode,s=Utils_1.Utils.sipErrorCause(r||0);this.rejected(t,s),this.failed(t,s),this.terminated(t,s)},t.prototype.onTrying=function(e){this.received100=!0,this.emit("progress",e.message)},t}(r);t.InviteClientContext=i}));unwrapExports(Session_1);var Session_2=Session_1.Session,Session_3=Session_1.InviteServerContext,Session_4=Session_1.InviteClientContext,Subscription_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,s,i){void 0===i&&(i={});var n=e.call(this)||this;n.data={},n.method=Constants.C.SUBSCRIBE,n.body=void 0,n.type=Enums.TypeStrings.Subscription,n.ua=t,n.logger=t.getLogger("sip.subscription"),i.body&&(n.body={body:i.body,contentType:i.contentType?i.contentType:"application/sdp"});var o=t.normalizeTarget(r);if(!o)throw new TypeError("Invalid target: "+r);if(n.uri=o,n.event=s,void 0===i.expires?n.expires=3600:"number"!=typeof i.expires?(t.logger.warn('Option "expires" must be a number. Using default of 3600.'),n.expires=3600):n.expires=i.expires,n.extraHeaders=(i.extraHeaders||[]).slice(),n.context=n.initContext(),n.disposed=!1,n.request=n.context.message,!n.request.from)throw new Error("From undefined.");if(!n.request.to)throw new Error("From undefined.");return n.localIdentity=n.request.from,n.remoteIdentity=n.request.to,n.id=n.request.callId+n.request.from.parameters.tag+n.event,n.ua.subscriptions[n.id]=n,n}return tslib_es6.__extends(t,e),t.prototype.dispose=function(){this.disposed||(this.retryAfterTimer&&(clearTimeout(this.retryAfterTimer),this.retryAfterTimer=void 0),this.context.dispose(),this.disposed=!0,delete this.ua.subscriptions[this.id])},t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)},t.prototype.emit=function(t){for(var r=[],s=1;s<arguments.length;s++)r[s-1]=arguments[s];return e.prototype.emit.apply(this,[t].concat(r))},t.prototype.close=function(){if(!this.disposed)switch(this.dispose(),this.context.state){case core$1.SubscriptionState.Initial:case core$1.SubscriptionState.NotifyWait:this.onTerminated();break;case core$1.SubscriptionState.Pending:case core$1.SubscriptionState.Active:this.unsubscribe();break;case core$1.SubscriptionState.Terminated:this.onTerminated()}},t.prototype.refresh=function(){var e=this;switch(this.context.state){case core$1.SubscriptionState.Initial:case core$1.SubscriptionState.NotifyWait:case core$1.SubscriptionState.Pending:break;case core$1.SubscriptionState.Active:if(this.subscription)this.subscription.refresh().delegate={onAccept:function(t){return e.onAccepted(t)},onRedirect:function(t){return e.onFailed(t)},onReject:function(t){return e.onFailed(t)}};case core$1.SubscriptionState.Terminated:}},t.prototype.subscribe=function(){var e=this;switch(this.context.state){case core$1.SubscriptionState.Initial:this.context.subscribe().then((function(t){t.success?(t.success.subscription&&(e.subscription=t.success.subscription,e.subscription.delegate={onNotify:function(t){return e.onNotify(t)},onRefresh:function(t){return e.onRefresh(t)},onTerminated:function(){return e.close()}}),e.onNotify(t.success.request)):t.failure&&e.onFailed(t.failure.response)}));break;case core$1.SubscriptionState.NotifyWait:case core$1.SubscriptionState.Pending:break;case core$1.SubscriptionState.Active:this.refresh();case core$1.SubscriptionState.Terminated:}return this},t.prototype.unsubscribe=function(){switch(this.dispose(),this.context.state){case core$1.SubscriptionState.Initial:case core$1.SubscriptionState.NotifyWait:break;case core$1.SubscriptionState.Pending:case core$1.SubscriptionState.Active:this.subscription&&this.subscription.unsubscribe();case core$1.SubscriptionState.Terminated:}this.onTerminated()},t.prototype.onAccepted=function(e){var t=e.message.statusCode?e.message.statusCode:0,r=Utils_1.Utils.getReasonPhrase(t);this.emit("accepted",e.message,r)},t.prototype.onFailed=function(e){if(this.close(),e){var t=e.message.statusCode?e.message.statusCode:0,r=Utils_1.Utils.getReasonPhrase(t);this.emit("failed",e.message,r),this.emit("rejected",e.message,r)}},t.prototype.onNotify=function(e){var t=this;if(e.accept(),this.emit("notify",{request:e.message}),!this.disposed){var r=e.message.parseHeader("Subscription-State");if(r&&r.state&&"terminated"===r.state){if(r.reason)switch(this.logger.log("Terminated subscription with reason "+r.reason),r.reason){case"deactivated":case"timeout":return this.initContext(),void this.subscribe();case"probation":case"giveup":return this.initContext(),void(r.params&&r.params["retry-after"]?this.retryAfterTimer=setTimeout((function(){return t.subscribe()}),r.params["retry-after"]):this.subscribe())}this.close()}}},t.prototype.onRefresh=function(e){var t=this;e.delegate={onAccept:function(e){return t.onAccepted(e)}}},t.prototype.onTerminated=function(){this.emit("terminated")},t.prototype.initContext=function(){var e=this,t={extraHeaders:this.extraHeaders,body:this.body?Utils_1.Utils.fromBodyObj(this.body):void 0};return this.context=new s(this.ua.userAgentCore,this.uri,this.event,this.expires,t),this.context.delegate={onAccept:function(t){return e.onAccepted(t)}},this.context},t}(EventEmitter.EventEmitter);t.Subscription=r;var s=function(){function e(e,t,r,s,i,n){this.core=e,this.target=t,this.event=r,this.expires=s,this.subscribed=!1,this.logger=e.loggerFactory.getLogger("sip.subscription"),this.delegate=n;var o="Allow: "+allowedMethods.AllowedMethods.toString(),a=(i&&i.extraHeaders||[]).slice();a.push(o),a.push("Event: "+this.event),a.push("Expires: "+this.expires),a.push("Contact: "+this.core.configuration.contact.toString());var c=i&&i.body;this.message=e.makeOutgoingRequestMessage(Constants.C.SUBSCRIBE,this.target,this.core.configuration.aor,this.target,{},a,c)}return e.prototype.dispose=function(){this.subscription&&this.subscription.dispose(),this.request&&(this.request.waitNotifyStop(),this.request.dispose())},Object.defineProperty(e.prototype,"state",{get:function(){return this.subscription?this.subscription.subscriptionState:this.subscribed?core$1.SubscriptionState.NotifyWait:core$1.SubscriptionState.Initial},enumerable:!0,configurable:!0}),e.prototype.subscribe=function(){var e=this;return this.subscribed?Promise.reject(new Error("Not in initial state. Did you call subscribe more than once?")):(this.subscribed=!0,new Promise((function(t,r){if(!e.message)throw new Error("Message undefined.");e.request=e.core.subscribe(e.message,{onAccept:function(t){e.delegate&&e.delegate.onAccept&&e.delegate.onAccept(t)},onNotify:function(r){e.subscription=r.subscription,e.subscription&&(e.subscription.autoRefresh=!0),t({success:r})},onNotifyTimeout:function(){t({failure:{}})},onRedirect:function(e){t({failure:{response:e}})},onReject:function(e){t({failure:{response:e}})}})})))},e}()}));unwrapExports(Subscription_1);var Subscription_2=Subscription_1.Subscription,Modifiers=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t){for(var r,s=[],i=e.split(/\r\n/),n=0;n<i.length;){var o=i[n];if(/^m=(?:audio|video)/.test(o))r={index:n,stripped:[]},s.push(r);else if(r){var a=/^a=rtpmap:(\d+) ([^/]+)\//.exec(o);if(a&&t===a[2]){i.splice(n,1),r.stripped.push(a[1]);continue}}n++}for(var c=0,u=s;c<u.length;c++){for(var d=u[c],l=i[d.index].split(" "),p=3;p<l.length;)-1===d.stripped.indexOf(l[p])?p++:l.splice(p,1);i[d.index]=l.join(" ")}return i.join("\r\n")};t.stripTcpCandidates=function(e){return e.sdp=(e.sdp||"").replace(/^a=candidate:\d+ \d+ tcp .*?\r\n/gim,""),Promise.resolve(e)},t.stripTelephoneEvent=function(e){return e.sdp=r(e.sdp||"","telephone-event"),Promise.resolve(e)},t.cleanJitsiSdpImageattr=function(e){return e.sdp=(e.sdp||"").replace(/^(a=imageattr:.*?)(x|y)=\[0-/gm,"$1$2=[1:"),Promise.resolve(e)},t.stripG722=function(e){return e.sdp=r(e.sdp||"","G722"),Promise.resolve(e)},t.stripRtpPayload=function(e){return function(t){return t.sdp=r(t.sdp||"",e),Promise.resolve(t)}},t.stripVideo=function(e){return e.sdp=function(e,t){var r=new RegExp("m="+t+".*$","gm"),s=new RegExp("^a=group:.*$","gm");if(r.test(e)){var i,n=(e=e.split(/^m=/gm).filter((function(e){if(e.substr(0,t.length)===t){if(i=e.match(/^a=mid:.*$/gm)){var r=i[0].match(/:.+$/g);r&&(i=r[0].substr(1))}return!1}return!0})).join("m=")).match(s);if(n&&1===n.length){var o=n[0],a=new RegExp(" *"+i+"[^ ]*","g");o=o.replace(a,""),e=e.split(s).join(o)}}return e}(e.sdp||"","video"),Promise.resolve(e)},t.addMidLines=function(e){var t=e.sdp||"";if(-1===t.search(/^a=mid.*$/gm)){var r=t.match(/^m=.*$/gm),s=t.split(/^m=.*$/gm);r&&r.forEach((function(e,t){r[t]=e+"\na=mid:"+t})),s.forEach((function(e,t){r&&r[t]&&(s[t]=e+r[t])})),t=s.join(""),e.sdp=t}return Promise.resolve(e)}}));unwrapExports(Modifiers);var Modifiers_1=Modifiers.stripTcpCandidates,Modifiers_2=Modifiers.stripTelephoneEvent,Modifiers_3=Modifiers.cleanJitsiSdpImageattr,Modifiers_4=Modifiers.stripG722,Modifiers_5=Modifiers.stripRtpPayload,Modifiers_6=Modifiers.stripVideo,Modifiers_7=Modifiers.addMidLines,SessionDescriptionHandlerObserver_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.type=Enums.TypeStrings.SessionDescriptionHandlerObserver,this.session=e,this.options=t}return e.prototype.trackAdded=function(){this.session.emit("trackAdded")},e.prototype.directionChanged=function(){this.session.emit("directionChanged")},e}();t.SessionDescriptionHandlerObserver=r}));unwrapExports(SessionDescriptionHandlerObserver_1);var SessionDescriptionHandlerObserver_2=SessionDescriptionHandlerObserver_1.SessionDescriptionHandlerObserver,SessionDescriptionHandler_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=tslib_es6.__importStar(Modifiers),s=function(e){function t(t,r,s){var i=e.call(this)||this;i.type=Enums.TypeStrings.SessionDescriptionHandler,i.options=s||{},i.logger=t,i.observer=r,i.dtmfSender=void 0,i.shouldAcquireMedia=!0,i.CONTENT_TYPE="application/sdp",i.C={DIRECTION:{NULL:null,SENDRECV:"sendrecv",SENDONLY:"sendonly",RECVONLY:"recvonly",INACTIVE:"inactive"}},i.logger.log("SessionDescriptionHandlerOptions: "+JSON.stringify(i.options)),i.direction=i.C.DIRECTION.NULL,i.modifiers=i.options.modifiers||[],Array.isArray(i.modifiers)||(i.modifiers=[i.modifiers]);var n=commonjsGlobal.window||commonjsGlobal;return i.WebRTC={MediaStream:n.MediaStream,getUserMedia:n.navigator.mediaDevices.getUserMedia.bind(n.navigator.mediaDevices),RTCPeerConnection:n.RTCPeerConnection},i.iceGatheringTimeout=!1,i.initPeerConnection(i.options.peerConnectionOptions),i.constraints=i.checkAndDefaultConstraints(i.options.constraints),i}return tslib_es6.__extends(t,e),t.defaultFactory=function(e,r){return new t(e.ua.getLogger("sip.invitecontext.sessionDescriptionHandler",e.id),new SessionDescriptionHandlerObserver_1.SessionDescriptionHandlerObserver(e,r),r)},t.prototype.close=function(){this.logger.log("closing PeerConnection"),this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.peerConnection.getSenders?this.peerConnection.getSenders().forEach((function(e){e.track&&e.track.stop()})):(this.logger.warn("Using getLocalStreams which is deprecated"),this.peerConnection.getLocalStreams().forEach((function(e){e.getTracks().forEach((function(e){e.stop()}))}))),this.peerConnection.getReceivers?this.peerConnection.getReceivers().forEach((function(e){e.track&&e.track.stop()})):(this.logger.warn("Using getRemoteStreams which is deprecated"),this.peerConnection.getRemoteStreams().forEach((function(e){e.getTracks().forEach((function(e){e.stop()}))}))),this.resetIceGatheringComplete(),this.peerConnection.close())},t.prototype.getDescription=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=[]),e.peerConnectionOptions&&this.initPeerConnection(e.peerConnectionOptions);var s=Object.assign({},this.constraints,e.constraints);return s=this.checkAndDefaultConstraints(s),JSON.stringify(s)!==JSON.stringify(this.constraints)&&(this.constraints=s,this.shouldAcquireMedia=!0),Array.isArray(t)||(t=[t]),t=t.concat(this.modifiers),Promise.resolve().then((function(){if(r.shouldAcquireMedia)return r.acquire(r.constraints).then((function(){r.shouldAcquireMedia=!1}))})).then((function(){return r.createOfferOrAnswer(e.RTCOfferOptions,t)})).then((function(e){if(void 0===e.sdp)throw new Exceptions_1.Exceptions.SessionDescriptionHandlerError("getDescription",void 0,"SDP undefined");return r.emit("getDescription",e),{body:e.sdp,contentType:r.CONTENT_TYPE}}))},t.prototype.hasDescription=function(e){return e===this.CONTENT_TYPE},t.prototype.holdModifier=function(e){return e.sdp?(/a=(sendrecv|sendonly|recvonly|inactive)/.test(e.sdp)?(e.sdp=e.sdp.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n"),e.sdp=e.sdp.replace(/a=recvonly\r\n/g,"a=inactive\r\n")):e.sdp=e.sdp.replace(/(m=[^\r]*\r\n)/g,"$1a=sendonly\r\n"),Promise.resolve(e)):Promise.resolve(e)},t.prototype.setDescription=function(e,t,s){var i=this;void 0===t&&(t={}),void 0===s&&(s=[]),t.peerConnectionOptions&&this.initPeerConnection(t.peerConnectionOptions),Array.isArray(s)||(s=[s]),s=s.concat(this.modifiers);var n={type:this.hasOffer("local")?"answer":"offer",sdp:e};return Promise.resolve().then((function(){if(i.shouldAcquireMedia&&i.options.alwaysAcquireMediaFirst)return i.acquire(i.constraints).then((function(){i.shouldAcquireMedia=!1}))})).then((function(){return Utils_1.Utils.reducePromises(s,n)})).catch((function(e){if(e.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("setDescription",e,"The modifiers did not resolve successfully");throw i.logger.error(t.message),i.emit("peerConnection-setRemoteDescriptionFailed",t),t})).then((function(e){return i.emit("setDescription",e),i.peerConnection.setRemoteDescription(e)})).catch((function(n){if(n.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw n;if(/^m=video.+$/gm.test(e)&&!t.disableAudioFallback)return t.disableAudioFallback=!0,i.setDescription(e,t,[r.stripVideo].concat(s));var o=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("setDescription",n);throw o.error&&i.logger.error(o.error),i.emit("peerConnection-setRemoteDescriptionFailed",o),o})).then((function(){i.peerConnection.getReceivers?i.emit("setRemoteDescription",i.peerConnection.getReceivers()):i.emit("setRemoteDescription",i.peerConnection.getRemoteStreams()),i.emit("confirmed",i)}))},t.prototype.sendDtmf=function(e,t){if(void 0===t&&(t={}),!this.dtmfSender&&this.hasBrowserGetSenderSupport()){var r=this.peerConnection.getSenders();r.length>0&&(this.dtmfSender=r[0].dtmf)}if(!this.dtmfSender&&this.hasBrowserTrackSupport()){var s=this.peerConnection.getLocalStreams();if(s.length>0){var i=s[0].getAudioTracks();i.length>0&&(this.dtmfSender=this.peerConnection.createDTMFSender(i[0]))}}if(!this.dtmfSender)return!1;try{this.dtmfSender.insertDTMF(e,t.duration,t.interToneGap)}catch(e){if("InvalidStateError"===e.type||"InvalidCharacterError"===e.type)return this.logger.error(e),!1;throw e}return this.logger.log("DTMF sent via RTP: "+e.toString()),!0},t.prototype.getDirection=function(){return this.direction},t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)},t.prototype.createOfferOrAnswer=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=[]);var s=this.hasOffer("remote")?"createAnswer":"createOffer",i=this.peerConnection;return this.logger.log(s),(this.hasOffer("remote")?i.createAnswer:i.createOffer).apply(i,e).catch((function(e){if(e.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",e,"peerConnection-"+s+"Failed");throw r.emit("peerConnection-"+s+"Failed",t),t})).then((function(e){return Utils_1.Utils.reducePromises(t,r.createRTCSessionDescriptionInit(e))})).then((function(e){return r.resetIceGatheringComplete(),r.logger.log("Setting local sdp."),r.logger.log("sdp is "+e.sdp||"undefined"),i.setLocalDescription(e)})).catch((function(e){if(e.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",e,"peerConnection-SetLocalDescriptionFailed");throw r.emit("peerConnection-SetLocalDescriptionFailed",t),t})).then((function(){return r.waitForIceGatheringComplete()})).then((function(){var e=r.createRTCSessionDescriptionInit(r.peerConnection.localDescription);return Utils_1.Utils.reducePromises(t,e)})).then((function(e){return r.setDirection(e.sdp||""),e})).catch((function(e){if(e.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",e);throw r.logger.error(t.message),t}))},t.prototype.createRTCSessionDescriptionInit=function(e){return{type:e.type,sdp:e.sdp}},t.prototype.addDefaultIceCheckingTimeout=function(e){return void 0===e.iceCheckingTimeout&&(e.iceCheckingTimeout=5e3),e},t.prototype.addDefaultIceServers=function(e){return e.iceServers||(e.iceServers=[{urls:"stun:stun.l.google.com:19302"}]),e},t.prototype.checkAndDefaultConstraints=function(e){var t={audio:!0,video:!this.options.alwaysAcquireMediaFirst};return e=e||t,0===Object.keys(e).length&&e.constructor===Object?t:e},t.prototype.hasBrowserTrackSupport=function(){return Boolean(this.peerConnection.addTrack)},t.prototype.hasBrowserGetSenderSupport=function(){return Boolean(this.peerConnection.getSenders)},t.prototype.initPeerConnection=function(e){var t=this;void 0===e&&(e={}),(e=this.addDefaultIceCheckingTimeout(e)).rtcConfiguration=e.rtcConfiguration||{},e.rtcConfiguration=this.addDefaultIceServers(e.rtcConfiguration),this.logger.log("initPeerConnection"),this.peerConnection&&(this.logger.log("Already have a peer connection for this session. Tearing down."),this.resetIceGatheringComplete(),this.peerConnection.close()),this.peerConnection=new this.WebRTC.RTCPeerConnection(e.rtcConfiguration),this.logger.log("New peer connection created"),"ontrack"in this.peerConnection?this.peerConnection.addEventListener("track",(function(e){t.logger.log("track added"),t.observer.trackAdded(),t.emit("addTrack",e)})):(this.logger.warn("Using onaddstream which is deprecated"),this.peerConnection.onaddstream=function(e){t.logger.log("stream added"),t.emit("addStream",e)}),this.peerConnection.onicecandidate=function(e){t.emit("iceCandidate",e),e.candidate?t.logger.log("ICE candidate received: "+(null===e.candidate.candidate?null:e.candidate.candidate.trim())):null===e.candidate&&(t.logger.log("ICE candidate gathering complete"),t.triggerIceGatheringComplete())},this.peerConnection.onicegatheringstatechange=function(){switch(t.logger.log("RTCIceGatheringState changed: "+t.peerConnection.iceGatheringState),t.peerConnection.iceGatheringState){case"gathering":t.emit("iceGathering",t),!t.iceGatheringTimer&&e.iceCheckingTimeout&&(t.iceGatheringTimeout=!1,t.iceGatheringTimer=setTimeout((function(){t.logger.log("RTCIceChecking Timeout Triggered after "+e.iceCheckingTimeout+" milliseconds"),t.iceGatheringTimeout=!0,t.triggerIceGatheringComplete()}),e.iceCheckingTimeout));break;case"complete":t.triggerIceGatheringComplete()}},this.peerConnection.oniceconnectionstatechange=function(){var e;switch(t.peerConnection.iceConnectionState){case"new":e="iceConnection";break;case"checking":e="iceConnectionChecking";break;case"connected":e="iceConnectionConnected";break;case"completed":e="iceConnectionCompleted";break;case"failed":e="iceConnectionFailed";break;case"disconnected":e="iceConnectionDisconnected";break;case"closed":e="iceConnectionClosed";break;default:return void t.logger.warn("Unknown iceConnection state: "+t.peerConnection.iceConnectionState)}t.logger.log("ICE Connection State changed to "+e),t.emit(e,t)}},t.prototype.acquire=function(e){var t=this;return e=this.checkAndDefaultConstraints(e),new Promise((function(r,s){t.logger.log("acquiring local media"),t.emit("userMediaRequest",e),e.audio||e.video?t.WebRTC.getUserMedia(e).then((function(e){t.observer.trackAdded(),t.emit("userMedia",e),r(e)})).catch((function(e){t.emit("userMediaFailed",e),s(e)})):r([])})).catch((function(e){if(e.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw e;var r=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("acquire",e,"unable to acquire streams");throw t.logger.error(r.message),r.error&&t.logger.error(r.error),r})).then((function(e){t.logger.log("acquired local media streams");try{return t.peerConnection.removeTrack&&t.peerConnection.getSenders().forEach((function(e){t.peerConnection.removeTrack(e)})),e}catch(e){return Promise.reject(e)}})).catch((function(e){if(e.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw e;var r=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("acquire",e,"error removing streams");throw t.logger.error(r.message),r.error&&t.logger.error(r.error),r})).then((function(e){try{(e=[].concat(e)).forEach((function(e){t.peerConnection.addTrack?e.getTracks().forEach((function(r){t.peerConnection.addTrack(r,e)})):t.peerConnection.addStream(e)}))}catch(e){return Promise.reject(e)}return Promise.resolve()})).catch((function(e){if(e.type===Enums.TypeStrings.SessionDescriptionHandlerError)throw e;var r=new Exceptions_1.Exceptions.SessionDescriptionHandlerError("acquire",e,"error adding stream");throw t.logger.error(r.message),r.error&&t.logger.error(r.error),r}))},t.prototype.hasOffer=function(e){var t="have-"+e+"-offer";return this.peerConnection.signalingState===t},t.prototype.isIceGatheringComplete=function(){return"complete"===this.peerConnection.iceGatheringState||this.iceGatheringTimeout},t.prototype.resetIceGatheringComplete=function(){this.iceGatheringTimeout=!1,this.logger.log("resetIceGatheringComplete"),this.iceGatheringTimer&&(clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=void 0),this.iceGatheringDeferred&&(this.iceGatheringDeferred.reject(),this.iceGatheringDeferred=void 0)},t.prototype.setDirection=function(e){var t=e.match(/a=(sendrecv|sendonly|recvonly|inactive)/);if(null===t)return this.direction=this.C.DIRECTION.NULL,void this.observer.directionChanged();var r=t[1];switch(r){case this.C.DIRECTION.SENDRECV:case this.C.DIRECTION.SENDONLY:case this.C.DIRECTION.RECVONLY:case this.C.DIRECTION.INACTIVE:this.direction=r;break;default:this.direction=this.C.DIRECTION.NULL}this.observer.directionChanged()},t.prototype.triggerIceGatheringComplete=function(){this.isIceGatheringComplete()&&(this.emit("iceGatheringComplete",this),this.iceGatheringTimer&&(clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=void 0),this.iceGatheringDeferred&&(this.iceGatheringDeferred.resolve(),this.iceGatheringDeferred=void 0))},t.prototype.waitForIceGatheringComplete=function(){return this.logger.log("waitForIceGatheringComplete"),this.isIceGatheringComplete()?(this.logger.log("ICE is already complete. Return resolved."),Promise.resolve()):(this.iceGatheringDeferred||(this.iceGatheringDeferred=Utils_1.Utils.defer()),this.logger.log("ICE is not complete. Returning promise"),this.iceGatheringDeferred?this.iceGatheringDeferred.promise:Promise.resolve())},t}(EventEmitter.EventEmitter);t.SessionDescriptionHandler=s}));unwrapExports(SessionDescriptionHandler_1);var SessionDescriptionHandler_2=SessionDescriptionHandler_1.SessionDescriptionHandler,Transport_1=createCommonjsModule((function(e,t){var r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.STATUS_CONNECTING=0]="STATUS_CONNECTING",e[e.STATUS_OPEN=1]="STATUS_OPEN",e[e.STATUS_CLOSING=2]="STATUS_CLOSING",e[e.STATUS_CLOSED=3]="STATUS_CLOSED"}(r=t.TransportStatus||(t.TransportStatus={}));var s=function(e){function t(t,s){void 0===s&&(s={});var i=e.call(this,t,s)||this;return i.WebSocket=(commonjsGlobal.window||commonjsGlobal).WebSocket,i.type=Enums.TypeStrings.Transport,i.reconnectionAttempts=0,i.status=r.STATUS_CONNECTING,i.configuration=i.loadConfig(s),i.server=i.configuration.wsServers[0],i}return tslib_es6.__extends(t,e),t.prototype.isConnected=function(){return this.status===r.STATUS_OPEN},t.prototype.sendPromise=function(e,t){if(void 0===t&&(t={}),!this.statusAssert(r.STATUS_OPEN,t.force))return this.onError("unable to send message - WebSocket not open"),Promise.reject();var s=e.toString();return this.ws?(!0===this.configuration.traceSip&&this.logger.log("sending WebSocket message:\n\n"+s+"\n"),this.ws.send(s),Promise.resolve({msg:s})):(this.onError("unable to send message - WebSocket does not exist"),Promise.reject())},t.prototype.disconnectPromise=function(e){var t=this;return void 0===e&&(e={}),this.disconnectionPromise?this.disconnectionPromise:(e.code=e.code||1e3,this.statusTransition(r.STATUS_CLOSING,e.force)?(this.emit("disconnecting"),this.disconnectionPromise=new Promise((function(r,s){t.disconnectDeferredResolve=r,t.reconnectTimer&&(clearTimeout(t.reconnectTimer),t.reconnectTimer=void 0),t.ws?(t.stopSendingKeepAlives(),t.logger.log("closing WebSocket "+t.server.wsUri),t.ws.close(e.code,e.reason)):s("Attempted to disconnect but the websocket doesn't exist")})),this.disconnectionPromise):this.status===r.STATUS_CLOSED?Promise.resolve({overrideEvent:!0}):this.connectionPromise?this.connectionPromise.then((function(){return Promise.reject("The websocket did not disconnect")})).catch((function(){return Promise.resolve({overrideEvent:!0})})):Promise.reject("The websocket did not disconnect"))},t.prototype.connectPromise=function(e){var t=this;return void 0===e&&(e={}),this.status!==r.STATUS_CLOSING||e.force?(this.connectionPromise||(this.server=this.server||this.getNextWsServer(e.force),this.connectionPromise=new Promise((function(s,i){if((t.status===r.STATUS_OPEN||t.status===r.STATUS_CLOSING)&&!e.force)return t.logger.warn("WebSocket "+t.server.wsUri+" is already connected"),void i("Failed status check - attempted to open a connection but already open/closing");t.connectDeferredResolve=s,t.status=r.STATUS_CONNECTING,t.emit("connecting"),t.logger.log("connecting to WebSocket "+t.server.wsUri),t.disposeWs();try{t.ws=new WebSocket(t.server.wsUri,"sip")}catch(e){return t.ws=null,t.statusTransition(r.STATUS_CLOSED,!0),t.onError("error connecting to WebSocket "+t.server.wsUri+":"+e),void i("Failed to create a websocket")}t.ws?(t.connectionTimeout=setTimeout((function(){t.statusTransition(r.STATUS_CLOSED),t.logger.warn("took too long to connect - exceeded time set in configuration.connectionTimeout: "+t.configuration.connectionTimeout+"s"),t.emit("disconnected",{code:1e3}),t.connectionPromise=void 0,i("Connection timeout")}),1e3*t.configuration.connectionTimeout),t.boundOnOpen=t.onOpen.bind(t),t.boundOnMessage=t.onMessage.bind(t),t.boundOnClose=t.onClose.bind(t),t.boundOnError=t.onWebsocketError.bind(t),t.ws.addEventListener("open",t.boundOnOpen),t.ws.addEventListener("message",t.boundOnMessage),t.ws.addEventListener("close",t.boundOnClose),t.ws.addEventListener("error",t.boundOnError)):i("Unexpected instance websocket not set")}))),this.connectionPromise):Promise.reject("WebSocket "+this.server.wsUri+" is closing")},t.prototype.onMessage=function(e){var t,r=e.data;if(/^(\r\n)+$/.test(r))return this.clearKeepAliveTimeout(),void(!0===this.configuration.traceSip&&this.logger.log("received WebSocket message with CRLF Keep Alive response"));if(r){if("string"!=typeof r){try{t=String.fromCharCode.apply(null,new Uint8Array(r))}catch(e){return void this.logger.warn("received WebSocket binary message failed to be converted into string, message discarded")}!0===this.configuration.traceSip&&this.logger.log("received WebSocket binary message:\n\n"+r+"\n")}else!0===this.configuration.traceSip&&this.logger.log("received WebSocket text message:\n\n"+r+"\n"),t=r;this.emit("message",t)}else this.logger.warn("received empty message, message discarded")},t.prototype.onOpen=function(){if(this.status===r.STATUS_CLOSED){var e=this.ws;return this.disposeWs(),void e.close(1e3)}this.statusTransition(r.STATUS_OPEN,!0),this.emit("connected"),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=void 0),this.logger.log("WebSocket "+this.server.wsUri+" connected"),void 0!==this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=void 0),this.reconnectionAttempts=0,this.disconnectionPromise=void 0,this.disconnectDeferredResolve=void 0,this.startSendingKeepAlives(),this.connectDeferredResolve?this.connectDeferredResolve({overrideEvent:!0}):this.logger.warn("Unexpected websocket.onOpen with no connectDeferredResolve")},t.prototype.onClose=function(e){if(this.logger.log("WebSocket disconnected (code: "+e.code+(e.reason?"| reason: "+e.reason:"")+")"),this.status!==r.STATUS_CLOSING&&(this.logger.warn("WebSocket closed without SIP.js requesting it"),this.emit("transportError")),this.stopSendingKeepAlives(),this.connectionTimeout&&clearTimeout(this.connectionTimeout),this.connectionTimeout=void 0,this.connectionPromise=void 0,this.connectDeferredResolve=void 0,this.disconnectDeferredResolve)return this.disconnectDeferredResolve({overrideEvent:!0}),this.statusTransition(r.STATUS_CLOSED),void(this.disconnectDeferredResolve=void 0);this.statusTransition(r.STATUS_CLOSED,!0),this.emit("disconnected",{code:e.code,reason:e.reason}),this.reconnect()},t.prototype.disposeWs=function(){this.ws&&(this.ws.removeEventListener("open",this.boundOnOpen),this.ws.removeEventListener("message",this.boundOnMessage),this.ws.removeEventListener("close",this.boundOnClose),this.ws.removeEventListener("error",this.boundOnError),this.ws=void 0)},t.prototype.onError=function(e){this.logger.warn("Transport error: "+e),this.emit("transportError")},t.prototype.onWebsocketError=function(){this.onError("The Websocket had an error")},t.prototype.reconnect=function(){var e=this;if(this.reconnectionAttempts>0&&this.logger.log("Reconnection attempt "+this.reconnectionAttempts+" failed"),this.noAvailableServers())return this.logger.warn("attempted to get next ws server but there are no available ws servers left"),this.logger.warn("no available ws servers left - going to closed state"),this.statusTransition(r.STATUS_CLOSED,!0),this.emit("closed"),void this.resetServerErrorStatus();this.isConnected()&&(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),this.disconnect({force:!0})),this.reconnectionAttempts+=1,this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.wsUri),this.logger.log("transport "+this.server.wsUri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.noAvailableServers()||(this.server=this.getNextWsServer()),this.reconnectionAttempts=0,this.reconnect()):(this.logger.log("trying to reconnect to WebSocket "+this.server.wsUri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=setTimeout((function(){e.connect(),e.reconnectTimer=void 0}),1===this.reconnectionAttempts?0:1e3*this.configuration.reconnectionTimeout))},t.prototype.resetServerErrorStatus=function(){for(var e=0,t=this.configuration.wsServers;e<t.length;e++){t[e].isError=!1}},t.prototype.getNextWsServer=function(e){if(void 0===e&&(e=!1),this.noAvailableServers())throw this.logger.warn("attempted to get next ws server but there are no available ws servers left"),new Error("Attempted to get next ws server, but there are no available ws servers left.");for(var t=[],r=0,s=this.configuration.wsServers;r<s.length;r++){var i=s[r];i.isError&&!e||(0===t.length?t.push(i):i.weight>t[0].weight?t=[i]:i.weight===t[0].weight&&t.push(i))}return t[Math.floor(Math.random()*t.length)]},t.prototype.noAvailableServers=function(){for(var e=0,t=this.configuration.wsServers;e<t.length;e++){if(!t[e].isError)return!1}return!0},t.prototype.sendKeepAlive=function(){var e=this;if(!this.keepAliveDebounceTimeout)return this.keepAliveDebounceTimeout=setTimeout((function(){e.emit("keepAliveDebounceTimeout"),e.clearKeepAliveTimeout()}),1e3*this.configuration.keepAliveDebounce),this.send("\r\n\r\n")},t.prototype.clearKeepAliveTimeout=function(){this.keepAliveDebounceTimeout&&clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveDebounceTimeout=void 0},t.prototype.startSendingKeepAlives=function(){var e,t,r=this;this.configuration.keepAliveInterval&&!this.keepAliveInterval&&(this.keepAliveInterval=setInterval((function(){r.sendKeepAlive(),r.startSendingKeepAlives()}),(e=this.configuration.keepAliveInterval,t=.8*e,1e3*(Math.random()*(e-t)+t))))},t.prototype.stopSendingKeepAlives=function(){this.keepAliveInterval&&clearInterval(this.keepAliveInterval),this.keepAliveDebounceTimeout&&clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveInterval=void 0,this.keepAliveDebounceTimeout=void 0},t.prototype.statusAssert=function(e,t){return e===this.status||(t?(this.logger.warn("Attempted to assert "+Object.keys(r)[this.status]+" as "+Object.keys(r)[e]+"- continuing with option: 'force'"),!0):(this.logger.warn("Tried to assert "+Object.keys(r)[e]+" but is currently "+Object.keys(r)[this.status]),!1))},t.prototype.statusTransition=function(e,t){return void 0===t&&(t=!1),this.logger.log("Attempting to transition status from "+Object.keys(r)[this.status]+" to "+Object.keys(r)[e]),e===r.STATUS_CONNECTING&&this.statusAssert(r.STATUS_CLOSED,t)||e===r.STATUS_OPEN&&this.statusAssert(r.STATUS_CONNECTING,t)||e===r.STATUS_CLOSING&&this.statusAssert(r.STATUS_OPEN,t)||e===r.STATUS_CLOSED?(this.status=e,!0):(this.logger.warn("Status transition failed - result: no-op - reason: either gave an nonexistent status or attempted illegal transition"),!1)},t.prototype.loadConfig=function(e){var t={wsServers:[{scheme:"WSS",sipUri:"<sip:edge.sip.onsip.com;transport=ws;lr>",weight:0,wsUri:"wss://edge.sip.onsip.com",isError:!1}],connectionTimeout:5,maxReconnectionAttempts:3,reconnectionTimeout:4,keepAliveInterval:0,keepAliveDebounce:10,traceSip:!1},r=this.getConfigurationCheck();for(var s in r.mandatory){if(!e.hasOwnProperty(s))throw new Exceptions_1.Exceptions.ConfigurationError(s);var i=e[s];if(void 0===(n=r.mandatory[s](i)))throw new Exceptions_1.Exceptions.ConfigurationError(s,i);t[s]=n}for(var s in r.optional)if(e.hasOwnProperty(s)){var n;if((i=e[s])instanceof Array&&0===i.length||null===i||""===i||void 0===i||"number"==typeof i&&isNaN(i))continue;if(void 0===(n=r.optional[s](i)))throw new Exceptions_1.Exceptions.ConfigurationError(s,i);t[s]=n}var o={};for(var s in t)t.hasOwnProperty(s)&&(o[s]={value:t[s]});var a=Object.defineProperties({},o);for(var s in this.logger.log("configuration parameters after validation:"),t)t.hasOwnProperty(s)&&this.logger.log("· "+s+": "+JSON.stringify(t[s]));return a},t.prototype.getConfigurationCheck=function(){return{mandatory:{},optional:{wsServers:function(e){if("string"==typeof e)e=[{wsUri:e}];else{if(!(e instanceof Array))return;for(var t=0;t<e.length;t++)"string"==typeof e[t]&&(e[t]={wsUri:e[t]})}if(0===e.length)return!1;for(var r=0,s=e;r<s.length;r++){var i=s[r];if(!i.wsUri)return;if(i.weight&&!Number(i.weight))return;var n=core$1.Grammar.parse(i.wsUri,"absoluteURI");if(-1===n)return;if(["wss","ws","udp"].indexOf(n.scheme)<0)return;i.sipUri="<sip:"+n.host+(n.port?":"+n.port:"")+";transport="+n.scheme.replace(/^wss$/i,"ws")+";lr>",i.weight||(i.weight=0),i.isError=!1,i.scheme=n.scheme.toUpperCase()}return e},keepAliveInterval:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>0)return t}},keepAliveDebounce:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>0)return t}},traceSip:function(e){if("boolean"==typeof e)return e},connectionTimeout:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>0)return t}},maxReconnectionAttempts:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>=0)return t}},reconnectionTimeout:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>0)return t}}}}},t.C=r,t}(core$1.Transport);t.Transport=s}));unwrapExports(Transport_1);var Transport_2=Transport_1.TransportStatus,Transport_3=Transport_1.Transport,UA_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=commonjsGlobal.window||commonjsGlobal,s=function(e){function t(r){var s=e.call(this)||this;if(s.type=Enums.TypeStrings.UA,s.log=new core$1.LoggerFactory,s.logger=s.getLogger("sip.ua"),s.configuration={},s.applicants={},s.data={},s.sessions={},s.subscriptions={},s.publishers={},s.status=Enums.UAStatus.STATUS_INIT,void 0===r?r={}:("string"==typeof r||r instanceof String)&&(r={uri:r}),r.log&&(r.log.hasOwnProperty("builtinEnabled")&&(s.log.builtinEnabled=r.log.builtinEnabled),r.log.hasOwnProperty("connector")&&(s.log.connector=r.log.connector),r.log.hasOwnProperty("level"))){var n=r.log.level,o=void 0;if("string"==typeof n)switch(n){case"error":o=core$1.Levels.error;break;case"warn":o=core$1.Levels.warn;break;case"log":o=core$1.Levels.log;break;case"debug":o=core$1.Levels.debug}else switch(n){case 0:o=core$1.Levels.error;break;case 1:o=core$1.Levels.warn;break;case 2:o=core$1.Levels.log;break;case 3:o=core$1.Levels.debug}void 0===o?s.logger.error('Invalid "level" parameter value: '+JSON.stringify(n)):s.log.level=o}try{s.loadConfig(r)}catch(e){throw s.status=Enums.UAStatus.STATUS_NOT_READY,s.error=t.C.CONFIGURATION_ERROR,e}if(!s.configuration.transportConstructor)throw new core$1.TransportError("Transport constructor not set");s.transport=new s.configuration.transportConstructor(s.getLogger("sip.transport"),s.configuration.transportOptions);var a=i(s),c={onInvite:function(e){e.trying(),e.delegate={onCancel:function(e){t.onCancel(e)},onTransportError:function(e){t.onTransportError()}};var t=new Session_1.InviteServerContext(s,e);!function(e,t){if(s.configuration.replaces!==Constants.C.supported.UNSUPPORTED){var r=t.parseHeader("replaces");if(r){var i=s.sessions[r.call_id+r.replaces_from_tag]||s.sessions[r.call_id+r.replaces_to_tag]||void 0;if(!i)return void s.userAgentCore.replyStateless(t,{statusCode:481});if(i.status===Enums.SessionStatus.STATUS_TERMINATED)return void s.userAgentCore.replyStateless(t,{statusCode:603});var n=r.call_id+r.replaces_to_tag+r.replaces_from_tag,o=s.userAgentCore.dialogs.get(n);if(!o)return void s.userAgentCore.replyStateless(t,{statusCode:481});if(!o.early&&r.early_only)return void s.userAgentCore.replyStateless(t,{statusCode:486});e.replacee=i}}}(t,e.message),t.autoSendAnInitialProvisionalResponse&&t.progress(),s.emit("invite",t)},onMessage:function(e){var t=new ServerContext_1.ServerContext(s,e);t.body=e.message.body,t.contentType=e.message.getHeader("Content-Type")||"text/plain",e.accept(),s.emit("message",t)},onNotify:function(e){s.configuration.allowLegacyNotifications&&s.listeners("notify").length>0?(e.accept(),s.emit("notify",{request:e.message})):e.reject({statusCode:481})},onRefer:function(e){s.logger.log("Received an out of dialog refer"),s.configuration.allowOutOfDialogRefers||e.reject({statusCode:405}),s.logger.log("Allow out of dialog refers is enabled on the UA");var t=new ReferContext.ReferServerContext(s,e);s.listeners("outOfDialogReferRequested").length?s.emit("outOfDialogReferRequested",t):(s.logger.log("No outOfDialogReferRequest listeners, automatically accepting and following the out of dialog refer"),t.accept({followRefer:!0}))},onSubscribe:function(e){s.emit("subscribe",e)}};return s.userAgentCore=new core$1.UserAgentCore(a,c),s.registerContext=new RegisterContext_1.RegisterContext(s,r.registerOptions),s.registerContext.on("failed",s.emit.bind(s,"registrationFailed")),s.registerContext.on("registered",s.emit.bind(s,"registered")),s.registerContext.on("unregistered",s.emit.bind(s,"unregistered")),s.configuration.autostart&&s.start(),s}return tslib_es6.__extends(t,e),t.prototype.register=function(e){return void 0===e&&(e={}),e.register&&(this.configuration.register=!0),this.registerContext.register(e),this},t.prototype.unregister=function(e){var t=this;return this.configuration.register=!1,this.transport.afterConnected((function(){t.registerContext.unregister(e)})),this},t.prototype.isRegistered=function(){return this.registerContext.registered},t.prototype.invite=function(e,t,r){var s=this,i=new Session_1.InviteClientContext(this,e,t,r);return this.transport.afterConnected((function(){i.invite(),s.emit("inviteSent",i)})),i},t.prototype.subscribe=function(e,t,r){var s=new Subscription_1.Subscription(this,e,t,r);return this.transport.afterConnected((function(){return s.subscribe()})),s},t.prototype.publish=function(e,t,r,s){var i=new PublishContext_1.PublishContext(this,e,t,s);return this.transport.afterConnected((function(){i.publish(r)})),i},t.prototype.message=function(e,t,r){if(void 0===r&&(r={}),void 0===t)throw new TypeError("Not enough arguments");return r.contentType=r.contentType||"text/plain",r.body=t,this.request(Constants.C.MESSAGE,e,r)},t.prototype.request=function(e,t,r){var s=new ClientContext_1.ClientContext(this,e,t,r);return this.transport.afterConnected((function(){return s.send()})),s},t.prototype.stop=function(){if(this.logger.log("user requested closure..."),this.status===Enums.UAStatus.STATUS_USER_CLOSED)return this.logger.warn("UA already closed"),this;for(var e in this.logger.log("closing registerContext"),this.registerContext.close(),this.sessions)this.sessions[e]&&(this.logger.log("closing session "+e),this.sessions[e].terminate());for(var t in this.subscriptions)this.subscriptions[t]&&(this.logger.log("unsubscribe "+t),this.subscriptions[t].unsubscribe());for(var s in this.publishers)this.publishers[s]&&(this.logger.log("unpublish "+s),this.publishers[s].close());for(var i in this.applicants)this.applicants[i]&&this.applicants[i].close();return this.status=Enums.UAStatus.STATUS_USER_CLOSED,this.transport.disconnect(),this.userAgentCore.reset(),"function"==typeof r.removeEventListener&&(commonjsGlobal.chrome&&commonjsGlobal.chrome.app&&commonjsGlobal.chrome.app.runtime||r.removeEventListener("unload",this.environListener)),this},t.prototype.start=function(){var e=this;return this.logger.log("user requested startup..."),this.status===Enums.UAStatus.STATUS_INIT?(this.status=Enums.UAStatus.STATUS_STARTING,this.setTransportListeners(),this.emit("transportCreated",this.transport),this.transport.connect()):this.status===Enums.UAStatus.STATUS_USER_CLOSED?(this.logger.log("resuming"),this.status=Enums.UAStatus.STATUS_READY,this.transport.connect()):this.status===Enums.UAStatus.STATUS_STARTING?this.logger.log("UA is in STARTING status, not opening new connection"):this.status===Enums.UAStatus.STATUS_READY?this.logger.log("UA is in READY status, not resuming"):this.logger.error("Connection is down. Auto-Recovery system is trying to connect"),this.configuration.autostop&&"function"==typeof r.addEventListener&&(commonjsGlobal.chrome&&commonjsGlobal.chrome.app&&commonjsGlobal.chrome.app.runtime||(this.environListener=this.stop,r.addEventListener("unload",(function(){return e.environListener()})))),this},t.prototype.normalizeTarget=function(e){return Utils_1.Utils.normalizeTarget(e,this.configuration.hostportParams)},t.prototype.getLogger=function(e,t){return this.log.getLogger(e,t)},t.prototype.getLoggerFactory=function(){return this.log},t.prototype.getSupportedResponseOptions=function(){var e=[];(this.contact.pubGruu||this.contact.tempGruu)&&e.push("gruu"),this.configuration.rel100===Constants.C.supported.SUPPORTED&&e.push("100rel"),this.configuration.replaces===Constants.C.supported.SUPPORTED&&e.push("replaces"),e.push("outbound"),e=e.concat(this.configuration.extraSupported||[]);var t=this.configuration.hackAllowUnregisteredOptionTags||!1,r={};return e=e.filter((function(e){var s=Constants.C.OPTION_TAGS[e],i=!r[e];return r[e]=!0,(s||t)&&i}))},t.prototype.findSession=function(e){return this.sessions[e.callId+e.fromTag]||this.sessions[e.callId+e.toTag]||void 0},t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)},t.prototype.onTransportError=function(){this.status!==Enums.UAStatus.STATUS_USER_CLOSED&&(this.error&&this.error===t.C.NETWORK_ERROR||(this.status=Enums.UAStatus.STATUS_NOT_READY,this.error=t.C.NETWORK_ERROR))},t.prototype.setTransportListeners=function(){var e=this;this.transport.on("connected",(function(){return e.onTransportConnected()})),this.transport.on("message",(function(t){return e.onTransportReceiveMsg(t)})),this.transport.on("transportError",(function(){return e.onTransportError()}))},t.prototype.onTransportConnected=function(){var e=this;this.configuration.register&&Promise.resolve().then((function(){return e.registerContext.register()}))},t.prototype.onTransportReceiveMsg=function(e){var t=this,r=Parser_1.Parser.parseMessage(e,this.getLogger("sip.parser"));if(r)if(this.status===Enums.UAStatus.STATUS_USER_CLOSED&&r instanceof core$1.IncomingRequestMessage)this.logger.warn("UA received message when status = USER_CLOSED - aborting");else{var s=function(){for(var e=0,s=["from","to","call_id","cseq","via"];e<s.length;e++){var i=s[e];if(!r.hasHeader(i))return t.logger.warn("Missing mandatory header field : "+i+"."),!1}return!0};if(r instanceof core$1.IncomingRequestMessage){if(!s())return void this.logger.warn("Request missing mandatory header field. Dropping.");if(!r.toTag&&r.callId.substr(0,5)===this.configuration.sipjsId)return void this.userAgentCore.replyStateless(r,{statusCode:482});var i=Utils_1.Utils.str_utf8_length(r.body);if((n=r.getHeader("content-length"))&&i<Number(n))return void this.userAgentCore.replyStateless(r,{statusCode:400})}if(r instanceof core$1.IncomingResponseMessage){if(!s())return void this.logger.warn("Response missing mandatory header field. Dropping.");if(r.getHeaders("via").length>1)return void this.logger.warn("More than one Via header field present in the response. Dropping.");if(r.via.host!==this.configuration.viaHost||void 0!==r.via.port)return void this.logger.warn("Via sent-by in the response does not match UA Via host value. Dropping.");var n;i=Utils_1.Utils.str_utf8_length(r.body);if((n=r.getHeader("content-length"))&&i<Number(n))return void this.logger.warn("Message body length is lower than the value in Content-Length header field. Dropping.")}if(r instanceof core$1.IncomingRequestMessage)this.userAgentCore.receiveIncomingRequestFromTransport(r);else{if(!(r instanceof core$1.IncomingResponseMessage))throw new Error("Invalid message type.");this.userAgentCore.receiveIncomingResponseFromTransport(r)}}else this.logger.warn("UA failed to parse incoming SIP message - discarding.")},t.prototype.checkAuthenticationFactory=function(e){if(e instanceof Function)return e.initialize||(e.initialize=function(){return Promise.resolve()}),e},t.prototype.loadConfig=function(e){var t=this,r={viaHost:Utils_1.Utils.createRandomToken(12)+".invalid",uri:new core$1.URI("sip","anonymous."+Utils_1.Utils.createRandomToken(6),"anonymous.invalid",void 0,void 0),custom:{},displayName:"",password:void 0,register:!0,registerOptions:{},transportConstructor:Transport_1.Transport,transportOptions:{},usePreloadedRoute:!1,userAgentString:Constants.C.USER_AGENT,noAnswerTimeout:60,hackViaTcp:!1,hackIpInContact:!1,hackWssInTransport:!1,hackAllowUnregisteredOptionTags:!1,sessionDescriptionHandlerFactoryOptions:{constraints:{},peerConnectionOptions:{}},extraSupported:[],contactName:Utils_1.Utils.createRandomToken(8),contactTransport:"ws",forceRport:!1,autostart:!0,autostop:!0,rel100:Constants.C.supported.UNSUPPORTED,dtmfType:Constants.C.dtmfType.INFO,replaces:Constants.C.supported.UNSUPPORTED,sessionDescriptionHandlerFactory:SessionDescriptionHandler_1.SessionDescriptionHandler.defaultFactory,authenticationFactory:this.checkAuthenticationFactory((function(e){return new core$1.DigestAuthentication(e.getLoggerFactory(),t.configuration.authorizationUser,t.configuration.password)})),allowLegacyNotifications:!1,allowOutOfDialogRefers:!1,experimentalFeatures:!1},s=this.getConfigurationCheck();for(var i in s.mandatory){if(!e.hasOwnProperty(i))throw new Exceptions_1.Exceptions.ConfigurationError(i);var n=e[i];if(void 0===(o=s.mandatory[i](n)))throw new Exceptions_1.Exceptions.ConfigurationError(i,n);r[i]=o}for(var i in s.optional)if(e.hasOwnProperty(i)){var o;if((n=e[i])instanceof Array&&0===n.length||null===n||""===n||void 0===n||"number"==typeof n&&isNaN(n))continue;if(void 0===(o=s.optional[i](n)))throw new Exceptions_1.Exceptions.ConfigurationError(i,n);r[i]=o}0===r.displayName&&(r.displayName="0"),r.sipjsId=Utils_1.Utils.createRandomToken(5);var a=r.uri.clone();if(a.user=void 0,r.hostportParams=a.toRaw().replace(/^sip:/i,""),r.authorizationUser||(r.authorizationUser=r.uri.user),r.noAnswerTimeout=1e3*r.noAnswerTimeout,r.hackIpInContact)if("boolean"==typeof r.hackIpInContact){var c=Math.floor(254*Math.random()+1);r.viaHost="192.0.2."+c}else"string"==typeof r.hackIpInContact&&(r.viaHost=r.hackIpInContact);r.hackWssInTransport&&(r.contactTransport="wss"),this.contact={pubGruu:void 0,tempGruu:void 0,uri:new core$1.URI("sip",r.contactName,r.viaHost,void 0,{transport:r.contactTransport}),toString:function(e){void 0===e&&(e={});var s=e.anonymous||!1,i=e.outbound||!1,n="<";return n+=s?(t.contact.tempGruu||"sip:anonymous@anonymous.invalid;transport="+r.contactTransport).toString():(t.contact.pubGruu||t.contact.uri).toString(),i&&(n+=";ob"),n+=">"}};var u={};for(var i in r)r.hasOwnProperty(i)&&(u[i]=r[i]);for(var i in Object.assign(this.configuration,u),this.logger.log("configuration parameters after validation:"),r)if(r.hasOwnProperty(i))switch(i){case"uri":case"sessionDescriptionHandlerFactory":this.logger.log("· "+i+": "+r[i]);break;case"password":this.logger.log("· "+i+": NOT SHOWN");break;case"transportConstructor":this.logger.log("· "+i+": "+r[i].name);break;default:this.logger.log("· "+i+": "+JSON.stringify(r[i]))}},t.prototype.getConfigurationCheck=function(){return{mandatory:{},optional:{uri:function(e){/^sip:/i.test(e)||(e=Constants.C.SIP+":"+e);var t=core$1.Grammar.URIParse(e);return t&&t.user?t:void 0},transportConstructor:function(e){if(e instanceof Function)return e},transportOptions:function(e){if("object"==typeof e)return e},authorizationUser:function(e){return-1===core$1.Grammar.parse('"'+e+'"',"quoted_string")?void 0:e},displayName:function(e){return-1===core$1.Grammar.parse('"'+e+'"',"displayName")?void 0:e},dtmfType:function(e){switch(e){case Constants.C.dtmfType.RTP:return Constants.C.dtmfType.RTP;case Constants.C.dtmfType.INFO:default:return Constants.C.dtmfType.INFO}},hackViaTcp:function(e){if("boolean"==typeof e)return e},hackIpInContact:function(e){return"boolean"==typeof e||"string"==typeof e&&-1!==core$1.Grammar.parse(e,"host")?e:void 0},hackWssInTransport:function(e){if("boolean"==typeof e)return e},hackAllowUnregisteredOptionTags:function(e){if("boolean"==typeof e)return e},contactTransport:function(e){if("string"==typeof e)return e},extraSupported:function(e){if(e instanceof Array){for(var t=0,r=e;t<r.length;t++){if("string"!=typeof r[t])return}return e}},forceRport:function(e){if("boolean"==typeof e)return e},noAnswerTimeout:function(e){if(Utils_1.Utils.isDecimal(e)){var t=Number(e);if(t>0)return t}},password:function(e){return String(e)},rel100:function(e){return e===Constants.C.supported.REQUIRED?Constants.C.supported.REQUIRED:e===Constants.C.supported.SUPPORTED?Constants.C.supported.SUPPORTED:Constants.C.supported.UNSUPPORTED},replaces:function(e){return e===Constants.C.supported.REQUIRED?Constants.C.supported.REQUIRED:e===Constants.C.supported.SUPPORTED?Constants.C.supported.SUPPORTED:Constants.C.supported.UNSUPPORTED},register:function(e){if("boolean"==typeof e)return e},registerOptions:function(e){if("object"==typeof e)return e},usePreloadedRoute:function(e){if("boolean"==typeof e)return e},userAgentString:function(e){if("string"==typeof e)return e},autostart:function(e){if("boolean"==typeof e)return e},autostop:function(e){if("boolean"==typeof e)return e},sessionDescriptionHandlerFactory:function(e){if(e instanceof Function)return e},sessionDescriptionHandlerFactoryOptions:function(e){if("object"==typeof e)return e},authenticationFactory:this.checkAuthenticationFactory,allowLegacyNotifications:function(e){if("boolean"==typeof e)return e},custom:function(e){if("object"==typeof e)return e},contactName:function(e){if("string"==typeof e)return e},experimentalFeatures:function(e){if("boolean"==typeof e)return e}}}},t.C={STATUS_INIT:0,STATUS_STARTING:1,STATUS_READY:2,STATUS_USER_CLOSED:3,STATUS_NOT_READY:4,CONFIGURATION_ERROR:1,NETWORK_ERROR:2,ALLOWED_METHODS:["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"],ACCEPTED_BODY_TYPES:["application/sdp","application/dtmf-relay"],MAX_FORWARDS:70,TAG_LENGTH:10},t}(EventEmitter.EventEmitter);function i(e){if(!(e.configuration.uri instanceof core$1.URI))throw new Error("Configuration URI not instance of URI.");var t=e.configuration.uri,r=e.contact,s=e.configuration.displayName?e.configuration.displayName:"",i=!!e.configuration.hackViaTcp,n=e.configuration.usePreloadedRoute&&e.transport.server&&e.transport.server.sipUri?[e.transport.server.sipUri]:[],o=e.configuration.sipjsId||Utils_1.Utils.createRandomToken(5),a=[];a.push("outbound"),e.configuration.rel100===Constants.C.supported.SUPPORTED&&a.push("100rel"),e.configuration.replaces===Constants.C.supported.SUPPORTED&&a.push("replaces"),e.configuration.extraSupported&&a.push.apply(a,e.configuration.extraSupported),e.configuration.hackAllowUnregisteredOptionTags||(a=a.filter((function(e){return Constants.C.OPTION_TAGS[e]}))),a=Array.from(new Set(a));var c=e.getSupportedResponseOptions(),u=e.configuration.userAgentString||"sipjs";if(!e.configuration.viaHost)throw new Error("Configuration via host undefined");var d=!!e.configuration.forceRport,l=e.configuration.viaHost;return{aor:t,contact:r,displayName:s,hackViaTcp:i,loggerFactory:e.getLoggerFactory(),routeSet:n,sipjsId:o,supportedOptionTags:a,supportedOptionTagsResponse:c,userAgentHeaderFieldValue:u,viaForceRport:d,viaHost:l,authenticationFactory:function(){if(e.configuration.authenticationFactory)return e.configuration.authenticationFactory(e)},transportAccessor:function(){return e.transport}}}t.UA=s,function(e){!function(e){e.RTP="rtp",e.INFO="info"}(e.DtmfType||(e.DtmfType={}))}(s=t.UA||(t.UA={})),t.UA=s,t.makeUserAgentCoreConfigurationFromUA=i}));unwrapExports(UA_1);var UA_2=UA_1.UA,UA_3=UA_1.makeUserAgentCoreConfigurationFromUA,Simple_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r,s=tslib_es6.__importStar(Modifiers);!function(e){e[e.STATUS_NULL=0]="STATUS_NULL",e[e.STATUS_NEW=1]="STATUS_NEW",e[e.STATUS_CONNECTING=2]="STATUS_CONNECTING",e[e.STATUS_CONNECTED=3]="STATUS_CONNECTED",e[e.STATUS_COMPLETED=4]="STATUS_COMPLETED"}(r=t.SimpleStatus||(t.SimpleStatus={}));var i=function(e){function t(t){var i=e.call(this)||this;if(t.media.remote.video?i.video=!0:i.video=!1,t.media.remote.audio?i.audio=!0:i.audio=!1,!i.audio&&!i.video)throw new Error("At least one remote audio or video element is required for Simple.");i.options=t;var n=commonjsGlobal.navigator.userAgent.toLowerCase(),o=!1,a=!1;n.indexOf("safari")>-1&&n.indexOf("chrome")<0?o=!0:n.indexOf("firefox")>-1&&n.indexOf("chrome")<0&&(a=!0);var c={};return o&&(c.modifiers=[s.stripG722]),a&&(c.alwaysAcquireMediaFirst=!0),i.options.ua.uri?i.anonymous=!1:i.anonymous=!0,i.ua=new UA_1.UA({uri:i.options.ua.uri,authorizationUser:i.options.ua.authorizationUser,password:i.options.ua.password,displayName:i.options.ua.displayName,userAgentString:i.options.ua.userAgentString,register:!0,sessionDescriptionHandlerFactoryOptions:c,transportOptions:{traceSip:i.options.ua.traceSip,wsServers:i.options.ua.wsServers}}),i.state=r.STATUS_NULL,i.logger=i.ua.getLogger("sip.simple"),i.ua.on("registered",(function(){i.emit("registered",i.ua)})),i.ua.on("unregistered",(function(){i.emit("unregistered",i.ua)})),i.ua.on("registrationFailed",(function(){i.emit("unregistered",i.ua)})),i.ua.on("invite",(function(e){if(i.state!==r.STATUS_NULL&&i.state!==r.STATUS_COMPLETED)return i.logger.warn("Rejecting incoming call. Simple only supports 1 call at a time"),void e.reject();i.session=e,i.setupSession(),i.emit("ringing",i.session)})),i.ua.on("message",(function(e){i.emit("message",e)})),i}return tslib_es6.__extends(t,e),t.prototype.call=function(e){if(this.ua&&this.checkRegistration()){if(this.state===r.STATUS_NULL||this.state===r.STATUS_COMPLETED)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.autoplay=!0,this.options.media.local.video.volume=0),this.session=this.ua.invite(e,{sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}}),this.setupSession(),this.session;this.logger.warn("Cannot make more than a single call with Simple")}else this.logger.warn("A registered UA is required for calling")},t.prototype.answer=function(){if(this.state===r.STATUS_NEW||this.state===r.STATUS_CONNECTING)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.session.accept({sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}});this.logger.warn("No call to answer")},t.prototype.reject=function(){if(this.state===r.STATUS_NEW||this.state===r.STATUS_CONNECTING)return this.session.reject();this.logger.warn("Call is already answered")},t.prototype.hangup=function(){if(this.state===r.STATUS_CONNECTED||this.state===r.STATUS_CONNECTING||this.state===r.STATUS_NEW)return this.state!==r.STATUS_CONNECTED?this.session.cancel():this.session?this.session.bye():void 0;this.logger.warn("No active call to hang up on")},t.prototype.hold=function(){if(this.state===r.STATUS_CONNECTED&&this.session&&!this.session.localHold)return this.mute(),this.logger.log("Placing session on hold"),this.session.hold();this.logger.warn("Cannot put call on hold")},t.prototype.unhold=function(){if(this.state===r.STATUS_CONNECTED&&this.session&&this.session.localHold)return this.unmute(),this.logger.log("Placing call off hold"),this.session.unhold();this.logger.warn("Cannot unhold a call that is not on hold")},t.prototype.mute=function(){this.state===r.STATUS_CONNECTED?(this.logger.log("Muting Audio"),this.toggleMute(!0),this.emit("mute",this)):this.logger.warn("An acitve call is required to mute audio")},t.prototype.unmute=function(){this.state===r.STATUS_CONNECTED?(this.logger.log("Unmuting Audio"),this.toggleMute(!1),this.emit("unmute",this)):this.logger.warn("An active call is required to unmute audio")},t.prototype.sendDTMF=function(e){this.state===r.STATUS_CONNECTED&&this.session?(this.logger.log("Sending DTMF tone: "+e),this.session.dtmf(e)):this.logger.warn("An active call is required to send a DTMF tone")},t.prototype.message=function(e,t){this.ua&&this.checkRegistration()?e&&t?this.ua.message(e,t):this.logger.warn("A destination and message are required to send a message"):this.logger.warn("A registered UA is required to send a message")},t.prototype.checkRegistration=function(){return this.anonymous||this.ua&&this.ua.isRegistered()},t.prototype.setupRemoteMedia=function(){var e=this;if(this.session){var t,r=this.session.sessionDescriptionHandler.peerConnection;r.getReceivers?(t=new commonjsGlobal.window.MediaStream,r.getReceivers().forEach((function(e){var r=e.track;r&&t.addTrack(r)}))):t=r.getRemoteStreams()[0],this.video?(this.options.media.remote.video.srcObject=t,this.options.media.remote.video.play().catch((function(){e.logger.log("play was rejected")}))):this.audio&&(this.options.media.remote.audio.srcObject=t,this.options.media.remote.audio.play().catch((function(){e.logger.log("play was rejected")})))}else this.logger.warn("No session to set remote media on")},t.prototype.setupLocalMedia=function(){if(this.session){if(this.video&&this.options.media.local&&this.options.media.local.video){var e,t=this.session.sessionDescriptionHandler.peerConnection;t.getSenders?(e=new commonjsGlobal.window.MediaStream,t.getSenders().forEach((function(t){var r=t.track;r&&"video"===r.kind&&e.addTrack(r)}))):e=t.getLocalStreams()[0],this.options.media.local.video.srcObject=e,this.options.media.local.video.volume=0,this.options.media.local.video.play()}}else this.logger.warn("No session to set local media on")},t.prototype.cleanupMedia=function(){this.video&&(this.options.media.remote.video.srcObject=null,this.options.media.remote.video.pause(),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.srcObject=null,this.options.media.local.video.pause())),this.audio&&(this.options.media.remote.audio.srcObject=null,this.options.media.remote.audio.pause())},t.prototype.setupSession=function(){var e=this;this.session?(this.state=r.STATUS_NEW,this.emit("new",this.session),this.session.on("progress",(function(){return e.onProgress()})),this.session.on("accepted",(function(){return e.onAccepted()})),this.session.on("rejected",(function(){return e.onEnded()})),this.session.on("failed",(function(){return e.onFailed()})),this.session.on("terminated",(function(){return e.onEnded()}))):this.logger.warn("No session to set up")},t.prototype.destroyMedia=function(){this.session&&this.session.sessionDescriptionHandler&&this.session.sessionDescriptionHandler.close()},t.prototype.toggleMute=function(e){if(this.session){var t=this.session.sessionDescriptionHandler.peerConnection;t.getSenders?t.getSenders().forEach((function(t){t.track&&(t.track.enabled=!e)})):t.getLocalStreams().forEach((function(t){t.getAudioTracks().forEach((function(t){t.enabled=!e})),t.getVideoTracks().forEach((function(t){t.enabled=!e}))}))}else this.logger.warn("No session to toggle mute")},t.prototype.onAccepted=function(){var e=this;this.session?(this.state=r.STATUS_CONNECTED,this.emit("connected",this.session),this.setupLocalMedia(),this.setupRemoteMedia(),this.session.sessionDescriptionHandler&&(this.session.sessionDescriptionHandler.on("addTrack",(function(){e.logger.log("A track has been added, triggering new remoteMedia setup"),e.setupRemoteMedia()})),this.session.sessionDescriptionHandler.on("addStream",(function(){e.logger.log("A stream has been added, trigger new remoteMedia setup"),e.setupRemoteMedia()}))),this.session.on("dtmf",(function(t,r){e.emit("dtmf",r.tone)})),this.session.on("bye",(function(){return e.onEnded()}))):this.logger.warn("No session for accepting")},t.prototype.onProgress=function(){this.state=r.STATUS_CONNECTING,this.emit("connecting",this.session)},t.prototype.onFailed=function(){this.onEnded()},t.prototype.onEnded=function(){this.state=r.STATUS_COMPLETED,this.emit("ended",this.session),this.cleanupMedia()},t.C=r,t}(EventEmitter.EventEmitter);t.Simple=i}));unwrapExports(Simple_1);var Simple_2=Simple_1.SimpleStatus,Simple_3=Simple_1.Simple,Web=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=tslib_es6.__importStar(Modifiers);t.Modifiers=r,t.Simple=Simple_1.Simple,t.SessionDescriptionHandler=SessionDescriptionHandler_1.SessionDescriptionHandler,t.Transport=Transport_1.Transport}));unwrapExports(Web);var Web_1=Web.Modifiers,Web_2=Web.Simple,Web_3=Web.SessionDescriptionHandler,Web_4=Web.Transport,lib=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DigestAuthentication=core$1.DigestAuthentication,t.Grammar=core$1.Grammar,t.IncomingRequest=core$1.IncomingRequestMessage,t.IncomingResponse=core$1.IncomingResponseMessage,t.LoggerFactory=core$1.LoggerFactory,t.NameAddrHeader=core$1.NameAddrHeader,t.OutgoingRequest=core$1.OutgoingRequestMessage,t.Timers=core$1.Timers,t.Transport=core$1.Transport,t.URI=core$1.URI,t.ClientContext=ClientContext_1.ClientContext,t.C=Constants.C,t.DialogStatus=Enums.DialogStatus,t.SessionStatus=Enums.SessionStatus,t.TypeStrings=Enums.TypeStrings,t.UAStatus=Enums.UAStatus,t.Exceptions=Exceptions_1.Exceptions,t.Parser=Parser_1.Parser,t.PublishContext=PublishContext_1.PublishContext,t.ReferClientContext=ReferContext.ReferClientContext,t.ReferServerContext=ReferContext.ReferServerContext,t.RegisterContext=RegisterContext_1.RegisterContext,t.ServerContext=ServerContext_1.ServerContext,t.InviteClientContext=Session_1.InviteClientContext,t.InviteServerContext=Session_1.InviteServerContext,t.Session=Session_1.Session,t.Subscription=Subscription_1.Subscription;var r={InviteClientTransaction:transactions.InviteClientTransaction,InviteServerTransaction:transactions.InviteServerTransaction,NonInviteClientTransaction:transactions.NonInviteClientTransaction,NonInviteServerTransaction:transactions.NonInviteServerTransaction};t.Transactions=r,t.makeUserAgentCoreConfigurationFromUA=UA_1.makeUserAgentCoreConfigurationFromUA,t.UA=UA_1.UA,t.Utils=Utils_1.Utils;var s=tslib_es6.__importStar(Web);t.Web=s;var i=pkg.title;t.name=i;var n=pkg.version;t.version=n;var o=tslib_es6.__importStar(core$1);t.Core=o}));unwrapExports(lib);var lib_1=lib.DigestAuthentication,lib_2=lib.Grammar,lib_3=lib.IncomingRequest,lib_4=lib.IncomingResponse,lib_5=lib.LoggerFactory,lib_6=lib.NameAddrHeader,lib_7=lib.OutgoingRequest,lib_8=lib.Timers,lib_9=lib.Transport,lib_10=lib.URI,lib_11=lib.ClientContext,lib_12=lib.C,lib_13=lib.DialogStatus,lib_14=lib.SessionStatus,lib_15=lib.TypeStrings,lib_16=lib.UAStatus,lib_17=lib.Exceptions,lib_18=lib.Parser,lib_19=lib.PublishContext,lib_20=lib.ReferClientContext,lib_21=lib.ReferServerContext,lib_22=lib.RegisterContext,lib_23=lib.ServerContext,lib_24=lib.InviteClientContext,lib_25=lib.InviteServerContext,lib_26=lib.Session,lib_27=lib.Subscription,lib_28=lib.Transactions,lib_29=lib.makeUserAgentCoreConfigurationFromUA,lib_30=lib.UA,lib_31=lib.Utils,lib_32=lib.Web,lib_33=lib.name,lib_34=lib.version,lib_35=lib.Core;const AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext;function eqSet(e,t){return e.size===t.size&&[...e].every(t.has.bind(t))}function jitter(e,t){const r=0-Math.ceil(e*(t/100)),s=Math.floor(e*(t/100));return Math.floor(Math.random()*(s-r))+r}function increaseTimeout(e){return 2*e.interval<e.limit?e.interval=2*e.interval:e.interval=e.limit,e.timeout=e.interval+jitter(e.interval,30),e}function clamp(e,t,r){return e<t?t:e>r?r:e}function sessionDescriptionHandlerFactory(e,t){const r=lib_32.SessionDescriptionHandler.defaultFactory(e,t);return e.__streams={localStream:audioContext.createMediaStreamDestination(),remoteStream:new MediaStream},r.WebRTC.getUserMedia=async()=>(await e.__media.setInput(),e.__streams.localStream.stream),r.on("addTrack",(async(t,r)=>{const s=e.sessionDescriptionHandler.peerConnection;log.debug("addTrack"+arguments,"sessionDescriptionHandlerFactory");let i=new MediaStream;s.getReceivers?s.getReceivers().forEach((e=>{const t=e.track;t&&i.addTrack(t)})):i=s.getRemoteStreams()[0],e.__streams.remoteStream=i;try{await e.__media.setOutput()}catch(t){log.error(t,"sessionDescriptionHandlerFactory"),e.__media.emit("mediaFailure")}})),log.debug("Returning patched SDH for session"+e,"sessionDescriptionHandlerFactory"),r}const millisecond=1,second=1e3,minute=6e4,hour=36e5;class WrappedInviteClientContext extends lib_24{rebuildSessionDescriptionHandler(){log.debug("Session Description Handler is rebuild!",this.constructor.name),this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions||{})}refer(e,t={}){if(this.status!==lib_14.STATUS_CONFIRMED)throw new lib_17.InvalidStateError(this.status);return this.referContext=new lib_20(this.ua,this,e,t),this.emit("referRequested",{referContext:this.referContext,options:t}),this.referContext}}class WrappedInviteServerContext extends lib_25{rebuildSessionDescriptionHandler(){log.debug("Session Description Handler is rebuild!",this.constructor.name),this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions||{})}refer(e,t={}){if(this.status!==lib_14.STATUS_CONFIRMED)throw new lib_17.InvalidStateError(this.status);return this.referContext=new lib_20(this.ua,this,e,t),this.emit("referRequested",{referContext:this.referContext,options:t}),this.referContext}}class WrappedTransport extends lib_32.Transport{disconnectPromise(e={}){return pTimeout_1(super.disconnectPromise(),1e3,(()=>{log.debug("Fake-closing the the socket by ourselves.",this.constructor.name),this.onClose({code:"fake",reason:"Artificial timeout"})})).then((()=>({overrideEvent:!0})))}}class UA extends lib_30{constructor(e){super(e),this.configureUADelegate()}disconnect(){return this.stop(),this.disconnectPromise}invite(e,t,r){return new WrappedInviteClientContext(this,e,t,r)}subscribe(e,t,r){return new lib_27(this,e,t,r)}stop(){if(log.debug("user requested closure...",this.constructor.name),this.status===lib_16.STATUS_USER_CLOSED)return log.debug("UA already closed",this.constructor.name),this;for(const e in this.sessions)this.sessions[e]&&(log.debug("closing session "+e,this.constructor.name),this.sessions[e].terminate());for(const e in this.subscriptions)this.subscriptions[e]&&(log.debug("unsubscribe "+e,this.constructor.name),this.subscriptions[e].unsubscribe());for(const e in this.publishers)this.publishers[e]&&(log.debug("unpublish "+e,this.constructor.name),this.publishers[e].close());for(const e in this.applicants)this.applicants[e]&&this.applicants[e].close();return this.status=lib_16.STATUS_USER_CLOSED,this.disconnectPromise=this.transport.disconnect(),this.userAgentCore.reset(),"function"==typeof window.removeEventListener&&(window.chrome&&window.chrome.app&&window.chrome.app.runtime||window.removeEventListener("unload",this.stop)),this}configureUADelegate(){const e=(e,t)=>{if(this.configuration.replaces!==lib_12.supported.UNSUPPORTED){const r=t.parseHeader("replaces");if(r){const s=this.sessions[r.call_id+r.replaces_from_tag]||this.sessions[r.call_id+r.replaces_to_tag]||void 0;if(!s)return void this.userAgentCore.replyStateless(t,{statusCode:481});if(s.status===lib_14.STATUS_TERMINATED)return void this.userAgentCore.replyStateless(t,{statusCode:603});const i=r.call_id+r.replaces_to_tag+r.replaces_from_tag,n=this.userAgentCore.dialogs.get(i);if(!n)return void this.userAgentCore.replyStateless(t,{statusCode:481});if(!n.early&&r.early_only)return void this.userAgentCore.replyStateless(t,{statusCode:486});e.replacee=s}}};this.userAgentCore.delegate.onInvite=t=>{t.trying(),t.delegate={onCancel:e=>{r.onCancel(e)},onTransportError:e=>{r.onTransportError()}};const r=new WrappedInviteServerContext(this,t);e(r,t.message),r.autoSendAnInitialProvisionalResponse&&r.progress(),log.debug("incoming request being delegated",this.constructor.name),this.emit("invite",r)}}}const SIP_PRESENCE_EXPIRE=3600,logLevelConversion={[lib_35.Levels.debug]:"debug",[lib_35.Levels.log]:"info",[lib_35.Levels.warn]:"warn",[lib_35.Levels.error]:"error"},connector=(e,t,r,s)=>{const i=logLevelConversion[e]||"debug";log.log(i,s,t)};class ReconnectableTransport extends EventEmitter{constructor(e){super(),this.registered=!1,this.status=ClientStatus.DISCONNECTED,this.priority=!1,this.dyingCounter=6e4,this.retry={interval:2e3,limit:3e4,timeout:250},this.wasWindowOffline=!1,this.configure(e),this.boundOnWindowOffline=this.onWindowOffline.bind(this),this.boundOnWindowOnline=this.tryUntilConnected.bind(this),window.addEventListener("offline",this.boundOnWindowOffline),window.addEventListener("online",this.boundOnWindowOnline)}get defaultOptions(){return{autostart:!1,autostop:!1,log:{builtinEnabled:!0,connector:void 0,level:"warn"},noAnswerTimeout:60,register:!1,registerOptions:{expires:3600}}}configure(e){const{account:t,transport:r,userAgent:s}=e,i=[lib_32.Modifiers.stripVideo];isSafari&&i.push(lib_32.Modifiers.stripG722),this.uaOptions={...this.defaultOptions,authorizationUser:t.user,log:{builtinEnabled:!1,connector:connector,level:"debug"},password:t.password,sessionDescriptionHandlerFactory:sessionDescriptionHandlerFactory,sessionDescriptionHandlerFactoryOptions:{alwaysAcquireMediaFirst:isFirefox,constraints:{audio:!0,video:!1},modifiers:i,peerConnectionOptions:{rtcConfiguration:{iceServers:r.iceServers.map((e=>({urls:e})))}}},transportConstructor:WrappedTransport,transportOptions:{maxReconnectionAttempts:0,traceSip:!0,wsServers:r.wsServers},uri:t.uri,userAgentString:s||"vialer-calling-lib"}}async connect(){return this.status===ClientStatus.RECOVERING?Promise.reject(new Error("Can not connect while trying to recover. (this is to avoid spamming the sip server)")):this.status===ClientStatus.CONNECTED?(log.info("Already registered.",this.constructor.name),this.registeredPromise):(this.updateStatus(ClientStatus.CONNECTING),this.ua||(log.debug("Configuring UA.",this.constructor.name),this.configureUA()),this.unregisteredPromise&&(log.info("Cannot connect while unregistering takes place. Waiting until unregistering is resolved.",this.constructor.name),await this.unregisteredPromise),this.registeredPromise||(this.registeredPromise=this.createRegisteredPromise(),this.ua.start(),await pTimeout_1(this.transportConnectedPromise,1e4,(()=>Promise.reject(new Error("Could not connect the websocket in time.")))),this.ua.register()),this.registeredPromise)}async disconnect({hasSocket:e=!0,hasRegistered:t=!0}={}){this.ua?(e&&this.updateStatus(ClientStatus.DISCONNECTING),delete this.registeredPromise,e&&t&&(this.unregisteredPromise=new Promise((e=>this.ua.once("unregistered",(()=>{this.registered=!1,e(!0)})))),log.debug("Trying to unregister.",this.constructor.name),this.ua.unregister(),await this.unregisteredPromise,log.debug("Unregistered.",this.constructor.name)),await this.ua.disconnect(),e&&this.updateStatus(ClientStatus.DISCONNECTED),log.debug("Disconnected.",this.constructor.name),this.ua.transport.removeAllListeners(),this.ua.removeAllListeners(),delete this.ua,delete this.unregisteredPromise):log.info("Already disconnected.",this.constructor.name)}invite(e){if(this.status!==ClientStatus.CONNECTED)throw log.info("Could not send an invite. Not connected.",this.constructor.name),new Error("Cannot send an invite. Not connected.");return this.ua.invite(e)}subscribe(e){return this.ua.subscribe(e,"dialog",{expires:3600+jitter(3600,30)})}isRegistered(){return this.registeredPromise}async getConnection(e=ReconnectionMode.ONCE){if(!this.ua)return!1;if(ClientStatus.DISCONNECTED===this.status)return!1;const t=await this.isOnline(e);return log.debug(`isOnline: ${t}`,this.constructor.name),t&&(await this.ua.transport.disconnect(),log.debug("Socket closed",this.constructor.name),await this.ua.transport.connect(),log.debug("Socket opened",this.constructor.name),0!==this.dyingCounter&&this.emit("reviveSessions"),this.emit("reviveSubscriptions"),this.registeredPromise=this.createRegisteredPromise(),this.ua.register(),await this.registeredPromise,log.debug("Reregistered!",this.constructor.name),this.updateStatus(ClientStatus.CONNECTED),this.retry.timeout=250),t}updatePriority(e){this.priority=e,log.debug(`Priority is ${e}`,this.constructor.name)}close(){window.removeEventListener("online",this.boundOnWindowOnline),window.removeEventListener("offline",this.boundOnWindowOffline)}updateStatus(e){this.status!==e&&(this.status=e,this.emit("statusUpdate",e))}isOnlinePromise(e){return new Promise(((t,r)=>{const s=new WebSocket(this.uaOptions.transportOptions.wsServers,"sip"),i={onError:r=>{if(log.debug(r,this.constructor.name),s.removeEventListener("open",i.onOpen),e===ReconnectionMode.BURST)throw new Error("it broke woops");t(!1)},onOpen:()=>{log.debug("Opening a socket to sip server worked.",this.constructor.name),s.close(),s.removeEventListener("error",i.onError),t(!0)}};s.addEventListener("open",i.onOpen),s.addEventListener("error",i.onError)}))}configureUA(){this.ua=new UA(this.uaOptions),this.ua.on("invite",(e=>this.emit("invite",e))),this.transportConnectedPromise=new Promise((e=>{this.ua.once("transportCreated",(()=>{log.debug("Transport created.",this.constructor.name),this.ua.transport.once("connected",(()=>{log.debug("Transport connected.",this.constructor.name),e()})),this.ua.transport.on("disconnected",this.onTransportDisconnected.bind(this))}))}))}isOnline(e){if(!(this.uaOptions&&this.uaOptions.transportOptions&&this.uaOptions.transportOptions.wsServers))return Promise.resolve(!1);const t=()=>pTimeout_1(this.isOnlinePromise(e),500,(()=>{if(e===ReconnectionMode.BURST)throw new Error("Cannot open socket. Probably DNS failure.");return Promise.resolve(!1)}));if(e===ReconnectionMode.ONCE)return log.debug("Trying to reconnect once.",this.constructor.name),t();log.debug("Trying to reconnect asap.",this.constructor.name);const r=pRetry_1((()=>{if(this.status===ClientStatus.DISCONNECTED)throw new pRetry_1.AbortError("It's no use. Stop trying to recover");return t()}),{forever:!0,maxTimeout:100,minTimeout:100,onFailedAttempt:e=>{log.debug(`Connection attempt ${e.attemptNumber} failed. There are ${e.retriesLeft} retries left.`,this.constructor.name)}});return pTimeout_1(r,this.dyingCounter,(()=>(log.info("We could not recover the session(s) within 1 minute. After this time the SIP server has terminated the session(s).",this.constructor.name),Promise.resolve(!1))))}async tryUntilConnected({skipCheck:e}={skipCheck:!1}){if(ClientStatus.RECOVERING!==this.status||e)if(this.updateStatus(ClientStatus.RECOVERING),this.priority){const e=await this.getConnection(ReconnectionMode.BURST);this.onAfterGetConnection(e)}else setTimeout((async()=>{if(this.status!==ClientStatus.CONNECTED){const e=await this.getConnection(ReconnectionMode.ONCE);this.onAfterGetConnection(e)}}),this.retry.timeout),this.retry=increaseTimeout(this.retry),log.debug("Delaying reconnecting to avoid thundering herd.",this.constructor.name)}createRegisteredPromise(){return new Promise(((e,t)=>{const r={onRegistered:()=>{this.ua.removeListener("registrationFailed",r.onRegistrationFailed),this.updateStatus(ClientStatus.CONNECTED),e(!0)},onRegistrationFailed:async e=>{this.ua.removeListener("registered",r.onRegistered),await this.disconnect({hasRegistered:!1}),this.updateStatus(ClientStatus.DISCONNECTED),t(e)}};this.ua.once("registered",r.onRegistered),this.ua.once("registrationFailed",r.onRegistrationFailed)}))}onWindowOffline(){if(log.info("We appear to be offline.",this.constructor.name),this.wasWindowOffline=!0,this.updateStatus(ClientStatus.DYING),this.registeredPromise=void 0,this.dyingIntervalID)return;this.dyingIntervalID=window.setInterval((()=>{this.dyingCounter-=500,0===this.dyingCounter&&(clearInterval(this.dyingIntervalID),this.dyingIntervalID=void 0,log.debug("Priority set to false. Our call was probably terminated by the SIP server.",this.constructor.name),this.priority=!1)}),500)}onTransportDisconnected(){log.debug("Transport disconnected..",this.constructor.name),this.wasWindowOffline||(log.debug("Transport disconnected while there is internet, trying to reconnect",this.constructor.name),this.tryUntilConnected()),this.wasWindowOffline=!1}async onAfterGetConnection(e){if(e)return clearInterval(this.dyingIntervalID),this.dyingIntervalID=void 0,this.dyingCounter=6e4,void log.info("We appear to be connected.",this.constructor.name);this.tryUntilConnected({skipCheck:!0})}}function checkAudioConnected(e,{checkInterval:t,noAudioTimeout:r}){let s;return new Promise(((i,n)=>{e.once("SessionDescriptionHandler-created",(()=>{const o=e.sessionDescriptionHandler.peerConnection;if(webrtc.connectionstatechange)o.addEventListener("connectionstatechange",(()=>{switch(o.connectionState){case"connected":i();break;case"failed":n()}}));else{let a=r;const c=()=>{o.getStats().then((e=>{const r=Array.from(e.values()).find((e=>"outbound-rtp"===e.type));r&&r.packetsSent>0?i():(a-=t,a<=0?n():s=window.setTimeout(c,t))}))};s=window.setTimeout(c,t),e.once("terminated",(()=>{s&&window.clearTimeout(s)}))}}))}))}const UPDATE_INTERVAL=1e3;class MediaSingleton extends EventEmitter{constructor(){super(...arguments),this.allDevices=[],this.timer=void 0,this.hadPermission=!1}init(){this.update()}get devices(){return this.allDevices}get inputs(){return this.allDevices.filter((e=>"audioinput"===e.kind))}get outputs(){return this.allDevices.filter((e=>"audiooutput"===e.kind))}async checkPermission(){const e=await navigator.mediaDevices.enumerateDevices();return!(!e.length||!e[0].label)}requestPermission(){return this.requestPermissionPromise||(this.requestPermissionPromise=new Promise((async(e,t)=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});this.hadPermission||(this.timer&&window.clearTimeout(this.timer),await this.update()),this.closeStream(t),e()}catch(e){t(e)}finally{delete this.requestPermissionPromise}}))),this.requestPermissionPromise}openInputStream(e){log.debug(`Requesting input stream with: audioProcessing=${e.audioProcessing}`,"media");const t=getInputConstraints(e),r=navigator.mediaDevices.getUserMedia(t);return r.then((e=>{e.getTracks().forEach((e=>{log.debug(`Media stream track has settings: ${JSON.stringify(e.getSettings())}`,"media")}))})),r}closeStream(e){e.getTracks().forEach((e=>e.stop()))}async enumerateDevices(){const e=await navigator.mediaDevices.enumerateDevices();if(e.length&&e[0].label)return e}async update(){const e=await this.enumerateDevices(),t=void 0!==e;t?(this.hadPermission||this.emit("permissionGranted"),this.updateDevices(e)):this.hadPermission&&(this.emit("permissionRevoked"),this.allDevices=[],this.emit("devicesChanged")),this.hadPermission=t,isFirefox&&isLocalhost||(this.timer=window.setTimeout((()=>this.update()),1e3))}updateDevices(e){const t=e.map((e=>{if(e.label)return"audioinput"===e.kind?{id:e.deviceId,name:e.label,kind:"audioinput"}:"audiooutput"===e.kind?{id:e.deviceId,name:e.label,kind:"audiooutput"}:void 0})).filter((e=>void 0!==e));eqSet(new Set(t.map((e=>e.id))),new Set(this.allDevices.map((e=>e.id))))||(this.allDevices=t,this.emit("devicesChanged"))}}const Media=new MediaSingleton;function getInputConstraints(e){const t={audio:e.audioProcessing?{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,googAudioMirroring:!0,googAutoGainControl:!0,googAutoGainControl2:!0,googEchoCancellation:!0,googHighpassFilter:!0,googNoiseSuppression:!0,googTypingNoiseDetection:!0}:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,googAudioMirroring:!1,googAutoGainControl:!1,googAutoGainControl2:!1,googEchoCancellation:!1,googHighpassFilter:!1,googNoiseSuppression:!1,googTypingNoiseDetection:!1},video:!1};return e.id&&(t.audio.deviceId=e.id),log.debug(`Using input constraints: ${JSON.stringify(t)}`,"media"),t}class SessionMedia extends EventEmitter{constructor(e,t){super(),this.session=e,e.__media=this,this.media={input:Object.assign({},t.input),output:Object.assign({},t.output)},e.on("terminated",(()=>{this.stopInput(),this.stopOutput()}));const r=this;this.input={get id(){return r.media.input.id},set id(e){r.setInputDevice(e)},get audioProcessing(){return r.media.input.audioProcessing},set audioProcessing(e){r.setInputAudioProcessing(e)},get volume(){return r.media.input.volume},set volume(e){r.setInputVolume(e)},get muted(){return r.media.input.muted},set muted(e){r.setInputMuted(e)}},this.output={get id(){return r.media.output.id},set id(e){r.setOutputDevice(e)},get volume(){return r.media.output.volume},set volume(e){r.setOutputVolume(e)},get muted(){return r.media.output.muted},set muted(e){r.setOutputMuted(e)}}}async setInput(e){void 0===e&&(e=this.media.input);const t=await Media.openInputStream(e);this.stopInput(),this.inputStream=t;const r=audioContext.createMediaStreamSource(t),s=audioContext.createGain();s.gain.value=e.volume,r.connect(s),!e.muted&&this.session.__streams&&s.connect(this.session.__streams.localStream),this.inputNode=s,this.media.input=e}async setOutput(e){void 0===e&&(e=this.media.output);const t=new Audio;t.volume=clamp(e.volume,0,1),t.muted=e.muted,await audioContext.resume(),e.id&&(webaudio.setSinkId?await t.setSinkId(e.id):log.warn("cannot set output device: setSinkId is not supported","session-media")),this.stopOutput(),this.audioOutput=t,this.media.output=e,t.srcObject=this.session.__streams.remoteStream,await t.play()}setInputDevice(e){this.setInput(Object.assign({},this.media.input,{id:e}))}setInputAudioProcessing(e){log.debug(`setting audioProcessing to: ${e}`,"media"),this.setInput(Object.assign({},this.media.input,{audioProcessing:e}))}setInputVolume(e){this.inputNode&&(this.inputNode.gain.value=e),this.media.input.volume=e}setInputMuted(e){this.inputNode&&(e?this.inputNode.disconnect():this.inputNode.connect(this.session.__streams.localStream)),this.media.input.muted=e}setOutputDevice(e){this.setOutput(Object.assign({},this.media.output,{id:e}))}setOutputVolume(e){this.audioOutput&&(this.audioOutput.volume=e),this.media.output.volume=e}setOutputMuted(e){this.audioOutput&&(this.audioOutput.muted=e),this.media.output.muted=e}stopInput(){this.inputStream&&this.inputNode&&(Media.closeStream(this.inputStream),this.inputNode.disconnect())}stopOutput(){this.audioOutput&&(this.audioOutput.pause(),this.audioOutput.srcObject=void 0)}}class StatsAggregation{constructor(){this.stats={count:0,highest:void 0,last:void 0,lowest:void 0,sum:0}}add(e){0===this.stats.count?(this.stats.lowest=e,this.stats.highest=e):(this.stats.lowest=Math.min(this.stats.lowest,e),this.stats.highest=Math.max(this.stats.highest,e)),this.stats.count+=1,this.stats.sum+=e,this.stats.last=e}get last(){return this.stats.last}get count(){return this.stats.count}get sum(){return this.stats.sum}get lowest(){return this.stats.lowest}get highest(){return this.stats.highest}get average(){if(0!==this.count)return this.sum/this.count}}class SessionStats extends EventEmitter{constructor(e,{statsInterval:t}){super(),this.mos=new StatsAggregation,this.statsInterval=t,e.once("SessionDescriptionHandler-created",(()=>{this.statsTimer=window.setInterval((()=>{e.sessionDescriptionHandler.peerConnection.getStats().then((e=>{this.add(e)?this.emit("statsUpdated",this):log.debug("No useful stats"+e,this.constructor.name)}))}),this.statsInterval)})),e.once("terminated",(()=>{this.statsTimer&&(window.clearInterval(this.statsTimer),delete this.statsTimer)}))}add(e){let t,r;for(const s of e.values())"inbound-rtp"===s.type?t=s:"candidate-pair"===s.type&&s.nominated&&(r=s);if(t&&r){const e={jitter:t.jitter,fractionLost:t.fractionLost||t.packetsLost/t.packetsReceived,rtt:r.currentRoundTripTime||.05};return this.mos.add(calculateMOS(e)),!0}return!1}}function calculateMOS({rtt:e,jitter:t,fractionLost:r}){const s=1e3*(e+2*t)+10;let i;i=s<160?93.2-s/40:93.2-(s-120)/10,i=Math.max(i-250*r,0);return 1+.035*i+7e-6*i*(i-60)*(100-i)}var SessionCause;!function(e){e.BUSY="busy",e.REJECTED="rejected",e.UNAVAILABLE="unavailable",e.CANCELLED="cancelled",e.CALL_COMPLETED_ELSEWHERE="call_completed_elsewhere",e.NOT_FOUND="not_found",e.REDIRECTED="redirected",e.NO_ANSWER="no_answer",e.REQUEST_TERMINATED="request_terminated",e.TEMPORARILY_UNAVAILABLE="temporarily_unavailable"}(SessionCause||(SessionCause={}));const CAUSE_MAPPING={[lib_12.causes.BUSY]:SessionCause.BUSY,[lib_12.causes.REJECTED]:SessionCause.REJECTED,[lib_12.causes.UNAVAILABLE]:SessionCause.UNAVAILABLE,[lib_12.causes.NOT_FOUND]:SessionCause.NOT_FOUND,[lib_12.causes.REDIRECTED]:SessionCause.REDIRECTED,[lib_12.causes.CANCELED]:SessionCause.CANCELLED,[lib_12.causes.NO_ANSWER]:SessionCause.NO_ANSWER,"Temporarily Unavailable":SessionCause.TEMPORARILY_UNAVAILABLE},CAUSE_ERRORS=[lib_12.causes.CONNECTION_ERROR,lib_12.causes.INTERNAL_ERROR,lib_12.causes.REQUEST_TIMEOUT,lib_12.causes.AUTHENTICATION_ERROR,lib_12.causes.ADDRESS_INCOMPLETE,lib_12.causes.DIALOG_ERROR,lib_12.causes.INCOMPATIBLE_SDP,lib_12.causes.BAD_MEDIA_DESCRIPTION,lib_12.causes.EXPIRES,lib_12.causes.NO_ACK,lib_12.causes.NO_PRACK,lib_12.causes.RTP_TIMEOUT,lib_12.causes.USER_DENIED_MEDIA_ACCESS,lib_12.causes.WEBRTC_ERROR,lib_12.causes.WEBRTC_NOT_SUPPORTED,lib_12.causes.SIP_FAILURE_CODE];class Session extends EventEmitter{constructor({session:e,media:t,onTerminated:r,isIncoming:s}){super(),this.status=SessionStatus.RINGING,this.session=e,this.id=e.request.callId,this.media=new SessionMedia(this.session,t),this.media.on("mediaFailure",(()=>{this.session.terminate()})),this.onTerminated=r,this.isIncoming=s,this.acceptedPromise=new Promise(((e,t)=>{const r={onAccepted:()=>{this.session.removeListener("rejected",r.onRejected),this.status=SessionStatus.ACTIVE,this.emit("statusUpdate",this),e({accepted:!0})},onRejected:(s,i)=>{this.session.removeListener("accepted",r.onAccepted);try{e({accepted:!1,rejectCause:this.findCause(s,i)})}catch(e){console.log(s),log.error(`Session failed: ${e}`,this.constructor.name),t(e)}}};this.session.once("accepted",r.onAccepted),this.session.once("rejected",r.onRejected)})),this.terminatedPromise=new Promise(((e,t)=>{this.session.once("terminated",((r,s)=>{this.onTerminated(this.id),this.emit("terminated",this),this.status=SessionStatus.TERMINATED,this.emit("statusUpdate",this),"BYE"===s&&"58"===r.getHeader("X-Asterisk-Hangupcausecode")?t(new Error("MisconfiguredAccount")):e()}))})),this._remoteIdentity=this.getRemoteIdentity(this.session.request),this.session.on("reinvite",((e,t)=>{this._remoteIdentity=this.getRemoteIdentity(t),this.emit("remoteIdentityUpdate",this,this._remoteIdentity)})),this.saidBye=!1,this.session.once("bye",(()=>{this.saidBye=!0})),this.holdState=!1,this.stats=new SessionStats(this.session,{statsInterval:5e3}),this.stats.on("statsUpdated",(()=>{this.emit("callQualityUpdate",this.stats)})),this.audioConnected=checkAudioConnected(this.session,{checkInterval:500,noAudioTimeout:1e4})}get remoteIdentity(){return this._remoteIdentity}get autoAnswer(){const e=this.session.request.headers["Call-Info"];return!(!e||!e[0])&&e[0].raw.includes("answer-after=0")}get phoneNumber(){return this.isIncoming?this.remoteIdentity.phoneNumber:this.session.request.to.uri.user}get startTime(){return this.session.startTime}get endTime(){return this.session.endTime}accept(e={}){if(this.rejectPromise)throw new Error("invalid operation: session is rejected");return this.acceptPromise||(this.acceptPromise=new Promise(((t,r)=>{const s={onAnswered:()=>{this.session.removeListener("failed",s.onFail),t()},onFail:(e,t)=>{this.session.removeListener("accepted",s.onAnswered);try{r(this.findCause(e,t))}catch(e){log.error(`Accepting session failed: ${e}`,this.constructor.name),r(e)}}};this.session.once("accepted",s.onAnswered),this.session.once("failed",s.onFail),this.session.accept(e)}))),this.acceptPromise}reject(e={}){if(this.acceptPromise)throw new Error("invalid operation: session is accepted");return this.rejectPromise||(this.rejectPromise=new Promise((t=>{this.session.once("rejected",(()=>t())),this.session.reject(e)}))),this.rejectPromise}accepted(){return this.acceptedPromise}terminated(){return this.terminatedPromise}terminate(e={}){return this.session.terminate(e),this.terminatedPromise}async reinvite(){const e=this.getReinvitePromise();this.session.reinvite(),await e}hold(){return this.setHoldState(!0)}unhold(){return this.setHoldState(!1)}async blindTransfer(e){return this.transfer(e)}async attendedTransfer(e){return this.transfer(e.session)}rebuildSessionDescriptionHandler(){this.session.rebuildSessionDescriptionHandler()}bye(){this.session.bye()}dtmf(e){this.session.dtmf(e)}getReinvitePromise(){return new Promise(((e,t)=>{const r={onReinviteAccepted:()=>{this.session.removeListener("reinviteFailed",r.onReinviteFailed),e(!0)},onReinviteFailed:e=>{this.session.removeListener("reinviteAccepted",r.onReinviteAccepted),t(e)}};this.session.once("reinviteAccepted",r.onReinviteAccepted),this.session.once("reinviteFailed",r.onReinviteFailed)}))}setHoldState(e){return this.holdState===e||(this.reinvitePromise=this.getReinvitePromise(),e?(log.debug("Hold requested",this.constructor.name),this.session.hold()):(log.debug("Unhold requested",this.constructor.name),this.session.unhold()),this.holdState=e,this.status=e?SessionStatus.ON_HOLD:SessionStatus.ACTIVE,this.emit("statusUpdate",this)),this.reinvitePromise}async transfer(e){return pTimeout_1(this.isTransferredPromise(e),2e4,(()=>(log.error("Could not transfer the call",this.constructor.name),Promise.resolve(!1))))}async isTransferredPromise(e){const{referContext:t,options:r}=await new Promise(((t,r)=>{this.session.once("referRequested",(e=>{log.debug("Refer is requested",this.constructor.name),t(e)}));try{this.session.refer(e)}catch(e){throw log.error(e,this.constructor.name),e.type===lib_15.InvalidStateError&&r(),e}}));return new Promise((e=>{const s={onReferAccepted:()=>{log.debug("Refer is accepted",this.constructor.name),t.removeListener("referRejected",s.onReferRejected),e(!0)},onReferRejected:()=>{log.debug("Refer is rejected",this.constructor.name),t.removeListener("referAccepted",s.onReferAccepted),e(!1)}};t.once("referAccepted",s.onReferAccepted),t.once("referRejected",s.onReferRejected),t.refer(r)}))}findCause(e,t){if(t===lib_12.causes.CANCELED){const t=parseReason(e.getHeader("Reason"));if(t&&"Call completed elsewhere"===t.get("text"))return SessionCause.CALL_COMPLETED_ELSEWHERE}else if(t===lib_12.causes.SIP_FAILURE_CODE){if(487===e.statusCode)return SessionCause.REQUEST_TERMINATED;log.warn(`Unknown error: ${e.statusCode} (${e.reasonPhrase})`,this.constructor.name)}if(CAUSE_ERRORS.includes(t))throw new Error(`Session error: ${t}`);const r=CAUSE_MAPPING[t];if(r)return r;log.warn(`Unknown cause: ${t}`,this.constructor.name)}getRemoteIdentity(e){let t;["P-Asserted-Identity","Remote-Party-Id","From"].some((r=>{if(e.hasHeader(r))return t=lib_2.nameAddrHeaderParse(e.getHeader(r)),!0}));let r,s=this.session.remoteIdentity.uri.user;return t&&(s=t.uri.normal.user,r=t.displayName),{phoneNumber:s,displayName:r}}}function parseReason(e){return e?new Map(e.replace(/"/g,"").split(";").map((e=>e.split("=")))):void 0}function statusFromDialog(e){const t=new DOMParser,r=t?t.parseFromString(e.request.body,"text/xml"):null,s=r?r.getElementsByTagName("dialog-info")[0]:null;if(!s)return null;const i=s.getElementsByTagName("state")[0];let n=SubscriptionStatus.AVAILABLE;if(i)switch(i.textContent){case SubscriptionStatus.TRYING:case SubscriptionStatus.PROCEEDING:case SubscriptionStatus.EARLY:n=SubscriptionStatus.RINGING;break;case SubscriptionStatus.CONFIRMED:n=SubscriptionStatus.BUSY;break;case SubscriptionStatus.TERMINATED:n=SubscriptionStatus.AVAILABLE}return n}class Client extends EventEmitter{constructor(e){if(super(),this.sessions={},this.subscriptions={},this.connected=!1,!checkRequired())throw new Error("Your browser is not supported by this library");this.defaultMedia=e.media,this.configureTransport(e)}async reconfigure(e){await this.disconnect(),this.defaultMedia=e.media,this.transport.configure(e),await this.connect()}async connect(){await this.transport.connect()}async disconnect(){await this.transport.disconnect(),this.subscriptions={}}isConnected(){return this.connected}async invite(e){if(!this.transport.registeredPromise)throw new Error("Register first!");let t;await this.transport.registeredPromise;try{t=await this.tryInvite(e).catch((async()=>{if(log.error("The WebSocket broke during the act of inviting.",this.constructor.name),await this.transport.getConnection(ReconnectionMode.ONCE),this.transport.status!==ClientStatus.CONNECTED)throw new Error("Not sending out invite. It appears we are not connected.");return log.debug("New WebSocket is created.",this.constructor.name),await this.tryInvite(e)}))}catch(e){return void log.error(e,this.constructor.name)}return this.addSession(t),t}async close(){await this.disconnect(),this.transport.close(),this.transport.removeAllListeners(),delete this.transport}subscribe(e){return new Promise(((t,r)=>{if(this.subscriptions[e])return log.info("Already subscribed",this.constructor.name),void t();this.subscriptions[e]=this.transport.subscribe(e);const s={onFailed:(s,i)=>{if(!s)return this.removeSubscription({uri:e}),void r();const n=s.getHeader("Retry-After");if(!n)return this.removeSubscription({uri:e}),void r();log.info(`Subscription rate-limited. Retrying after ${n} seconds.`,this.constructor.name),setTimeout((()=>{this.removeSubscription({uri:e}),this.subscribe(e).then(t).catch(r)}),1e3*Number(n))},onFirstNotify:()=>{this.subscriptions[e].removeListener("failed",s.onFailed),t()},onNotify:t=>this.emit("notify",e,statusFromDialog(t))};this.subscriptions[e].on("failed",s.onFailed),this.subscriptions[e].on("notify",s.onNotify),this.subscriptions[e].once("notify",s.onFirstNotify),this.subscriptions[e].subscribe()}))}async resubscribe(e){if(!this.subscriptions[e])throw new Error("Cannot resubscribe to nonexistant subscription.");this.removeSubscription({uri:e}),await this.subscribe(e),log.debug(`Resubscribed to ${e}`,this.constructor.name)}unsubscribe(e){this.subscriptions[e]&&this.removeSubscription({uri:e,unsubscribe:!0})}configureTransport(e){this.transport=new ReconnectableTransport(e),this.transport.on("reviveSessions",(()=>{Object.values(this.sessions).forEach((async e=>{e.rebuildSessionDescriptionHandler(),await e.reinvite()}))})),this.transport.on("reviveSubscriptions",(()=>{Object.keys(this.subscriptions).forEach((async e=>{await this.resubscribe(e)}))})),this.transport.on("invite",(e=>{const t=new Session({media:this.defaultMedia,session:e,onTerminated:this.onSessionTerminated.bind(this),isIncoming:!0});this.addSession(t),this.emit("invite",t)})),this.transport.on("statusUpdate",(e=>{log.debug(`Status change to: ${e}`,this.constructor.name),"connected"===e&&(this.connected=!0),"disconnected"===e&&(this.connected=!1),this.emit("statusUpdate",e)}))}onSessionTerminated(e){if(!e)return;const t=this.sessions[e];log.info(`Incoming session ${e} is terminated.`,this.constructor.name),this.removeSession(t)}async tryInvite(e){return new Promise(((t,r)=>{const s=this.transport.invite(e),i=new Session({media:this.defaultMedia,session:s,onTerminated:this.onSessionTerminated.bind(this),isIncoming:!1}),n={onFailed:()=>{log.error("Session emitted failed after an invite.",this.constructor.name),s.removeListener("progress",n.onProgress),r(new Error("Could not send an invite. Socket could be broken."))},onProgress:()=>{log.debug("Session emitted progress after an invite.",this.constructor.name),s.removeListener("failed",n.onFailed),t(i)}};s.once("failed",n.onFailed),s.once("progress",n.onProgress),s.invite()}))}removeSubscription({uri:e,unsubscribe:t=!1}){this.subscriptions[e].removeAllListeners(),t?this.subscriptions[e].unsubscribe():this.subscriptions[e].dispose(),delete this.subscriptions[e]}addSession(e){this.sessions[e.id]=e,this.emit("sessionsUpdated",this.sessions),this.updatePriority()}removeSession(e){e&&(delete this.sessions[e.id],this.emit("sessionsUpdated",this.sessions),this.updatePriority())}updatePriority(){this.transport&&this.transport.updatePriority(0!==Object.entries(this.sessions).length)}}class Sound{constructor(e,t={}){this.samples=[],this.uri=e,this.options={volume:void 0===t.volume?1:t.volume,overlap:void 0!==t.overlap&&t.overlap,sinkId:t.sinkId}}get playing(){return this.samples.length>0}get volume(){return this.options.volume}set volume(e){this.options.volume=e,this.samples.forEach((t=>{t.volume=e}))}get sinkId(){return this.options.sinkId}set sinkId(e){this.options.sinkId=e,webaudio.setSinkId?this.samples.forEach((t=>{t.setSinkId(e)})):log.warn("cannot set output device: setSinkId is not supported","sound")}async play({loop:e,timeout:t}={loop:!1,timeout:void 0}){if(this.options.overlap&&e)throw new Error("loop and overlap cannot be combined");if(!this.options.overlap&&this.playing)return;const r=new Audio;r.volume=clamp(this.options.volume,0,1),r.loop=e,this.samples.push(r);const s=()=>{this.stopTimer&&(window.clearTimeout(this.stopTimer),delete this.stopTimer),this.samples=this.samples.filter((e=>e!==r))},i=new Promise(((e,i)=>{r.addEventListener("error",(e=>{s(),i(e)})),r.addEventListener("loadeddata",(async()=>{try{if(await audioContext.resume(),this.options.sinkId&&(webaudio.setSinkId?await r.setSinkId(this.options.sinkId):log.warn("cannot set output device: setSinkId is not supported","sound")),!this.samples.includes(r))return void e();t&&(this.stopTimer=window.setTimeout((()=>this.stop()),t)),await r.play()}catch(e){s(),i(e)}})),r.addEventListener("pause",(()=>{s(),e()})),r.addEventListener("ended",(()=>{s(),e()}))}));return r.src=this.uri,await i}stop(){this.samples.forEach((e=>{e.currentTime=0,e.pause()})),this.samples=[],this.stopTimer=void 0}}export{Autoplay,Client,features as Features,Media,Sound,log};
